<!doctype html><html><head><title>Chroma Style Gallery</title><style>body { font-family: sans-serif; margin: 4em; } h1 { border-bottom: 3px solid red; margin-bottom: 2em; } pre { display: inline-block; margin: 2em; padding: 3em 5em 3em 2em; box-shadow: 5px 5px 5px rgba(68, 68, 68, 0.6); border-radius: 7px; border: 2px solid black;} #stylelink:link { text-decoration: none; color: black; } #stylelink:visited { color: black; } #stylelink:hover { color: #4682B4; } a { color: #1E385B; }</style></head><body><h1>Chroma Style Gallery</h1><a name='abap'><h2><a id='stylelink' href='abap.html' alt='View only abap'>abap</a></h2></a><code><pre style="background-color: #ffffff;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #000000">version_string</span> <span class="o">=</span> <span style="color: #55aa22">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #000000">IOPRIO_WHO_PROCESS</span> <span class="o">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #000000">IOPRIO_CLASS_SHIFT</span> <span class="o">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #000000">EX_EXEC_FAILED</span> <span class="o">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #000000">EX_EXEC_ENOENT</span> <span class="o">=</span> 127<span class="p">;</span> // Could not find program to <span style="color: #000000">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span class="o">[]</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_NONE<span class="o">]</span> <span class="o">=</span> <span style="color: #55aa22">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_RT<span class="o">]</span> <span class="o">=</span> <span style="color: #55aa22">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_BE<span class="o">]</span> <span class="o">=</span> <span style="color: #55aa22">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_IDLE<span class="o">]</span> <span class="o">=</span> <span style="color: #55aa22">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span class="o">(</span>FILE* stream<span class="o">)</span>
</span></span><span style="display: flex;"><span class="cl"><span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #000000">errno</span> <span class="o">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #0000ff">if</span> <span class="o">(</span>ferror<span class="o">(</span>stream<span class="o">)</span> !<span class="o">=</span> <span style="color: #33aaff">0</span> <span class="o">||</span> fflush<span class="o">(</span>stream<span class="o">)</span> !<span class="o">=</span> 0<span class="o">)</span> <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #0000ff">return</span> <span class="o">(</span><span style="color: #000000">errno</span> <span class="o">==</span> EBADF<span class="o">)</span> ? <span style="color: #33aaff">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="o">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #0000ff">until</span> close. Calling fsync would <span style="color: #000000">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #55aa22">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    if (str == NULL || *str == &#39;</span><span style="color: #55aa22">\0</span><span style="color: #55aa22">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #55aa22">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #55aa22">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #55aa22">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #55aa22">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #55aa22">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #55aa22">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #55aa22">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #55aa22">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #55aa22">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #55aa22">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #55aa22">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #55aa22">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #55aa22">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        case &#39;</span>n<span style="color: #55aa22">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        case &#39;</span>c<span style="color: #55aa22">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #55aa22">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        case &#39;</span>p<span style="color: #55aa22">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        case &#39;</span>P<span style="color: #55aa22">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        case &#39;</span>u<span style="color: #55aa22">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        case &#39;</span>t<span style="color: #55aa22">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        case &#39;</span>V<span style="color: #55aa22">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        case &#39;</span>h<span style="color: #55aa22">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #55aa22">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #ff0000">&#39;</span> <span style="color: #0000ff">for</span> more information.<span style="color: #55aa22">\n</span><span style="color: #55aa22">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #55aa22">}</span></span></span></code></pre></code><a name='algol'><h2><a id='stylelink' href='algol.html' alt='View only algol'>algol</a></h2></a><code><pre style="background-color: #ffffff;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #666666; font-weight: bold; font-style: italic">version_string</span> <span class="o">=</span> <span style="color: #666666; font-style: italic">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #666666; font-weight: bold; font-style: italic">IOPRIO_WHO_PROCESS</span> <span class="o">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #666666; font-weight: bold; font-style: italic">IOPRIO_CLASS_SHIFT</span> <span class="o">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #666666; font-weight: bold; font-style: italic">EX_EXEC_FAILED</span> <span class="o">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #666666; font-weight: bold; font-style: italic">EX_EXEC_ENOENT</span> <span class="o">=</span> 127<span class="p">;</span> // Could not find program to <span style="font-weight: bold; font-style: italic">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span class="o">[]</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_NONE<span class="o">]</span> <span class="o">=</span> <span style="color: #666666; font-style: italic">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_RT<span class="o">]</span> <span class="o">=</span> <span style="color: #666666; font-style: italic">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_BE<span class="o">]</span> <span class="o">=</span> <span style="color: #666666; font-style: italic">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_IDLE<span class="o">]</span> <span class="o">=</span> <span style="color: #666666; font-style: italic">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span class="o">(</span>FILE* stream<span class="o">)</span>
</span></span><span style="display: flex;"><span class="cl"><span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #666666; font-weight: bold; font-style: italic">errno</span> <span class="o">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="font-weight: bold; text-decoration: underline">if</span> <span class="o">(</span>ferror<span class="o">(</span>stream<span class="o">)</span> !<span class="o">=</span> <span class="m">0</span> <span class="o">||</span> fflush<span class="o">(</span>stream<span class="o">)</span> !<span class="o">=</span> 0<span class="o">)</span> <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="font-weight: bold; text-decoration: underline">return</span> <span class="o">(</span><span style="color: #666666; font-weight: bold; font-style: italic">errno</span> <span class="o">==</span> EBADF<span class="o">)</span> ? <span class="m">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="o">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="font-weight: bold; text-decoration: underline">until</span> close. Calling fsync would <span style="font-weight: bold; font-style: italic">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #666666; font-style: italic">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    if (str == NULL || *str == &#39;</span><span style="color: #666666; font-style: italic">\0</span><span style="color: #666666; font-style: italic">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #666666; font-style: italic">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #666666; font-style: italic">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #666666; font-style: italic">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #666666; font-style: italic">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #666666; font-style: italic">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #666666; font-style: italic">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #666666; font-style: italic">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #666666; font-style: italic">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #666666; font-style: italic">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #666666; font-style: italic">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #666666; font-style: italic">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #666666; font-style: italic">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #666666; font-style: italic">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        case &#39;</span>n<span style="color: #666666; font-style: italic">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        case &#39;</span>c<span style="color: #666666; font-style: italic">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #666666; font-style: italic">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        case &#39;</span>p<span style="color: #666666; font-style: italic">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        case &#39;</span>P<span style="color: #666666; font-style: italic">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        case &#39;</span>u<span style="color: #666666; font-style: italic">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        case &#39;</span>t<span style="color: #666666; font-style: italic">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        case &#39;</span>V<span style="color: #666666; font-style: italic">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        case &#39;</span>h<span style="color: #666666; font-style: italic">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #666666; font-style: italic">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="">&#39;</span> <span style="font-weight: bold; text-decoration: underline">for</span> more information.<span style="color: #666666; font-style: italic">\n</span><span style="color: #666666; font-style: italic">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">}</span></span></span></code></pre></code><a name='algol_nu'><h2><a id='stylelink' href='algol_nu.html' alt='View only algol_nu'>algol_nu</a></h2></a><code><pre style="background-color: #ffffff;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #666666; font-weight: bold; font-style: italic">version_string</span> <span class="o">=</span> <span style="color: #666666; font-style: italic">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #666666; font-weight: bold; font-style: italic">IOPRIO_WHO_PROCESS</span> <span class="o">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #666666; font-weight: bold; font-style: italic">IOPRIO_CLASS_SHIFT</span> <span class="o">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #666666; font-weight: bold; font-style: italic">EX_EXEC_FAILED</span> <span class="o">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #666666; font-weight: bold; font-style: italic">EX_EXEC_ENOENT</span> <span class="o">=</span> 127<span class="p">;</span> // Could not find program to <span style="font-weight: bold; font-style: italic">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span class="o">[]</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_NONE<span class="o">]</span> <span class="o">=</span> <span style="color: #666666; font-style: italic">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_RT<span class="o">]</span> <span class="o">=</span> <span style="color: #666666; font-style: italic">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_BE<span class="o">]</span> <span class="o">=</span> <span style="color: #666666; font-style: italic">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_IDLE<span class="o">]</span> <span class="o">=</span> <span style="color: #666666; font-style: italic">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span class="o">(</span>FILE* stream<span class="o">)</span>
</span></span><span style="display: flex;"><span class="cl"><span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #666666; font-weight: bold; font-style: italic">errno</span> <span class="o">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="font-weight: bold">if</span> <span class="o">(</span>ferror<span class="o">(</span>stream<span class="o">)</span> !<span class="o">=</span> <span class="m">0</span> <span class="o">||</span> fflush<span class="o">(</span>stream<span class="o">)</span> !<span class="o">=</span> 0<span class="o">)</span> <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="font-weight: bold">return</span> <span class="o">(</span><span style="color: #666666; font-weight: bold; font-style: italic">errno</span> <span class="o">==</span> EBADF<span class="o">)</span> ? <span class="m">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="o">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="font-weight: bold">until</span> close. Calling fsync would <span style="font-weight: bold; font-style: italic">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #666666; font-style: italic">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    if (str == NULL || *str == &#39;</span><span style="color: #666666; font-style: italic">\0</span><span style="color: #666666; font-style: italic">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #666666; font-style: italic">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #666666; font-style: italic">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #666666; font-style: italic">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #666666; font-style: italic">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #666666; font-style: italic">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #666666; font-style: italic">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #666666; font-style: italic">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #666666; font-style: italic">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #666666; font-style: italic">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #666666; font-style: italic">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #666666; font-style: italic">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #666666; font-style: italic">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #666666; font-style: italic">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        case &#39;</span>n<span style="color: #666666; font-style: italic">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        case &#39;</span>c<span style="color: #666666; font-style: italic">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #666666; font-style: italic">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        case &#39;</span>p<span style="color: #666666; font-style: italic">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        case &#39;</span>P<span style="color: #666666; font-style: italic">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        case &#39;</span>u<span style="color: #666666; font-style: italic">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        case &#39;</span>t<span style="color: #666666; font-style: italic">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        case &#39;</span>V<span style="color: #666666; font-style: italic">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        case &#39;</span>h<span style="color: #666666; font-style: italic">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #666666; font-style: italic">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="">&#39;</span> <span style="font-weight: bold">for</span> more information.<span style="color: #666666; font-style: italic">\n</span><span style="color: #666666; font-style: italic">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">}</span></span></span></code></pre></code><a name='arduino'><h2><a id='stylelink' href='arduino.html' alt='View only arduino'>arduino</a></h2></a><code><pre style="background-color: #ffffff;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #95a5a6">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #95a5a6">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #95a5a6">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #95a5a6">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #95a5a6">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #95a5a6">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #95a5a6">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #95a5a6">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #95a5a6">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #95a5a6">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #95a5a6">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #434f54">version_string</span> <span style="color: #728e00">=</span> <span style="color: #7f8c8d">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #728e00">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #728e00">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #728e00">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #434f54">IOPRIO_WHO_PROCESS</span> <span style="color: #728e00">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #728e00">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #434f54">IOPRIO_CLASS_SHIFT</span> <span style="color: #728e00">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #434f54">EX_EXEC_FAILED</span> <span style="color: #728e00">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #434f54">EX_EXEC_ENOENT</span> <span style="color: #728e00">=</span> 127<span class="p">;</span> // Could not find program to <span style="color: #728e00">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #728e00">[]</span> <span style="color: #728e00">=</span> <span style="color: #728e00">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #728e00">[</span>IOPRIO_CLASS_NONE<span style="color: #728e00">]</span> <span style="color: #728e00">=</span> <span style="color: #7f8c8d">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #728e00">[</span>IOPRIO_CLASS_RT<span style="color: #728e00">]</span> <span style="color: #728e00">=</span> <span style="color: #7f8c8d">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #728e00">[</span>IOPRIO_CLASS_BE<span style="color: #728e00">]</span> <span style="color: #728e00">=</span> <span style="color: #7f8c8d">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #728e00">[</span>IOPRIO_CLASS_IDLE<span style="color: #728e00">]</span> <span style="color: #728e00">=</span> <span style="color: #7f8c8d">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #728e00">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #728e00">(</span>FILE* stream<span style="color: #728e00">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #728e00">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #434f54">errno</span> <span style="color: #728e00">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #728e00">if</span> <span style="color: #728e00">(</span>ferror<span style="color: #728e00">(</span>stream<span style="color: #728e00">)</span> !<span style="color: #728e00">=</span> <span style="color: #8a7b52">0</span> <span style="color: #728e00">||</span> fflush<span style="color: #728e00">(</span>stream<span style="color: #728e00">)</span> !<span style="color: #728e00">=</span> 0<span style="color: #728e00">)</span> <span style="color: #728e00">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #728e00">return</span> <span style="color: #728e00">(</span><span style="color: #434f54">errno</span> <span style="color: #728e00">==</span> EBADF<span style="color: #728e00">)</span> ? <span style="color: #8a7b52">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #728e00">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #728e00">until</span> close. Calling fsync would <span style="color: #728e00">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #7f8c8d">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    if (str == NULL || *str == &#39;</span><span style="color: #7f8c8d">\0</span><span style="color: #7f8c8d">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #7f8c8d">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #7f8c8d">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #7f8c8d">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #7f8c8d">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #7f8c8d">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #7f8c8d">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #7f8c8d">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #7f8c8d">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #7f8c8d">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #7f8c8d">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #7f8c8d">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #7f8c8d">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #7f8c8d">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        case &#39;</span>n<span style="color: #7f8c8d">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        case &#39;</span>c<span style="color: #7f8c8d">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #7f8c8d">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        case &#39;</span>p<span style="color: #7f8c8d">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        case &#39;</span>P<span style="color: #7f8c8d">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        case &#39;</span>u<span style="color: #7f8c8d">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        case &#39;</span>t<span style="color: #7f8c8d">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        case &#39;</span>V<span style="color: #7f8c8d">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        case &#39;</span>h<span style="color: #7f8c8d">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #7f8c8d">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #a61717">&#39;</span> <span style="color: #728e00">for</span> more information.<span style="color: #7f8c8d">\n</span><span style="color: #7f8c8d">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #7f8c8d">}</span></span></span></code></pre></code><a name='autumn'><h2><a id='stylelink' href='autumn.html' alt='View only autumn'>autumn</a></h2></a><code><pre style="background-color: #ffffff;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #aaaaaa; font-style: italic">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #aaaaaa; font-style: italic">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #aaaaaa; font-style: italic">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #aaaaaa; font-style: italic">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #aaaaaa; font-style: italic">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #aaaaaa; font-style: italic">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #aaaaaa; font-style: italic">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #aaaaaa; font-style: italic">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #aaaaaa; font-style: italic">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #aaaaaa; font-style: italic">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #aaaaaa; font-style: italic">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #aa0000">version_string</span> <span class="o">=</span> <span style="color: #aa5500">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #aa0000">IOPRIO_WHO_PROCESS</span> <span class="o">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #aa0000">IOPRIO_CLASS_SHIFT</span> <span class="o">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #aa0000">EX_EXEC_FAILED</span> <span class="o">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #aa0000">EX_EXEC_ENOENT</span> <span class="o">=</span> 127<span class="p">;</span> // Could not find program to <span style="color: #00aaaa">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span class="o">[]</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_NONE<span class="o">]</span> <span class="o">=</span> <span style="color: #aa5500">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_RT<span class="o">]</span> <span class="o">=</span> <span style="color: #aa5500">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_BE<span class="o">]</span> <span class="o">=</span> <span style="color: #aa5500">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_IDLE<span class="o">]</span> <span class="o">=</span> <span style="color: #aa5500">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span class="o">(</span>FILE* stream<span class="o">)</span>
</span></span><span style="display: flex;"><span class="cl"><span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #aa0000">errno</span> <span class="o">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #0000aa">if</span> <span class="o">(</span>ferror<span class="o">(</span>stream<span class="o">)</span> !<span class="o">=</span> <span style="color: #009999">0</span> <span class="o">||</span> fflush<span class="o">(</span>stream<span class="o">)</span> !<span class="o">=</span> 0<span class="o">)</span> <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #0000aa">return</span> <span class="o">(</span><span style="color: #aa0000">errno</span> <span class="o">==</span> EBADF<span class="o">)</span> ? <span style="color: #009999">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="o">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #0000aa">until</span> close. Calling fsync would <span style="color: #00aaaa">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #aa5500">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    if (str == NULL || *str == &#39;</span><span style="color: #aa5500">\0</span><span style="color: #aa5500">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #aa5500">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #aa5500">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #aa5500">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #aa5500">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #aa5500">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #aa5500">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #aa5500">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #aa5500">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #aa5500">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #aa5500">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #aa5500">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #aa5500">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #aa5500">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        case &#39;</span>n<span style="color: #aa5500">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        case &#39;</span>c<span style="color: #aa5500">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #aa5500">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        case &#39;</span>p<span style="color: #aa5500">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        case &#39;</span>P<span style="color: #aa5500">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        case &#39;</span>u<span style="color: #aa5500">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        case &#39;</span>t<span style="color: #aa5500">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        case &#39;</span>V<span style="color: #aa5500">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        case &#39;</span>h<span style="color: #aa5500">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #aa5500">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #ff0000; background-color: #ffaaaa">&#39;</span> <span style="color: #0000aa">for</span> more information.<span style="color: #aa5500">\n</span><span style="color: #aa5500">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #aa5500">}</span></span></span></code></pre></code><a name='average'><h2><a id='stylelink' href='average.html' alt='View only average'>average</a></h2></a><code><pre style="color: #757575; background-color: #000000;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span class="c1">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span class="c1">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span class="c1">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span class="c1">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span class="c1">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span class="c1">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span class="c1">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span class="c1">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span class="c1">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span class="c1">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span class="c1">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #ec0000">version_string</span> <span style="color: #ec0000">=</span> <span style="color: #008900">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #ec0000">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ec0000">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #ec0000">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ec0000">IOPRIO_WHO_PROCESS</span> <span style="color: #ec0000">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ec0000">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #ec0000">IOPRIO_CLASS_SHIFT</span> <span style="color: #ec0000">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #ec0000">EX_EXEC_FAILED</span> <span style="color: #ec0000">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #ec0000">EX_EXEC_ENOENT</span> <span style="color: #ec0000">=</span> 127<span class="p">;</span> // Could not find program to <span style="color: #ec0000">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #ec0000">[]</span> <span style="color: #ec0000">=</span> <span style="color: #ec0000">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ec0000">[</span>IOPRIO_CLASS_NONE<span style="color: #ec0000">]</span> <span style="color: #ec0000">=</span> <span style="color: #008900">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ec0000">[</span>IOPRIO_CLASS_RT<span style="color: #ec0000">]</span> <span style="color: #ec0000">=</span> <span style="color: #008900">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ec0000">[</span>IOPRIO_CLASS_BE<span style="color: #ec0000">]</span> <span style="color: #ec0000">=</span> <span style="color: #008900">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ec0000">[</span>IOPRIO_CLASS_IDLE<span style="color: #ec0000">]</span> <span style="color: #ec0000">=</span> <span style="color: #008900">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ec0000">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #ec0000">(</span>FILE* stream<span style="color: #ec0000">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ec0000">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ec0000">errno</span> <span style="color: #ec0000">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ec0000">if</span> <span style="color: #ec0000">(</span>ferror<span style="color: #ec0000">(</span>stream<span style="color: #ec0000">)</span> !<span style="color: #ec0000">=</span> <span style="color: #008900">0</span> <span style="color: #ec0000">||</span> fflush<span style="color: #ec0000">(</span>stream<span style="color: #ec0000">)</span> !<span style="color: #ec0000">=</span> 0<span style="color: #ec0000">)</span> <span style="color: #ec0000">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #ec0000">return</span> <span style="color: #ec0000">(</span><span style="color: #ec0000">errno</span> <span style="color: #ec0000">==</span> EBADF<span style="color: #ec0000">)</span> ? <span style="color: #008900">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ec0000">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #ec0000">until</span> close. Calling fsync would <span style="color: #ec0000">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #008900">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    if (str == NULL || *str == &#39;</span><span style="color: #008900">\0</span><span style="color: #008900">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #008900">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #008900">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #008900">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #008900">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #008900">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #008900">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #008900">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #008900">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #008900">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #008900">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #008900">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #008900">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #008900">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        case &#39;</span>n<span style="color: #008900">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        case &#39;</span>c<span style="color: #008900">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #008900">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        case &#39;</span>p<span style="color: #008900">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        case &#39;</span>P<span style="color: #008900">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        case &#39;</span>u<span style="color: #008900">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        case &#39;</span>t<span style="color: #008900">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        case &#39;</span>V<span style="color: #008900">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        case &#39;</span>h<span style="color: #008900">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #008900">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #ec0000">&#39;</span> <span style="color: #ec0000">for</span> more information.<span style="color: #008900">\n</span><span style="color: #008900">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #008900">}</span></span></span></code></pre></code><a name='base16-snazzy'><h2><a id='stylelink' href='base16-snazzy.html' alt='View only base16-snazzy'>base16-snazzy</a></h2></a><code><pre style="color: #e2e4e5; background-color: #282a36;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #78787e">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #78787e">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #78787e">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #78787e">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #78787e">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #78787e">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #78787e">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #78787e">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #78787e">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #78787e">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #78787e">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #ff5c57">version_string</span> <span style="color: #ff6ac1">=</span> <span style="color: #5af78e">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #ff6ac1">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ff6ac1">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #ff6ac1">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ff5c57">IOPRIO_WHO_PROCESS</span> <span style="color: #ff6ac1">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ff6ac1">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #ff5c57">IOPRIO_CLASS_SHIFT</span> <span style="color: #ff6ac1">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #ff5c57">EX_EXEC_FAILED</span> <span style="color: #ff6ac1">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #ff5c57">EX_EXEC_ENOENT</span> <span style="color: #ff6ac1">=</span> 127<span class="p">;</span> // Could not find program to <span style="color: #ff5c57">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #ff6ac1">[]</span> <span style="color: #ff6ac1">=</span> <span style="color: #ff6ac1">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ff6ac1">[</span>IOPRIO_CLASS_NONE<span style="color: #ff6ac1">]</span> <span style="color: #ff6ac1">=</span> <span style="color: #5af78e">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ff6ac1">[</span>IOPRIO_CLASS_RT<span style="color: #ff6ac1">]</span> <span style="color: #ff6ac1">=</span> <span style="color: #5af78e">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ff6ac1">[</span>IOPRIO_CLASS_BE<span style="color: #ff6ac1">]</span> <span style="color: #ff6ac1">=</span> <span style="color: #5af78e">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ff6ac1">[</span>IOPRIO_CLASS_IDLE<span style="color: #ff6ac1">]</span> <span style="color: #ff6ac1">=</span> <span style="color: #5af78e">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ff6ac1">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #ff6ac1">(</span>FILE* stream<span style="color: #ff6ac1">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ff6ac1">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ff5c57">errno</span> <span style="color: #ff6ac1">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ff6ac1">if</span> <span style="color: #ff6ac1">(</span>ferror<span style="color: #ff6ac1">(</span>stream<span style="color: #ff6ac1">)</span> !<span style="color: #ff6ac1">=</span> <span style="color: #ff9f43">0</span> <span style="color: #ff6ac1">||</span> fflush<span style="color: #ff6ac1">(</span>stream<span style="color: #ff6ac1">)</span> !<span style="color: #ff6ac1">=</span> 0<span style="color: #ff6ac1">)</span> <span style="color: #ff6ac1">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #ff6ac1">return</span> <span style="color: #ff6ac1">(</span><span style="color: #ff5c57">errno</span> <span style="color: #ff6ac1">==</span> EBADF<span style="color: #ff6ac1">)</span> ? <span style="color: #ff9f43">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ff6ac1">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #ff6ac1">until</span> close. Calling fsync would <span style="color: #ff5c57">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #5af78e">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    if (str == NULL || *str == &#39;</span><span style="color: #5af78e">\0</span><span style="color: #5af78e">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #5af78e">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #5af78e">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #5af78e">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #5af78e">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #5af78e">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #5af78e">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #5af78e">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #5af78e">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #5af78e">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #5af78e">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #5af78e">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #5af78e">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #5af78e">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        case &#39;</span>n<span style="color: #5af78e">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        case &#39;</span>c<span style="color: #5af78e">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #5af78e">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        case &#39;</span>p<span style="color: #5af78e">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        case &#39;</span>P<span style="color: #5af78e">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        case &#39;</span>u<span style="color: #5af78e">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        case &#39;</span>t<span style="color: #5af78e">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        case &#39;</span>V<span style="color: #5af78e">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        case &#39;</span>h<span style="color: #5af78e">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #5af78e">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #ff5c57">&#39;</span> <span style="color: #ff6ac1">for</span> more information.<span style="color: #5af78e">\n</span><span style="color: #5af78e">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #5af78e">}</span></span></span></code></pre></code><a name='borland'><h2><a id='stylelink' href='borland.html' alt='View only borland'>borland</a></h2></a><code><pre style="background-color: #ffffff;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008800; font-style: italic">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008800; font-style: italic">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008800; font-style: italic">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008800; font-style: italic">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008800; font-style: italic">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008800; font-style: italic">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008800; font-style: italic">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008800; font-style: italic">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008800; font-style: italic">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008800; font-style: italic">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008800; font-style: italic">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span class="nv">version_string</span> <span class="o">=</span> <span style="color: #0000ff">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="nv">IOPRIO_WHO_PROCESS</span> <span class="o">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">IOPRIO_CLASS_SHIFT</span> <span class="o">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">EX_EXEC_FAILED</span> <span class="o">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">EX_EXEC_ENOENT</span> <span class="o">=</span> 127<span class="p">;</span> // Could not find program to <span class="nb">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span class="o">[]</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_NONE<span class="o">]</span> <span class="o">=</span> <span style="color: #0000ff">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_RT<span class="o">]</span> <span class="o">=</span> <span style="color: #0000ff">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_BE<span class="o">]</span> <span class="o">=</span> <span style="color: #0000ff">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_IDLE<span class="o">]</span> <span class="o">=</span> <span style="color: #0000ff">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span class="o">(</span>FILE* stream<span class="o">)</span>
</span></span><span style="display: flex;"><span class="cl"><span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="nv">errno</span> <span class="o">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #000080; font-weight: bold">if</span> <span class="o">(</span>ferror<span class="o">(</span>stream<span class="o">)</span> !<span class="o">=</span> <span style="color: #0000ff">0</span> <span class="o">||</span> fflush<span class="o">(</span>stream<span class="o">)</span> !<span class="o">=</span> 0<span class="o">)</span> <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #000080; font-weight: bold">return</span> <span class="o">(</span><span class="nv">errno</span> <span class="o">==</span> EBADF<span class="o">)</span> ? <span style="color: #0000ff">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="o">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #000080; font-weight: bold">until</span> close. Calling fsync would <span class="nb">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #0000ff">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    if (str == NULL || *str == &#39;</span><span style="color: #0000ff">\0</span><span style="color: #0000ff">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #0000ff">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #0000ff">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #0000ff">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #0000ff">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #0000ff">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #0000ff">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #0000ff">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #0000ff">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #0000ff">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #0000ff">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #0000ff">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #0000ff">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #0000ff">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        case &#39;</span>n<span style="color: #0000ff">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        case &#39;</span>c<span style="color: #0000ff">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #0000ff">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        case &#39;</span>p<span style="color: #0000ff">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        case &#39;</span>P<span style="color: #0000ff">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        case &#39;</span>u<span style="color: #0000ff">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        case &#39;</span>t<span style="color: #0000ff">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        case &#39;</span>V<span style="color: #0000ff">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        case &#39;</span>h<span style="color: #0000ff">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #0000ff">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #a61717; background-color: #e3d2d2">&#39;</span> <span style="color: #000080; font-weight: bold">for</span> more information.<span style="color: #0000ff">\n</span><span style="color: #0000ff">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0000ff">}</span></span></span></code></pre></code><a name='bw'><h2><a id='stylelink' href='bw.html' alt='View only bw'>bw</a></h2></a><code><pre style="background-color: #ffffff;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span class="nv">version_string</span> <span class="o">=</span> <span style="font-style: italic">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="nv">IOPRIO_WHO_PROCESS</span> <span class="o">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">IOPRIO_CLASS_SHIFT</span> <span class="o">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">EX_EXEC_FAILED</span> <span class="o">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">EX_EXEC_ENOENT</span> <span class="o">=</span> 127<span class="p">;</span> // Could not find program to <span class="nb">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span class="o">[]</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_NONE<span class="o">]</span> <span class="o">=</span> <span style="font-style: italic">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_RT<span class="o">]</span> <span class="o">=</span> <span style="font-style: italic">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_BE<span class="o">]</span> <span class="o">=</span> <span style="font-style: italic">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_IDLE<span class="o">]</span> <span class="o">=</span> <span style="font-style: italic">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span class="o">(</span>FILE* stream<span class="o">)</span>
</span></span><span style="display: flex;"><span class="cl"><span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="nv">errno</span> <span class="o">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="font-weight: bold">if</span> <span class="o">(</span>ferror<span class="o">(</span>stream<span class="o">)</span> !<span class="o">=</span> <span class="m">0</span> <span class="o">||</span> fflush<span class="o">(</span>stream<span class="o">)</span> !<span class="o">=</span> 0<span class="o">)</span> <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="font-weight: bold">return</span> <span class="o">(</span><span class="nv">errno</span> <span class="o">==</span> EBADF<span class="o">)</span> ? <span class="m">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="o">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="font-weight: bold">until</span> close. Calling fsync would <span class="nb">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="font-style: italic">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    if (str == NULL || *str == &#39;</span><span style="font-weight: bold; font-style: italic">\0</span><span style="font-style: italic">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="font-style: italic">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="font-style: italic">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="font-style: italic">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="font-style: italic">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="font-style: italic">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="font-style: italic">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="font-style: italic">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="font-style: italic">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="font-style: italic">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="font-style: italic">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="font-style: italic">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="font-style: italic">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="font-style: italic">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        case &#39;</span>n<span style="font-style: italic">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        case &#39;</span>c<span style="font-style: italic">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="font-style: italic">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        case &#39;</span>p<span style="font-style: italic">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        case &#39;</span>P<span style="font-style: italic">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        case &#39;</span>u<span style="font-style: italic">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        case &#39;</span>t<span style="font-style: italic">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        case &#39;</span>V<span style="font-style: italic">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        case &#39;</span>h<span style="font-style: italic">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="font-style: italic">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="">&#39;</span> <span style="font-weight: bold">for</span> more information.<span style="font-weight: bold; font-style: italic">\n</span><span style="font-style: italic">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="font-style: italic">}</span></span></span></code></pre></code><a name='catppuccin-frappe'><h2><a id='stylelink' href='catppuccin-frappe.html' alt='View only catppuccin-frappe'>catppuccin-frappe</a></h2></a><code><pre style="color: #ef9f76; background-color: #303446;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #626880; font-style: italic">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #626880; font-style: italic">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #626880; font-style: italic">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #626880; font-style: italic">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #626880; font-style: italic">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #626880; font-style: italic">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #626880; font-style: italic">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #626880; font-style: italic">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #626880; font-style: italic">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #626880; font-style: italic">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #626880; font-style: italic">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span class="nv">version_string</span> <span style="color: #99d1db">=</span> <span style="color: #a6d189">&#34;tinyionice 1.0.4&#34;</span><span style="color: #c6d0f5">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #99d1db">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #99d1db">}</span><span style="color: #c6d0f5">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #99d1db">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="nv">IOPRIO_WHO_PROCESS</span> <span style="color: #99d1db">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #99d1db">}</span><span style="color: #c6d0f5">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">IOPRIO_CLASS_SHIFT</span> <span style="color: #99d1db">=</span> 13<span style="color: #c6d0f5">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">EX_EXEC_FAILED</span> <span style="color: #99d1db">=</span> 126<span style="color: #c6d0f5">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">EX_EXEC_ENOENT</span> <span style="color: #99d1db">=</span> 127<span style="color: #c6d0f5">;</span> // Could not find program to <span style="color: #c6d0f5; font-style: italic">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #99d1db">[]</span> <span style="color: #99d1db">=</span> <span style="color: #99d1db">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #99d1db">[</span>IOPRIO_CLASS_NONE<span style="color: #99d1db">]</span> <span style="color: #99d1db">=</span> <span style="color: #a6d189">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #99d1db">[</span>IOPRIO_CLASS_RT<span style="color: #99d1db">]</span> <span style="color: #99d1db">=</span> <span style="color: #a6d189">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #99d1db">[</span>IOPRIO_CLASS_BE<span style="color: #99d1db">]</span> <span style="color: #99d1db">=</span> <span style="color: #a6d189">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #99d1db">[</span>IOPRIO_CLASS_IDLE<span style="color: #99d1db">]</span> <span style="color: #99d1db">=</span> <span style="color: #a6d189">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #99d1db">}</span><span style="color: #c6d0f5">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #99d1db">(</span>FILE* stream<span style="color: #99d1db">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #99d1db">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="nv">errno</span> <span style="color: #99d1db">=</span> 0<span style="color: #c6d0f5">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ca9ee6">if</span> <span style="color: #99d1db">(</span>ferror<span style="color: #99d1db">(</span>stream<span style="color: #99d1db">)</span> !<span style="color: #99d1db">=</span> <span class="m">0</span> <span style="color: #99d1db">||</span> fflush<span style="color: #99d1db">(</span>stream<span style="color: #99d1db">)</span> !<span style="color: #99d1db">=</span> 0<span style="color: #99d1db">)</span> <span style="color: #99d1db">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #ca9ee6">return</span> <span style="color: #99d1db">(</span><span class="nv">errno</span> <span style="color: #99d1db">==</span> EBADF<span style="color: #99d1db">)</span> ? <span class="m">0</span> : EOF<span style="color: #c6d0f5">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #99d1db">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #ca9ee6">until</span> close. Calling fsync would <span style="color: #c6d0f5; font-style: italic">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #a6d189">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    if (str == NULL || *str == &#39;</span><span style="color: #8caaee">\0</span><span style="color: #a6d189">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #a6d189">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #a6d189">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #a6d189">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #a6d189">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #a6d189">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #a6d189">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #a6d189">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #a6d189">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #a6d189">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #a6d189">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #a6d189">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #a6d189">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #a6d189">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        case &#39;</span>n<span style="color: #a6d189">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        case &#39;</span>c<span style="color: #a6d189">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #a6d189">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        case &#39;</span>p<span style="color: #a6d189">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        case &#39;</span>P<span style="color: #a6d189">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        case &#39;</span>u<span style="color: #a6d189">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        case &#39;</span>t<span style="color: #a6d189">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        case &#39;</span>V<span style="color: #a6d189">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        case &#39;</span>h<span style="color: #a6d189">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #a6d189">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #e78284">&#39;</span> <span style="color: #ca9ee6">for</span> more information.<span style="color: #8caaee">\n</span><span style="color: #a6d189">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6d189">}</span></span></span></code></pre></code><a name='catppuccin-latte'><h2><a id='stylelink' href='catppuccin-latte.html' alt='View only catppuccin-latte'>catppuccin-latte</a></h2></a><code><pre style="color: #fe640b; background-color: #eff1f5;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #acb0be; font-style: italic">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #acb0be; font-style: italic">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #acb0be; font-style: italic">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #acb0be; font-style: italic">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #acb0be; font-style: italic">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #acb0be; font-style: italic">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #acb0be; font-style: italic">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #acb0be; font-style: italic">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #acb0be; font-style: italic">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #acb0be; font-style: italic">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #acb0be; font-style: italic">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span class="nv">version_string</span> <span style="color: #04a5e5">=</span> <span style="color: #40a02b">&#34;tinyionice 1.0.4&#34;</span><span style="color: #4c4f69">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #04a5e5">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #04a5e5">}</span><span style="color: #4c4f69">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #04a5e5">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="nv">IOPRIO_WHO_PROCESS</span> <span style="color: #04a5e5">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #04a5e5">}</span><span style="color: #4c4f69">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">IOPRIO_CLASS_SHIFT</span> <span style="color: #04a5e5">=</span> 13<span style="color: #4c4f69">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">EX_EXEC_FAILED</span> <span style="color: #04a5e5">=</span> 126<span style="color: #4c4f69">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">EX_EXEC_ENOENT</span> <span style="color: #04a5e5">=</span> 127<span style="color: #4c4f69">;</span> // Could not find program to <span style="font-style: italic">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #04a5e5">[]</span> <span style="color: #04a5e5">=</span> <span style="color: #04a5e5">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #04a5e5">[</span>IOPRIO_CLASS_NONE<span style="color: #04a5e5">]</span> <span style="color: #04a5e5">=</span> <span style="color: #40a02b">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #04a5e5">[</span>IOPRIO_CLASS_RT<span style="color: #04a5e5">]</span> <span style="color: #04a5e5">=</span> <span style="color: #40a02b">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #04a5e5">[</span>IOPRIO_CLASS_BE<span style="color: #04a5e5">]</span> <span style="color: #04a5e5">=</span> <span style="color: #40a02b">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #04a5e5">[</span>IOPRIO_CLASS_IDLE<span style="color: #04a5e5">]</span> <span style="color: #04a5e5">=</span> <span style="color: #40a02b">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #04a5e5">}</span><span style="color: #4c4f69">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #04a5e5">(</span>FILE* stream<span style="color: #04a5e5">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #04a5e5">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="nv">errno</span> <span style="color: #04a5e5">=</span> 0<span style="color: #4c4f69">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #8839ef">if</span> <span style="color: #04a5e5">(</span>ferror<span style="color: #04a5e5">(</span>stream<span style="color: #04a5e5">)</span> !<span style="color: #04a5e5">=</span> <span class="m">0</span> <span style="color: #04a5e5">||</span> fflush<span style="color: #04a5e5">(</span>stream<span style="color: #04a5e5">)</span> !<span style="color: #04a5e5">=</span> 0<span style="color: #04a5e5">)</span> <span style="color: #04a5e5">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #8839ef">return</span> <span style="color: #04a5e5">(</span><span class="nv">errno</span> <span style="color: #04a5e5">==</span> EBADF<span style="color: #04a5e5">)</span> ? <span class="m">0</span> : EOF<span style="color: #4c4f69">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #04a5e5">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #8839ef">until</span> close. Calling fsync would <span style="font-style: italic">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #40a02b">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    if (str == NULL || *str == &#39;</span><span style="color: #1e66f5">\0</span><span style="color: #40a02b">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #40a02b">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #40a02b">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #40a02b">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #40a02b">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #40a02b">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #40a02b">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #40a02b">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #40a02b">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #40a02b">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #40a02b">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #40a02b">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #40a02b">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #40a02b">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        case &#39;</span>n<span style="color: #40a02b">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        case &#39;</span>c<span style="color: #40a02b">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #40a02b">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        case &#39;</span>p<span style="color: #40a02b">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        case &#39;</span>P<span style="color: #40a02b">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        case &#39;</span>u<span style="color: #40a02b">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        case &#39;</span>t<span style="color: #40a02b">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        case &#39;</span>V<span style="color: #40a02b">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        case &#39;</span>h<span style="color: #40a02b">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #40a02b">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #d20f39">&#39;</span> <span style="color: #8839ef">for</span> more information.<span style="color: #1e66f5">\n</span><span style="color: #40a02b">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #40a02b">}</span></span></span></code></pre></code><a name='catppuccin-macchiato'><h2><a id='stylelink' href='catppuccin-macchiato.html' alt='View only catppuccin-macchiato'>catppuccin-macchiato</a></h2></a><code><pre style="color: #f5a97f; background-color: #24273a;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #5b6078; font-style: italic">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #5b6078; font-style: italic">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #5b6078; font-style: italic">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #5b6078; font-style: italic">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #5b6078; font-style: italic">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #5b6078; font-style: italic">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #5b6078; font-style: italic">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #5b6078; font-style: italic">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #5b6078; font-style: italic">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #5b6078; font-style: italic">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #5b6078; font-style: italic">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span class="nv">version_string</span> <span style="color: #91d7e3">=</span> <span style="color: #a6da95">&#34;tinyionice 1.0.4&#34;</span><span style="color: #cad3f5">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #91d7e3">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #91d7e3">}</span><span style="color: #cad3f5">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #91d7e3">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="nv">IOPRIO_WHO_PROCESS</span> <span style="color: #91d7e3">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #91d7e3">}</span><span style="color: #cad3f5">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">IOPRIO_CLASS_SHIFT</span> <span style="color: #91d7e3">=</span> 13<span style="color: #cad3f5">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">EX_EXEC_FAILED</span> <span style="color: #91d7e3">=</span> 126<span style="color: #cad3f5">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">EX_EXEC_ENOENT</span> <span style="color: #91d7e3">=</span> 127<span style="color: #cad3f5">;</span> // Could not find program to <span style="font-style: italic">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #91d7e3">[]</span> <span style="color: #91d7e3">=</span> <span style="color: #91d7e3">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #91d7e3">[</span>IOPRIO_CLASS_NONE<span style="color: #91d7e3">]</span> <span style="color: #91d7e3">=</span> <span style="color: #a6da95">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #91d7e3">[</span>IOPRIO_CLASS_RT<span style="color: #91d7e3">]</span> <span style="color: #91d7e3">=</span> <span style="color: #a6da95">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #91d7e3">[</span>IOPRIO_CLASS_BE<span style="color: #91d7e3">]</span> <span style="color: #91d7e3">=</span> <span style="color: #a6da95">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #91d7e3">[</span>IOPRIO_CLASS_IDLE<span style="color: #91d7e3">]</span> <span style="color: #91d7e3">=</span> <span style="color: #a6da95">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #91d7e3">}</span><span style="color: #cad3f5">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #91d7e3">(</span>FILE* stream<span style="color: #91d7e3">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #91d7e3">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="nv">errno</span> <span style="color: #91d7e3">=</span> 0<span style="color: #cad3f5">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #c6a0f6">if</span> <span style="color: #91d7e3">(</span>ferror<span style="color: #91d7e3">(</span>stream<span style="color: #91d7e3">)</span> !<span style="color: #91d7e3">=</span> <span class="m">0</span> <span style="color: #91d7e3">||</span> fflush<span style="color: #91d7e3">(</span>stream<span style="color: #91d7e3">)</span> !<span style="color: #91d7e3">=</span> 0<span style="color: #91d7e3">)</span> <span style="color: #91d7e3">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #c6a0f6">return</span> <span style="color: #91d7e3">(</span><span class="nv">errno</span> <span style="color: #91d7e3">==</span> EBADF<span style="color: #91d7e3">)</span> ? <span class="m">0</span> : EOF<span style="color: #cad3f5">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #91d7e3">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #c6a0f6">until</span> close. Calling fsync would <span style="font-style: italic">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #a6da95">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    if (str == NULL || *str == &#39;</span><span style="color: #8aadf4">\0</span><span style="color: #a6da95">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #a6da95">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #a6da95">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #a6da95">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #a6da95">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #a6da95">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #a6da95">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #a6da95">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #a6da95">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #a6da95">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #a6da95">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #a6da95">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #a6da95">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #a6da95">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        case &#39;</span>n<span style="color: #a6da95">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        case &#39;</span>c<span style="color: #a6da95">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #a6da95">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        case &#39;</span>p<span style="color: #a6da95">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        case &#39;</span>P<span style="color: #a6da95">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        case &#39;</span>u<span style="color: #a6da95">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        case &#39;</span>t<span style="color: #a6da95">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        case &#39;</span>V<span style="color: #a6da95">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        case &#39;</span>h<span style="color: #a6da95">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #a6da95">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #ed8796">&#39;</span> <span style="color: #c6a0f6">for</span> more information.<span style="color: #8aadf4">\n</span><span style="color: #a6da95">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6da95">}</span></span></span></code></pre></code><a name='catppuccin-mocha'><h2><a id='stylelink' href='catppuccin-mocha.html' alt='View only catppuccin-mocha'>catppuccin-mocha</a></h2></a><code><pre style="color: #fab387; background-color: #1e1e2e;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #585b70; font-style: italic">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #585b70; font-style: italic">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #585b70; font-style: italic">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #585b70; font-style: italic">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #585b70; font-style: italic">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #585b70; font-style: italic">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #585b70; font-style: italic">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #585b70; font-style: italic">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #585b70; font-style: italic">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #585b70; font-style: italic">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #585b70; font-style: italic">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span class="nv">version_string</span> <span style="color: #89dceb">=</span> <span style="color: #a6e3a1">&#34;tinyionice 1.0.4&#34;</span><span style="color: #cdd6f4">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #89dceb">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #89dceb">}</span><span style="color: #cdd6f4">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #89dceb">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="nv">IOPRIO_WHO_PROCESS</span> <span style="color: #89dceb">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #89dceb">}</span><span style="color: #cdd6f4">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">IOPRIO_CLASS_SHIFT</span> <span style="color: #89dceb">=</span> 13<span style="color: #cdd6f4">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">EX_EXEC_FAILED</span> <span style="color: #89dceb">=</span> 126<span style="color: #cdd6f4">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">EX_EXEC_ENOENT</span> <span style="color: #89dceb">=</span> 127<span style="color: #cdd6f4">;</span> // Could not find program to <span style="font-style: italic">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #89dceb">[]</span> <span style="color: #89dceb">=</span> <span style="color: #89dceb">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #89dceb">[</span>IOPRIO_CLASS_NONE<span style="color: #89dceb">]</span> <span style="color: #89dceb">=</span> <span style="color: #a6e3a1">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #89dceb">[</span>IOPRIO_CLASS_RT<span style="color: #89dceb">]</span> <span style="color: #89dceb">=</span> <span style="color: #a6e3a1">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #89dceb">[</span>IOPRIO_CLASS_BE<span style="color: #89dceb">]</span> <span style="color: #89dceb">=</span> <span style="color: #a6e3a1">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #89dceb">[</span>IOPRIO_CLASS_IDLE<span style="color: #89dceb">]</span> <span style="color: #89dceb">=</span> <span style="color: #a6e3a1">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #89dceb">}</span><span style="color: #cdd6f4">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #89dceb">(</span>FILE* stream<span style="color: #89dceb">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #89dceb">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="nv">errno</span> <span style="color: #89dceb">=</span> 0<span style="color: #cdd6f4">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #cba6f7">if</span> <span style="color: #89dceb">(</span>ferror<span style="color: #89dceb">(</span>stream<span style="color: #89dceb">)</span> !<span style="color: #89dceb">=</span> <span class="m">0</span> <span style="color: #89dceb">||</span> fflush<span style="color: #89dceb">(</span>stream<span style="color: #89dceb">)</span> !<span style="color: #89dceb">=</span> 0<span style="color: #89dceb">)</span> <span style="color: #89dceb">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #cba6f7">return</span> <span style="color: #89dceb">(</span><span class="nv">errno</span> <span style="color: #89dceb">==</span> EBADF<span style="color: #89dceb">)</span> ? <span class="m">0</span> : EOF<span style="color: #cdd6f4">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #89dceb">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #cba6f7">until</span> close. Calling fsync would <span style="font-style: italic">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #a6e3a1">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    if (str == NULL || *str == &#39;</span><span style="color: #89b4fa">\0</span><span style="color: #a6e3a1">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #a6e3a1">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #a6e3a1">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #a6e3a1">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #a6e3a1">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #a6e3a1">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #a6e3a1">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #a6e3a1">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #a6e3a1">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #a6e3a1">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #a6e3a1">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #a6e3a1">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #a6e3a1">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #a6e3a1">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        case &#39;</span>n<span style="color: #a6e3a1">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        case &#39;</span>c<span style="color: #a6e3a1">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #a6e3a1">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        case &#39;</span>p<span style="color: #a6e3a1">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        case &#39;</span>P<span style="color: #a6e3a1">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        case &#39;</span>u<span style="color: #a6e3a1">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        case &#39;</span>t<span style="color: #a6e3a1">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        case &#39;</span>V<span style="color: #a6e3a1">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        case &#39;</span>h<span style="color: #a6e3a1">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #a6e3a1">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #f38ba8">&#39;</span> <span style="color: #cba6f7">for</span> more information.<span style="color: #89b4fa">\n</span><span style="color: #a6e3a1">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6e3a1">}</span></span></span></code></pre></code><a name='colorful'><h2><a id='stylelink' href='colorful.html' alt='View only colorful'>colorful</a></h2></a><code><pre style="background-color: #ffffff;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #996633">version_string</span> <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #333333">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #333333">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #333333">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #996633">IOPRIO_WHO_PROCESS</span> <span style="color: #333333">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #333333">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #996633">IOPRIO_CLASS_SHIFT</span> <span style="color: #333333">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #996633">EX_EXEC_FAILED</span> <span style="color: #333333">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #996633">EX_EXEC_ENOENT</span> <span style="color: #333333">=</span> 127<span class="p">;</span> // Could not find program to <span style="color: #007020">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #333333">[]</span> <span style="color: #333333">=</span> <span style="color: #333333">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #333333">[</span>IOPRIO_CLASS_NONE<span style="color: #333333">]</span> <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #333333">[</span>IOPRIO_CLASS_RT<span style="color: #333333">]</span> <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #333333">[</span>IOPRIO_CLASS_BE<span style="color: #333333">]</span> <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #333333">[</span>IOPRIO_CLASS_IDLE<span style="color: #333333">]</span> <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #333333">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #333333">(</span>FILE* stream<span style="color: #333333">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #333333">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #996633">errno</span> <span style="color: #333333">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #008800; font-weight: bold">if</span> <span style="color: #333333">(</span>ferror<span style="color: #333333">(</span>stream<span style="color: #333333">)</span> !<span style="color: #333333">=</span> <span style="color: #6600ee; font-weight: bold">0</span> <span style="color: #333333">||</span> fflush<span style="color: #333333">(</span>stream<span style="color: #333333">)</span> !<span style="color: #333333">=</span> 0<span style="color: #333333">)</span> <span style="color: #333333">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #008800; font-weight: bold">return</span> <span style="color: #333333">(</span><span style="color: #996633">errno</span> <span style="color: #333333">==</span> EBADF<span style="color: #333333">)</span> ? <span style="color: #6600ee; font-weight: bold">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #333333">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #008800; font-weight: bold">until</span> close. Calling fsync would <span style="color: #007020">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="background-color: #fff0f0">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    if (str == NULL || *str == &#39;</span><span style="color: #666666; background-color: #fff0f0; font-weight: bold">\0</span><span style="background-color: #fff0f0">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="background-color: #fff0f0">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="background-color: #fff0f0">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="background-color: #fff0f0">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="background-color: #fff0f0">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="background-color: #fff0f0">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="background-color: #fff0f0">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="background-color: #fff0f0">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="background-color: #fff0f0">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="background-color: #fff0f0">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="background-color: #fff0f0">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="background-color: #fff0f0">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="background-color: #fff0f0">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="background-color: #fff0f0">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        case &#39;</span>n<span style="background-color: #fff0f0">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        case &#39;</span>c<span style="background-color: #fff0f0">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="background-color: #fff0f0">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        case &#39;</span>p<span style="background-color: #fff0f0">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        case &#39;</span>P<span style="background-color: #fff0f0">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        case &#39;</span>u<span style="background-color: #fff0f0">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        case &#39;</span>t<span style="background-color: #fff0f0">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        case &#39;</span>V<span style="background-color: #fff0f0">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        case &#39;</span>h<span style="background-color: #fff0f0">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="background-color: #fff0f0">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #ff0000; background-color: #ffaaaa">&#39;</span> <span style="color: #008800; font-weight: bold">for</span> more information.<span style="color: #666666; background-color: #fff0f0; font-weight: bold">\n</span><span style="background-color: #fff0f0">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #fff0f0">}</span></span></span></code></pre></code><a name='doom-one'><h2><a id='stylelink' href='doom-one.html' alt='View only doom-one'>doom-one</a></h2></a><code><pre style="color: #b0c4de; background-color: #282c34;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8a93a5; font-style: italic">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8a93a5; font-style: italic">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8a93a5; font-style: italic">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8a93a5; font-style: italic">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8a93a5; font-style: italic">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8a93a5; font-style: italic">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8a93a5; font-style: italic">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8a93a5; font-style: italic">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8a93a5; font-style: italic">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8a93a5; font-style: italic">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8a93a5; font-style: italic">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #dcaeea">version_string</span> <span style="color: #c7bf54">=</span> <span style="color: #63c381">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #c7bf54">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #c7bf54">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #c7bf54">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #dcaeea">IOPRIO_WHO_PROCESS</span> <span style="color: #c7bf54">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #c7bf54">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #dcaeea">IOPRIO_CLASS_SHIFT</span> <span style="color: #c7bf54">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #dcaeea">EX_EXEC_FAILED</span> <span style="color: #c7bf54">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #dcaeea">EX_EXEC_ENOENT</span> <span style="color: #c7bf54">=</span> 127<span class="p">;</span> // Could not find program to <span style="color: #ef8383">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #c7bf54">[]</span> <span style="color: #c7bf54">=</span> <span style="color: #c7bf54">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #c7bf54">[</span>IOPRIO_CLASS_NONE<span style="color: #c7bf54">]</span> <span style="color: #c7bf54">=</span> <span style="color: #63c381">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #c7bf54">[</span>IOPRIO_CLASS_RT<span style="color: #c7bf54">]</span> <span style="color: #c7bf54">=</span> <span style="color: #63c381">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #c7bf54">[</span>IOPRIO_CLASS_BE<span style="color: #c7bf54">]</span> <span style="color: #c7bf54">=</span> <span style="color: #63c381">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #c7bf54">[</span>IOPRIO_CLASS_IDLE<span style="color: #c7bf54">]</span> <span style="color: #c7bf54">=</span> <span style="color: #63c381">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #c7bf54">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #c7bf54">(</span>FILE* stream<span style="color: #c7bf54">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #c7bf54">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #dcaeea">errno</span> <span style="color: #c7bf54">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #c678dd">if</span> <span style="color: #c7bf54">(</span>ferror<span style="color: #c7bf54">(</span>stream<span style="color: #c7bf54">)</span> !<span style="color: #c7bf54">=</span> <span style="color: #d19a66">0</span> <span style="color: #c7bf54">||</span> fflush<span style="color: #c7bf54">(</span>stream<span style="color: #c7bf54">)</span> !<span style="color: #c7bf54">=</span> 0<span style="color: #c7bf54">)</span> <span style="color: #c7bf54">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #c678dd">return</span> <span style="color: #c7bf54">(</span><span style="color: #dcaeea">errno</span> <span style="color: #c7bf54">==</span> EBADF<span style="color: #c7bf54">)</span> ? <span style="color: #d19a66">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #c7bf54">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #c678dd">until</span> close. Calling fsync would <span style="color: #ef8383">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #98c379">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    if (str == NULL || *str == &#39;</span><span style="color: #d26464; font-weight: bold">\0</span><span style="color: #98c379">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #98c379">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #98c379">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #98c379">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #98c379">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #98c379">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #98c379">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #98c379">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #98c379">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #98c379">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #98c379">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #98c379">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #98c379">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #98c379">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        case &#39;</span>n<span style="color: #98c379">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        case &#39;</span>c<span style="color: #98c379">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #98c379">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        case &#39;</span>p<span style="color: #98c379">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        case &#39;</span>P<span style="color: #98c379">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        case &#39;</span>u<span style="color: #98c379">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        case &#39;</span>t<span style="color: #98c379">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        case &#39;</span>V<span style="color: #98c379">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        case &#39;</span>h<span style="color: #98c379">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #98c379">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span class="err">&#39;</span> <span style="color: #c678dd">for</span> more information.<span style="color: #d26464; font-weight: bold">\n</span><span style="color: #63c381">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #63c381">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #63c381">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #63c381">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #63c381">}</span></span></span></code></pre></code><a name='doom-one2'><h2><a id='stylelink' href='doom-one2.html' alt='View only doom-one2'>doom-one2</a></h2></a><code><pre style="color: #b0c4de; background-color: #282c34;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8a93a5; font-style: italic">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8a93a5; font-style: italic">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8a93a5; font-style: italic">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8a93a5; font-style: italic">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8a93a5; font-style: italic">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8a93a5; font-style: italic">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8a93a5; font-style: italic">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8a93a5; font-style: italic">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8a93a5; font-style: italic">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8a93a5; font-style: italic">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8a93a5; font-style: italic">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #dcaeea">version_string</span> <span style="color: #54b1c7">=</span> <span style="color: #63c381">&#34;tinyionice 1.0.4&#34;</span><span style="color: #abb2bf">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #54b1c7">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #54b1c7">}</span><span style="color: #abb2bf">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #54b1c7">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #dcaeea">IOPRIO_WHO_PROCESS</span> <span style="color: #54b1c7">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #54b1c7">}</span><span style="color: #abb2bf">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #dcaeea">IOPRIO_CLASS_SHIFT</span> <span style="color: #54b1c7">=</span> 13<span style="color: #abb2bf">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #dcaeea">EX_EXEC_FAILED</span> <span style="color: #54b1c7">=</span> 126<span style="color: #abb2bf">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #dcaeea">EX_EXEC_ENOENT</span> <span style="color: #54b1c7">=</span> 127<span style="color: #abb2bf">;</span> // Could not find program to <span style="color: #e5c07b">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #54b1c7">[]</span> <span style="color: #54b1c7">=</span> <span style="color: #54b1c7">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #54b1c7">[</span>IOPRIO_CLASS_NONE<span style="color: #54b1c7">]</span> <span style="color: #54b1c7">=</span> <span style="color: #63c381">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #54b1c7">[</span>IOPRIO_CLASS_RT<span style="color: #54b1c7">]</span> <span style="color: #54b1c7">=</span> <span style="color: #63c381">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #54b1c7">[</span>IOPRIO_CLASS_BE<span style="color: #54b1c7">]</span> <span style="color: #54b1c7">=</span> <span style="color: #63c381">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #54b1c7">[</span>IOPRIO_CLASS_IDLE<span style="color: #54b1c7">]</span> <span style="color: #54b1c7">=</span> <span style="color: #63c381">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #54b1c7">}</span><span style="color: #abb2bf">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #54b1c7">(</span>FILE* stream<span style="color: #54b1c7">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #54b1c7">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #dcaeea">errno</span> <span style="color: #54b1c7">=</span> 0<span style="color: #abb2bf">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #76a9f9">if</span> <span style="color: #54b1c7">(</span>ferror<span style="color: #54b1c7">(</span>stream<span style="color: #54b1c7">)</span> !<span style="color: #54b1c7">=</span> <span style="color: #d19a66">0</span> <span style="color: #54b1c7">||</span> fflush<span style="color: #54b1c7">(</span>stream<span style="color: #54b1c7">)</span> !<span style="color: #54b1c7">=</span> 0<span style="color: #54b1c7">)</span> <span style="color: #54b1c7">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #76a9f9">return</span> <span style="color: #54b1c7">(</span><span style="color: #dcaeea">errno</span> <span style="color: #54b1c7">==</span> EBADF<span style="color: #54b1c7">)</span> ? <span style="color: #d19a66">0</span> : EOF<span style="color: #abb2bf">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #54b1c7">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #76a9f9">until</span> close. Calling fsync would <span style="color: #e5c07b">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #98c379">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    if (str == NULL || *str == &#39;</span><span style="color: #d26464; font-weight: bold">\0</span><span style="color: #98c379">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #98c379">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #98c379">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #98c379">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #98c379">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #98c379">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #98c379">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #98c379">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #98c379">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #98c379">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #98c379">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #98c379">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #98c379">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #98c379">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        case &#39;</span>n<span style="color: #98c379">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        case &#39;</span>c<span style="color: #98c379">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #98c379">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        case &#39;</span>p<span style="color: #98c379">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        case &#39;</span>P<span style="color: #98c379">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        case &#39;</span>u<span style="color: #98c379">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        case &#39;</span>t<span style="color: #98c379">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        case &#39;</span>V<span style="color: #98c379">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        case &#39;</span>h<span style="color: #98c379">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #98c379">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span class="err">&#39;</span> <span style="color: #76a9f9">for</span> more information.<span style="color: #d26464; font-weight: bold">\n</span><span style="color: #63c381">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #63c381">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #63c381">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #63c381">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #63c381">}</span></span></span></code></pre></code><a name='dracula'><h2><a id='stylelink' href='dracula.html' alt='View only dracula'>dracula</a></h2></a><code><pre style="color: #f8f8f2; background-color: #282a36;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6272a4">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6272a4">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6272a4">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6272a4">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6272a4">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6272a4">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6272a4">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6272a4">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6272a4">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6272a4">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6272a4">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #8be9fd; font-style: italic">version_string</span> <span style="color: #ff79c6">=</span> <span style="color: #f1fa8c">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #ff79c6">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ff79c6">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #ff79c6">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #8be9fd; font-style: italic">IOPRIO_WHO_PROCESS</span> <span style="color: #ff79c6">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ff79c6">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #8be9fd; font-style: italic">IOPRIO_CLASS_SHIFT</span> <span style="color: #ff79c6">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #8be9fd; font-style: italic">EX_EXEC_FAILED</span> <span style="color: #ff79c6">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #8be9fd; font-style: italic">EX_EXEC_ENOENT</span> <span style="color: #ff79c6">=</span> 127<span class="p">;</span> // Could not find program to <span style="color: #8be9fd; font-style: italic">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #ff79c6">[]</span> <span style="color: #ff79c6">=</span> <span style="color: #ff79c6">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ff79c6">[</span>IOPRIO_CLASS_NONE<span style="color: #ff79c6">]</span> <span style="color: #ff79c6">=</span> <span style="color: #f1fa8c">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ff79c6">[</span>IOPRIO_CLASS_RT<span style="color: #ff79c6">]</span> <span style="color: #ff79c6">=</span> <span style="color: #f1fa8c">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ff79c6">[</span>IOPRIO_CLASS_BE<span style="color: #ff79c6">]</span> <span style="color: #ff79c6">=</span> <span style="color: #f1fa8c">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ff79c6">[</span>IOPRIO_CLASS_IDLE<span style="color: #ff79c6">]</span> <span style="color: #ff79c6">=</span> <span style="color: #f1fa8c">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ff79c6">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #ff79c6">(</span>FILE* stream<span style="color: #ff79c6">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ff79c6">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #8be9fd; font-style: italic">errno</span> <span style="color: #ff79c6">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ff79c6">if</span> <span style="color: #ff79c6">(</span>ferror<span style="color: #ff79c6">(</span>stream<span style="color: #ff79c6">)</span> !<span style="color: #ff79c6">=</span> <span style="color: #bd93f9">0</span> <span style="color: #ff79c6">||</span> fflush<span style="color: #ff79c6">(</span>stream<span style="color: #ff79c6">)</span> !<span style="color: #ff79c6">=</span> 0<span style="color: #ff79c6">)</span> <span style="color: #ff79c6">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #ff79c6">return</span> <span style="color: #ff79c6">(</span><span style="color: #8be9fd; font-style: italic">errno</span> <span style="color: #ff79c6">==</span> EBADF<span style="color: #ff79c6">)</span> ? <span style="color: #bd93f9">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ff79c6">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #ff79c6">until</span> close. Calling fsync would <span style="color: #8be9fd; font-style: italic">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #f1fa8c">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    if (str == NULL || *str == &#39;</span><span style="color: #f1fa8c">\0</span><span style="color: #f1fa8c">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #f1fa8c">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #f1fa8c">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #f1fa8c">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #f1fa8c">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #f1fa8c">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #f1fa8c">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #f1fa8c">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #f1fa8c">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #f1fa8c">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #f1fa8c">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #f1fa8c">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #f1fa8c">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #f1fa8c">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        case &#39;</span>n<span style="color: #f1fa8c">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        case &#39;</span>c<span style="color: #f1fa8c">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #f1fa8c">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        case &#39;</span>p<span style="color: #f1fa8c">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        case &#39;</span>P<span style="color: #f1fa8c">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        case &#39;</span>u<span style="color: #f1fa8c">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        case &#39;</span>t<span style="color: #f1fa8c">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        case &#39;</span>V<span style="color: #f1fa8c">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        case &#39;</span>h<span style="color: #f1fa8c">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #f1fa8c">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span class="err">&#39;</span> <span style="color: #ff79c6">for</span> more information.<span style="color: #f1fa8c">\n</span><span style="color: #f1fa8c">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f1fa8c">}</span></span></span></code></pre></code><a name='emacs'><h2><a id='stylelink' href='emacs.html' alt='View only emacs'>emacs</a></h2></a><code><pre style="background-color: #f8f8f8;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008800; font-style: italic">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008800; font-style: italic">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008800; font-style: italic">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008800; font-style: italic">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008800; font-style: italic">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008800; font-style: italic">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008800; font-style: italic">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008800; font-style: italic">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008800; font-style: italic">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008800; font-style: italic">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008800; font-style: italic">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #b8860b">version_string</span> <span style="color: #666666">=</span> <span style="color: #bb4444">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #666666">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #666666">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #666666">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #b8860b">IOPRIO_WHO_PROCESS</span> <span style="color: #666666">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #666666">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #b8860b">IOPRIO_CLASS_SHIFT</span> <span style="color: #666666">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #b8860b">EX_EXEC_FAILED</span> <span style="color: #666666">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #b8860b">EX_EXEC_ENOENT</span> <span style="color: #666666">=</span> 127<span class="p">;</span> // Could not find program to <span style="color: #aa22ff">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #666666">[]</span> <span style="color: #666666">=</span> <span style="color: #666666">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #666666">[</span>IOPRIO_CLASS_NONE<span style="color: #666666">]</span> <span style="color: #666666">=</span> <span style="color: #bb4444">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #666666">[</span>IOPRIO_CLASS_RT<span style="color: #666666">]</span> <span style="color: #666666">=</span> <span style="color: #bb4444">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #666666">[</span>IOPRIO_CLASS_BE<span style="color: #666666">]</span> <span style="color: #666666">=</span> <span style="color: #bb4444">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #666666">[</span>IOPRIO_CLASS_IDLE<span style="color: #666666">]</span> <span style="color: #666666">=</span> <span style="color: #bb4444">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #666666">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #666666">(</span>FILE* stream<span style="color: #666666">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #666666">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #b8860b">errno</span> <span style="color: #666666">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #aa22ff; font-weight: bold">if</span> <span style="color: #666666">(</span>ferror<span style="color: #666666">(</span>stream<span style="color: #666666">)</span> !<span style="color: #666666">=</span> <span style="color: #666666">0</span> <span style="color: #666666">||</span> fflush<span style="color: #666666">(</span>stream<span style="color: #666666">)</span> !<span style="color: #666666">=</span> 0<span style="color: #666666">)</span> <span style="color: #666666">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #aa22ff; font-weight: bold">return</span> <span style="color: #666666">(</span><span style="color: #b8860b">errno</span> <span style="color: #666666">==</span> EBADF<span style="color: #666666">)</span> ? <span style="color: #666666">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #666666">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #aa22ff; font-weight: bold">until</span> close. Calling fsync would <span style="color: #aa22ff">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #bb4444">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    if (str == NULL || *str == &#39;</span><span style="color: #bb6622; font-weight: bold">\0</span><span style="color: #bb4444">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #bb4444">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #bb4444">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #bb4444">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #bb4444">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #bb4444">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #bb4444">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #bb4444">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #bb4444">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #bb4444">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #bb4444">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #bb4444">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #bb4444">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #bb4444">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        case &#39;</span>n<span style="color: #bb4444">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        case &#39;</span>c<span style="color: #bb4444">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #bb4444">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        case &#39;</span>p<span style="color: #bb4444">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        case &#39;</span>P<span style="color: #bb4444">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        case &#39;</span>u<span style="color: #bb4444">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        case &#39;</span>t<span style="color: #bb4444">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        case &#39;</span>V<span style="color: #bb4444">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        case &#39;</span>h<span style="color: #bb4444">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #bb4444">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="">&#39;</span> <span style="color: #aa22ff; font-weight: bold">for</span> more information.<span style="color: #bb6622; font-weight: bold">\n</span><span style="color: #bb4444">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb4444">}</span></span></span></code></pre></code><a name='friendly'><h2><a id='stylelink' href='friendly.html' alt='View only friendly'>friendly</a></h2></a><code><pre style="background-color: #f0f0f0;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #60a0b0; font-style: italic">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #60a0b0; font-style: italic">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #60a0b0; font-style: italic">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #60a0b0; font-style: italic">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #60a0b0; font-style: italic">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #60a0b0; font-style: italic">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #60a0b0; font-style: italic">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #60a0b0; font-style: italic">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #60a0b0; font-style: italic">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #60a0b0; font-style: italic">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #60a0b0; font-style: italic">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #bb60d5">version_string</span> <span style="color: #666666">=</span> <span style="color: #4070a0">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #666666">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #666666">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #666666">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #bb60d5">IOPRIO_WHO_PROCESS</span> <span style="color: #666666">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #666666">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #bb60d5">IOPRIO_CLASS_SHIFT</span> <span style="color: #666666">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #bb60d5">EX_EXEC_FAILED</span> <span style="color: #666666">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #bb60d5">EX_EXEC_ENOENT</span> <span style="color: #666666">=</span> 127<span class="p">;</span> // Could not find program to <span style="color: #007020">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #666666">[]</span> <span style="color: #666666">=</span> <span style="color: #666666">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #666666">[</span>IOPRIO_CLASS_NONE<span style="color: #666666">]</span> <span style="color: #666666">=</span> <span style="color: #4070a0">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #666666">[</span>IOPRIO_CLASS_RT<span style="color: #666666">]</span> <span style="color: #666666">=</span> <span style="color: #4070a0">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #666666">[</span>IOPRIO_CLASS_BE<span style="color: #666666">]</span> <span style="color: #666666">=</span> <span style="color: #4070a0">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #666666">[</span>IOPRIO_CLASS_IDLE<span style="color: #666666">]</span> <span style="color: #666666">=</span> <span style="color: #4070a0">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #666666">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #666666">(</span>FILE* stream<span style="color: #666666">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #666666">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #bb60d5">errno</span> <span style="color: #666666">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #007020; font-weight: bold">if</span> <span style="color: #666666">(</span>ferror<span style="color: #666666">(</span>stream<span style="color: #666666">)</span> !<span style="color: #666666">=</span> <span style="color: #40a070">0</span> <span style="color: #666666">||</span> fflush<span style="color: #666666">(</span>stream<span style="color: #666666">)</span> !<span style="color: #666666">=</span> 0<span style="color: #666666">)</span> <span style="color: #666666">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #007020; font-weight: bold">return</span> <span style="color: #666666">(</span><span style="color: #bb60d5">errno</span> <span style="color: #666666">==</span> EBADF<span style="color: #666666">)</span> ? <span style="color: #40a070">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #666666">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #007020; font-weight: bold">until</span> close. Calling fsync would <span style="color: #007020">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #4070a0">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    if (str == NULL || *str == &#39;</span><span style="color: #4070a0; font-weight: bold">\0</span><span style="color: #4070a0">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #4070a0">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #4070a0">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #4070a0">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #4070a0">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #4070a0">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #4070a0">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #4070a0">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #4070a0">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #4070a0">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #4070a0">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #4070a0">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #4070a0">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #4070a0">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        case &#39;</span>n<span style="color: #4070a0">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        case &#39;</span>c<span style="color: #4070a0">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #4070a0">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        case &#39;</span>p<span style="color: #4070a0">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        case &#39;</span>P<span style="color: #4070a0">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        case &#39;</span>u<span style="color: #4070a0">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        case &#39;</span>t<span style="color: #4070a0">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        case &#39;</span>V<span style="color: #4070a0">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        case &#39;</span>h<span style="color: #4070a0">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #4070a0">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="">&#39;</span> <span style="color: #007020; font-weight: bold">for</span> more information.<span style="color: #4070a0; font-weight: bold">\n</span><span style="color: #4070a0">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4070a0">}</span></span></span></code></pre></code><a name='fruity'><h2><a id='stylelink' href='fruity.html' alt='View only fruity'>fruity</a></h2></a><code><pre style="color: #ffffff; background-color: #111111;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008800; background-color: #0f140f; font-style: italic">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008800; background-color: #0f140f; font-style: italic">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008800; background-color: #0f140f; font-style: italic">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008800; background-color: #0f140f; font-style: italic">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008800; background-color: #0f140f; font-style: italic">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008800; background-color: #0f140f; font-style: italic">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008800; background-color: #0f140f; font-style: italic">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008800; background-color: #0f140f; font-style: italic">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008800; background-color: #0f140f; font-style: italic">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008800; background-color: #0f140f; font-style: italic">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008800; background-color: #0f140f; font-style: italic">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #fb660a">version_string</span> <span class="o">=</span> <span style="color: #0086d2">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #fb660a">IOPRIO_WHO_PROCESS</span> <span class="o">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #fb660a">IOPRIO_CLASS_SHIFT</span> <span class="o">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #fb660a">EX_EXEC_FAILED</span> <span class="o">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #fb660a">EX_EXEC_ENOENT</span> <span class="o">=</span> 127<span class="p">;</span> // Could not find program to <span class="nb">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span class="o">[]</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_NONE<span class="o">]</span> <span class="o">=</span> <span style="color: #0086d2">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_RT<span class="o">]</span> <span class="o">=</span> <span style="color: #0086d2">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_BE<span class="o">]</span> <span class="o">=</span> <span style="color: #0086d2">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_IDLE<span class="o">]</span> <span class="o">=</span> <span style="color: #0086d2">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span class="o">(</span>FILE* stream<span class="o">)</span>
</span></span><span style="display: flex;"><span class="cl"><span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #fb660a">errno</span> <span class="o">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #fb660a; font-weight: bold">if</span> <span class="o">(</span>ferror<span class="o">(</span>stream<span class="o">)</span> !<span class="o">=</span> <span style="color: #0086f7; font-weight: bold">0</span> <span class="o">||</span> fflush<span class="o">(</span>stream<span class="o">)</span> !<span class="o">=</span> 0<span class="o">)</span> <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #fb660a; font-weight: bold">return</span> <span class="o">(</span><span style="color: #fb660a">errno</span> <span class="o">==</span> EBADF<span class="o">)</span> ? <span style="color: #0086f7; font-weight: bold">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="o">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #fb660a; font-weight: bold">until</span> close. Calling fsync would <span class="nb">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #0086d2">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    if (str == NULL || *str == &#39;</span><span style="color: #0086d2">\0</span><span style="color: #0086d2">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #0086d2">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #0086d2">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #0086d2">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #0086d2">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #0086d2">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #0086d2">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #0086d2">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #0086d2">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #0086d2">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #0086d2">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #0086d2">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #0086d2">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #0086d2">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        case &#39;</span>n<span style="color: #0086d2">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        case &#39;</span>c<span style="color: #0086d2">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #0086d2">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        case &#39;</span>p<span style="color: #0086d2">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        case &#39;</span>P<span style="color: #0086d2">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        case &#39;</span>u<span style="color: #0086d2">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        case &#39;</span>t<span style="color: #0086d2">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        case &#39;</span>V<span style="color: #0086d2">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        case &#39;</span>h<span style="color: #0086d2">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #0086d2">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span class="err">&#39;</span> <span style="color: #fb660a; font-weight: bold">for</span> more information.<span style="color: #0086d2">\n</span><span style="color: #0086d2">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #0086d2">}</span></span></span></code></pre></code><a name='github-dark'><h2><a id='stylelink' href='github-dark.html' alt='View only github-dark'>github-dark</a></h2></a><code><pre style="color: #c9d1d9; background-color: #0d1117;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8b949e; font-style: italic">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8b949e; font-style: italic">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8b949e; font-style: italic">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8b949e; font-style: italic">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8b949e; font-style: italic">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8b949e; font-style: italic">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8b949e; font-style: italic">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8b949e; font-style: italic">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8b949e; font-style: italic">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8b949e; font-style: italic">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8b949e; font-style: italic">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #79c0ff">version_string</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #a5d6ff">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #ff7b72; font-weight: bold">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ff7b72; font-weight: bold">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #ff7b72; font-weight: bold">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #79c0ff">IOPRIO_WHO_PROCESS</span> <span style="color: #ff7b72; font-weight: bold">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ff7b72; font-weight: bold">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #79c0ff">IOPRIO_CLASS_SHIFT</span> <span style="color: #ff7b72; font-weight: bold">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #79c0ff">EX_EXEC_FAILED</span> <span style="color: #ff7b72; font-weight: bold">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #79c0ff">EX_EXEC_ENOENT</span> <span style="color: #ff7b72; font-weight: bold">=</span> 127<span class="p">;</span> // Could not find program to <span class="nb">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #ff7b72; font-weight: bold">[]</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #ff7b72; font-weight: bold">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ff7b72; font-weight: bold">[</span>IOPRIO_CLASS_NONE<span style="color: #ff7b72; font-weight: bold">]</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #a5d6ff">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ff7b72; font-weight: bold">[</span>IOPRIO_CLASS_RT<span style="color: #ff7b72; font-weight: bold">]</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #a5d6ff">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ff7b72; font-weight: bold">[</span>IOPRIO_CLASS_BE<span style="color: #ff7b72; font-weight: bold">]</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #a5d6ff">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ff7b72; font-weight: bold">[</span>IOPRIO_CLASS_IDLE<span style="color: #ff7b72; font-weight: bold">]</span> <span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #a5d6ff">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ff7b72; font-weight: bold">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #ff7b72; font-weight: bold">(</span>FILE* stream<span style="color: #ff7b72; font-weight: bold">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ff7b72; font-weight: bold">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #79c0ff">errno</span> <span style="color: #ff7b72; font-weight: bold">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ff7b72">if</span> <span style="color: #ff7b72; font-weight: bold">(</span>ferror<span style="color: #ff7b72; font-weight: bold">(</span>stream<span style="color: #ff7b72; font-weight: bold">)</span> !<span style="color: #ff7b72; font-weight: bold">=</span> <span style="color: #a5d6ff">0</span> <span style="color: #ff7b72; font-weight: bold">||</span> fflush<span style="color: #ff7b72; font-weight: bold">(</span>stream<span style="color: #ff7b72; font-weight: bold">)</span> !<span style="color: #ff7b72; font-weight: bold">=</span> 0<span style="color: #ff7b72; font-weight: bold">)</span> <span style="color: #ff7b72; font-weight: bold">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #ff7b72">return</span> <span style="color: #ff7b72; font-weight: bold">(</span><span style="color: #79c0ff">errno</span> <span style="color: #ff7b72; font-weight: bold">==</span> EBADF<span style="color: #ff7b72; font-weight: bold">)</span> ? <span style="color: #a5d6ff">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ff7b72; font-weight: bold">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #ff7b72">until</span> close. Calling fsync would <span class="nb">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #a5d6ff">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    if (str == NULL || *str == &#39;</span><span style="color: #79c0ff">\0</span><span style="color: #a5d6ff">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #a5d6ff">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #a5d6ff">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #a5d6ff">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #a5d6ff">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #a5d6ff">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #a5d6ff">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #a5d6ff">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #a5d6ff">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #a5d6ff">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #a5d6ff">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #a5d6ff">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #a5d6ff">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #a5d6ff">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        case &#39;</span>n<span style="color: #a5d6ff">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        case &#39;</span>c<span style="color: #a5d6ff">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #a5d6ff">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        case &#39;</span>p<span style="color: #a5d6ff">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        case &#39;</span>P<span style="color: #a5d6ff">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        case &#39;</span>u<span style="color: #a5d6ff">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        case &#39;</span>t<span style="color: #a5d6ff">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        case &#39;</span>V<span style="color: #a5d6ff">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        case &#39;</span>h<span style="color: #a5d6ff">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #a5d6ff">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #f85149">&#39;</span> <span style="color: #ff7b72">for</span> more information.<span style="color: #79c0ff">\n</span><span style="color: #a5d6ff">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a5d6ff">}</span></span></span></code></pre></code><a name='github'><h2><a id='stylelink' href='github.html' alt='View only github'>github</a></h2></a><code><pre style="background-color: #ffffff;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #999988; font-style: italic">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #999988; font-style: italic">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #999988; font-style: italic">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #999988; font-style: italic">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #999988; font-style: italic">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #999988; font-style: italic">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #999988; font-style: italic">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #999988; font-style: italic">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #999988; font-style: italic">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #999988; font-style: italic">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #999988; font-style: italic">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #008080">version_string</span> <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #000000; font-weight: bold">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #000000; font-weight: bold">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #000000; font-weight: bold">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #008080">IOPRIO_WHO_PROCESS</span> <span style="color: #000000; font-weight: bold">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #000000; font-weight: bold">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #008080">IOPRIO_CLASS_SHIFT</span> <span style="color: #000000; font-weight: bold">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #008080">EX_EXEC_FAILED</span> <span style="color: #000000; font-weight: bold">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #008080">EX_EXEC_ENOENT</span> <span style="color: #000000; font-weight: bold">=</span> 127<span class="p">;</span> // Could not find program to <span style="color: #0086b3">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #000000; font-weight: bold">[]</span> <span style="color: #000000; font-weight: bold">=</span> <span style="color: #000000; font-weight: bold">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #000000; font-weight: bold">[</span>IOPRIO_CLASS_NONE<span style="color: #000000; font-weight: bold">]</span> <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #000000; font-weight: bold">[</span>IOPRIO_CLASS_RT<span style="color: #000000; font-weight: bold">]</span> <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #000000; font-weight: bold">[</span>IOPRIO_CLASS_BE<span style="color: #000000; font-weight: bold">]</span> <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #000000; font-weight: bold">[</span>IOPRIO_CLASS_IDLE<span style="color: #000000; font-weight: bold">]</span> <span style="color: #000000; font-weight: bold">=</span> <span style="color: #dd1144">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #000000; font-weight: bold">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #000000; font-weight: bold">(</span>FILE* stream<span style="color: #000000; font-weight: bold">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #000000; font-weight: bold">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #008080">errno</span> <span style="color: #000000; font-weight: bold">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #000000; font-weight: bold">if</span> <span style="color: #000000; font-weight: bold">(</span>ferror<span style="color: #000000; font-weight: bold">(</span>stream<span style="color: #000000; font-weight: bold">)</span> !<span style="color: #000000; font-weight: bold">=</span> <span style="color: #009999">0</span> <span style="color: #000000; font-weight: bold">||</span> fflush<span style="color: #000000; font-weight: bold">(</span>stream<span style="color: #000000; font-weight: bold">)</span> !<span style="color: #000000; font-weight: bold">=</span> 0<span style="color: #000000; font-weight: bold">)</span> <span style="color: #000000; font-weight: bold">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #000000; font-weight: bold">return</span> <span style="color: #000000; font-weight: bold">(</span><span style="color: #008080">errno</span> <span style="color: #000000; font-weight: bold">==</span> EBADF<span style="color: #000000; font-weight: bold">)</span> ? <span style="color: #009999">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #000000; font-weight: bold">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #000000; font-weight: bold">until</span> close. Calling fsync would <span style="color: #0086b3">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #dd1144">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    if (str == NULL || *str == &#39;</span><span style="color: #dd1144">\0</span><span style="color: #dd1144">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #dd1144">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #dd1144">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #dd1144">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #dd1144">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #dd1144">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #dd1144">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #dd1144">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #dd1144">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #dd1144">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #dd1144">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #dd1144">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #dd1144">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #dd1144">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        case &#39;</span>n<span style="color: #dd1144">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        case &#39;</span>c<span style="color: #dd1144">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #dd1144">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        case &#39;</span>p<span style="color: #dd1144">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        case &#39;</span>P<span style="color: #dd1144">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        case &#39;</span>u<span style="color: #dd1144">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        case &#39;</span>t<span style="color: #dd1144">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        case &#39;</span>V<span style="color: #dd1144">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        case &#39;</span>h<span style="color: #dd1144">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #dd1144">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #a61717; background-color: #e3d2d2">&#39;</span> <span style="color: #000000; font-weight: bold">for</span> more information.<span style="color: #dd1144">\n</span><span style="color: #dd1144">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd1144">}</span></span></span></code></pre></code><a name='gruvbox-light'><h2><a id='stylelink' href='gruvbox-light.html' alt='View only gruvbox-light'>gruvbox-light</a></h2></a><code><pre style="color: #3c3836; background-color: #fbf1c7;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #928374; font-style: italic">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #928374; font-style: italic">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #928374; font-style: italic">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #928374; font-style: italic">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #928374; font-style: italic">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #928374; font-style: italic">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #928374; font-style: italic">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #928374; font-style: italic">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #928374; font-style: italic">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #928374; font-style: italic">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #928374; font-style: italic">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span class="nv">version_string</span> <span style="color: #af3a03">=</span> <span style="color: #79740e">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #af3a03">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #af3a03">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #af3a03">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="nv">IOPRIO_WHO_PROCESS</span> <span style="color: #af3a03">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #af3a03">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">IOPRIO_CLASS_SHIFT</span> <span style="color: #af3a03">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">EX_EXEC_FAILED</span> <span style="color: #af3a03">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">EX_EXEC_ENOENT</span> <span style="color: #af3a03">=</span> 127<span class="p">;</span> // Could not find program to <span style="color: #b57614">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #af3a03">[]</span> <span style="color: #af3a03">=</span> <span style="color: #af3a03">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #af3a03">[</span>IOPRIO_CLASS_NONE<span style="color: #af3a03">]</span> <span style="color: #af3a03">=</span> <span style="color: #79740e">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #af3a03">[</span>IOPRIO_CLASS_RT<span style="color: #af3a03">]</span> <span style="color: #af3a03">=</span> <span style="color: #79740e">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #af3a03">[</span>IOPRIO_CLASS_BE<span style="color: #af3a03">]</span> <span style="color: #af3a03">=</span> <span style="color: #79740e">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #af3a03">[</span>IOPRIO_CLASS_IDLE<span style="color: #af3a03">]</span> <span style="color: #af3a03">=</span> <span style="color: #79740e">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #af3a03">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #af3a03">(</span>FILE* stream<span style="color: #af3a03">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #af3a03">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="nv">errno</span> <span style="color: #af3a03">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #af3a03">if</span> <span style="color: #af3a03">(</span>ferror<span style="color: #af3a03">(</span>stream<span style="color: #af3a03">)</span> !<span style="color: #af3a03">=</span> <span style="color: #8f3f71">0</span> <span style="color: #af3a03">||</span> fflush<span style="color: #af3a03">(</span>stream<span style="color: #af3a03">)</span> !<span style="color: #af3a03">=</span> 0<span style="color: #af3a03">)</span> <span style="color: #af3a03">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #af3a03">return</span> <span style="color: #af3a03">(</span><span class="nv">errno</span> <span style="color: #af3a03">==</span> EBADF<span style="color: #af3a03">)</span> ? <span style="color: #8f3f71">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #af3a03">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #af3a03">until</span> close. Calling fsync would <span style="color: #b57614">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #79740e">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    if (str == NULL || *str == &#39;</span><span style="color: #79740e">\0</span><span style="color: #79740e">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #79740e">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #79740e">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #79740e">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #79740e">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #79740e">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #79740e">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #79740e">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #79740e">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #79740e">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #79740e">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #79740e">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #79740e">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #79740e">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        case &#39;</span>n<span style="color: #79740e">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        case &#39;</span>c<span style="color: #79740e">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #79740e">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        case &#39;</span>p<span style="color: #79740e">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        case &#39;</span>P<span style="color: #79740e">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        case &#39;</span>u<span style="color: #79740e">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        case &#39;</span>t<span style="color: #79740e">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        case &#39;</span>V<span style="color: #79740e">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        case &#39;</span>h<span style="color: #79740e">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #79740e">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span class="err">&#39;</span> <span style="color: #af3a03">for</span> more information.<span style="color: #79740e">\n</span><span style="color: #79740e">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79740e">}</span></span></span></code></pre></code><a name='gruvbox'><h2><a id='stylelink' href='gruvbox.html' alt='View only gruvbox'>gruvbox</a></h2></a><code><pre style="color: #ebdbb2; background-color: #282828;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #928374; font-style: italic">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #928374; font-style: italic">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #928374; font-style: italic">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #928374; font-style: italic">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #928374; font-style: italic">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #928374; font-style: italic">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #928374; font-style: italic">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #928374; font-style: italic">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #928374; font-style: italic">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #928374; font-style: italic">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #928374; font-style: italic">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span class="nv">version_string</span> <span style="color: #fe8019">=</span> <span style="color: #b8bb26">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #fe8019">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #fe8019">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #fe8019">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="nv">IOPRIO_WHO_PROCESS</span> <span style="color: #fe8019">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #fe8019">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">IOPRIO_CLASS_SHIFT</span> <span style="color: #fe8019">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">EX_EXEC_FAILED</span> <span style="color: #fe8019">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">EX_EXEC_ENOENT</span> <span style="color: #fe8019">=</span> 127<span class="p">;</span> // Could not find program to <span style="color: #fabd2f">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #fe8019">[]</span> <span style="color: #fe8019">=</span> <span style="color: #fe8019">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #fe8019">[</span>IOPRIO_CLASS_NONE<span style="color: #fe8019">]</span> <span style="color: #fe8019">=</span> <span style="color: #b8bb26">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #fe8019">[</span>IOPRIO_CLASS_RT<span style="color: #fe8019">]</span> <span style="color: #fe8019">=</span> <span style="color: #b8bb26">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #fe8019">[</span>IOPRIO_CLASS_BE<span style="color: #fe8019">]</span> <span style="color: #fe8019">=</span> <span style="color: #b8bb26">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #fe8019">[</span>IOPRIO_CLASS_IDLE<span style="color: #fe8019">]</span> <span style="color: #fe8019">=</span> <span style="color: #b8bb26">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #fe8019">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #fe8019">(</span>FILE* stream<span style="color: #fe8019">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #fe8019">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="nv">errno</span> <span style="color: #fe8019">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #fe8019">if</span> <span style="color: #fe8019">(</span>ferror<span style="color: #fe8019">(</span>stream<span style="color: #fe8019">)</span> !<span style="color: #fe8019">=</span> <span style="color: #d3869b">0</span> <span style="color: #fe8019">||</span> fflush<span style="color: #fe8019">(</span>stream<span style="color: #fe8019">)</span> !<span style="color: #fe8019">=</span> 0<span style="color: #fe8019">)</span> <span style="color: #fe8019">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #fe8019">return</span> <span style="color: #fe8019">(</span><span class="nv">errno</span> <span style="color: #fe8019">==</span> EBADF<span style="color: #fe8019">)</span> ? <span style="color: #d3869b">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #fe8019">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #fe8019">until</span> close. Calling fsync would <span style="color: #fabd2f">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #b8bb26">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    if (str == NULL || *str == &#39;</span><span style="color: #b8bb26">\0</span><span style="color: #b8bb26">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #b8bb26">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #b8bb26">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #b8bb26">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #b8bb26">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #b8bb26">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #b8bb26">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #b8bb26">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #b8bb26">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #b8bb26">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #b8bb26">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #b8bb26">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #b8bb26">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #b8bb26">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        case &#39;</span>n<span style="color: #b8bb26">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        case &#39;</span>c<span style="color: #b8bb26">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #b8bb26">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        case &#39;</span>p<span style="color: #b8bb26">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        case &#39;</span>P<span style="color: #b8bb26">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        case &#39;</span>u<span style="color: #b8bb26">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        case &#39;</span>t<span style="color: #b8bb26">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        case &#39;</span>V<span style="color: #b8bb26">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        case &#39;</span>h<span style="color: #b8bb26">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #b8bb26">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span class="err">&#39;</span> <span style="color: #fe8019">for</span> more information.<span style="color: #b8bb26">\n</span><span style="color: #b8bb26">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b8bb26">}</span></span></span></code></pre></code><a name='hr_high_contrast'><h2><a id='stylelink' href='hr_high_contrast.html' alt='View only hr_high_contrast'>hr_high_contrast</a></h2></a><code><pre style="color: #000000;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #5a8349">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #5a8349">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #5a8349">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #5a8349">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #5a8349">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #5a8349">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #5a8349">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #5a8349">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #5a8349">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #5a8349">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #5a8349">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #ffffff">version_string</span> <span style="color: #e4e400">=</span> <span style="color: #a87662">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #e4e400">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #e4e400">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #e4e400">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ffffff">IOPRIO_WHO_PROCESS</span> <span style="color: #e4e400">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #e4e400">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #ffffff">IOPRIO_CLASS_SHIFT</span> <span style="color: #e4e400">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #ffffff">EX_EXEC_FAILED</span> <span style="color: #e4e400">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #ffffff">EX_EXEC_ENOENT</span> <span style="color: #e4e400">=</span> 127<span class="p">;</span> // Could not find program to <span style="color: #ffffff">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #e4e400">[]</span> <span style="color: #e4e400">=</span> <span style="color: #e4e400">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #e4e400">[</span>IOPRIO_CLASS_NONE<span style="color: #e4e400">]</span> <span style="color: #e4e400">=</span> <span style="color: #a87662">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #e4e400">[</span>IOPRIO_CLASS_RT<span style="color: #e4e400">]</span> <span style="color: #e4e400">=</span> <span style="color: #a87662">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #e4e400">[</span>IOPRIO_CLASS_BE<span style="color: #e4e400">]</span> <span style="color: #e4e400">=</span> <span style="color: #a87662">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #e4e400">[</span>IOPRIO_CLASS_IDLE<span style="color: #e4e400">]</span> <span style="color: #e4e400">=</span> <span style="color: #a87662">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #e4e400">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #e4e400">(</span>FILE* stream<span style="color: #e4e400">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #e4e400">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ffffff">errno</span> <span style="color: #e4e400">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #467faf">if</span> <span style="color: #e4e400">(</span>ferror<span style="color: #e4e400">(</span>stream<span style="color: #e4e400">)</span> !<span style="color: #e4e400">=</span> <span style="color: #ffffff">0</span> <span style="color: #e4e400">||</span> fflush<span style="color: #e4e400">(</span>stream<span style="color: #e4e400">)</span> !<span style="color: #e4e400">=</span> 0<span style="color: #e4e400">)</span> <span style="color: #e4e400">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #467faf">return</span> <span style="color: #e4e400">(</span><span style="color: #ffffff">errno</span> <span style="color: #e4e400">==</span> EBADF<span style="color: #e4e400">)</span> ? <span style="color: #ffffff">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #e4e400">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #467faf">until</span> close. Calling fsync would <span style="color: #ffffff">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #a87662">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    if (str == NULL || *str == &#39;</span><span style="color: #a87662">\0</span><span style="color: #a87662">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #a87662">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #a87662">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #a87662">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #a87662">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #a87662">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #a87662">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #a87662">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #a87662">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #a87662">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #a87662">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #a87662">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #a87662">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #a87662">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        case &#39;</span>n<span style="color: #a87662">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        case &#39;</span>c<span style="color: #a87662">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #a87662">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        case &#39;</span>p<span style="color: #a87662">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        case &#39;</span>P<span style="color: #a87662">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        case &#39;</span>u<span style="color: #a87662">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        case &#39;</span>t<span style="color: #a87662">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        case &#39;</span>V<span style="color: #a87662">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        case &#39;</span>h<span style="color: #a87662">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #a87662">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span class="err">&#39;</span> <span style="color: #467faf">for</span> more information.<span style="color: #a87662">\n</span><span style="color: #a87662">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a87662">}</span></span></span></code></pre></code><a name='hrdark'><h2><a id='stylelink' href='hrdark.html' alt='View only hrdark'>hrdark</a></h2></a><code><pre style="color: #1d2432;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #828b96; font-style: italic">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #828b96; font-style: italic">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #828b96; font-style: italic">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #828b96; font-style: italic">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #828b96; font-style: italic">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #828b96; font-style: italic">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #828b96; font-style: italic">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #828b96; font-style: italic">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #828b96; font-style: italic">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #828b96; font-style: italic">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #828b96; font-style: italic">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #58a1dd">version_string</span> <span style="color: #ff636f">=</span> <span style="color: #a6be9d">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #ff636f">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ff636f">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #ff636f">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #58a1dd">IOPRIO_WHO_PROCESS</span> <span style="color: #ff636f">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ff636f">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #58a1dd">IOPRIO_CLASS_SHIFT</span> <span style="color: #ff636f">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #58a1dd">EX_EXEC_FAILED</span> <span style="color: #ff636f">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #58a1dd">EX_EXEC_ENOENT</span> <span style="color: #ff636f">=</span> 127<span class="p">;</span> // Could not find program to <span style="color: #58a1dd">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #ff636f">[]</span> <span style="color: #ff636f">=</span> <span style="color: #ff636f">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ff636f">[</span>IOPRIO_CLASS_NONE<span style="color: #ff636f">]</span> <span style="color: #ff636f">=</span> <span style="color: #a6be9d">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ff636f">[</span>IOPRIO_CLASS_RT<span style="color: #ff636f">]</span> <span style="color: #ff636f">=</span> <span style="color: #a6be9d">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ff636f">[</span>IOPRIO_CLASS_BE<span style="color: #ff636f">]</span> <span style="color: #ff636f">=</span> <span style="color: #a6be9d">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ff636f">[</span>IOPRIO_CLASS_IDLE<span style="color: #ff636f">]</span> <span style="color: #ff636f">=</span> <span style="color: #a6be9d">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ff636f">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #ff636f">(</span>FILE* stream<span style="color: #ff636f">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ff636f">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #58a1dd">errno</span> <span style="color: #ff636f">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ff636f">if</span> <span style="color: #ff636f">(</span>ferror<span style="color: #ff636f">(</span>stream<span style="color: #ff636f">)</span> !<span style="color: #ff636f">=</span> <span style="color: #a6be9d">0</span> <span style="color: #ff636f">||</span> fflush<span style="color: #ff636f">(</span>stream<span style="color: #ff636f">)</span> !<span style="color: #ff636f">=</span> 0<span style="color: #ff636f">)</span> <span style="color: #ff636f">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #ff636f">return</span> <span style="color: #ff636f">(</span><span style="color: #58a1dd">errno</span> <span style="color: #ff636f">==</span> EBADF<span style="color: #ff636f">)</span> ? <span style="color: #a6be9d">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ff636f">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #ff636f">until</span> close. Calling fsync would <span style="color: #58a1dd">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #a6be9d">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    if (str == NULL || *str == &#39;</span><span style="color: #a6be9d">\0</span><span style="color: #a6be9d">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #a6be9d">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #a6be9d">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #a6be9d">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #a6be9d">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #a6be9d">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #a6be9d">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #a6be9d">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #a6be9d">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #a6be9d">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #a6be9d">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #a6be9d">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #a6be9d">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #a6be9d">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        case &#39;</span>n<span style="color: #a6be9d">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        case &#39;</span>c<span style="color: #a6be9d">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #a6be9d">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        case &#39;</span>p<span style="color: #a6be9d">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        case &#39;</span>P<span style="color: #a6be9d">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        case &#39;</span>u<span style="color: #a6be9d">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        case &#39;</span>t<span style="color: #a6be9d">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        case &#39;</span>V<span style="color: #a6be9d">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        case &#39;</span>h<span style="color: #a6be9d">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #a6be9d">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span class="err">&#39;</span> <span style="color: #ff636f">for</span> more information.<span style="color: #a6be9d">\n</span><span style="color: #a6be9d">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a6be9d">}</span></span></span></code></pre></code><a name='igor'><h2><a id='stylelink' href='igor.html' alt='View only igor'>igor</a></h2></a><code><pre style="background-color: #ffffff;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ff0000; font-style: italic">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ff0000; font-style: italic">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ff0000; font-style: italic">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ff0000; font-style: italic">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ff0000; font-style: italic">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ff0000; font-style: italic">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ff0000; font-style: italic">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ff0000; font-style: italic">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ff0000; font-style: italic">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ff0000; font-style: italic">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ff0000; font-style: italic">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span class="nv">version_string</span> <span class="o">=</span> <span style="color: #009c00">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="nv">IOPRIO_WHO_PROCESS</span> <span class="o">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">IOPRIO_CLASS_SHIFT</span> <span class="o">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">EX_EXEC_FAILED</span> <span class="o">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">EX_EXEC_ENOENT</span> <span class="o">=</span> 127<span class="p">;</span> // Could not find program to <span class="nb">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span class="o">[]</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_NONE<span class="o">]</span> <span class="o">=</span> <span style="color: #009c00">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_RT<span class="o">]</span> <span class="o">=</span> <span style="color: #009c00">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_BE<span class="o">]</span> <span class="o">=</span> <span style="color: #009c00">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_IDLE<span class="o">]</span> <span class="o">=</span> <span style="color: #009c00">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span class="o">(</span>FILE* stream<span class="o">)</span>
</span></span><span style="display: flex;"><span class="cl"><span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="nv">errno</span> <span class="o">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #0000ff">if</span> <span class="o">(</span>ferror<span class="o">(</span>stream<span class="o">)</span> !<span class="o">=</span> <span class="m">0</span> <span class="o">||</span> fflush<span class="o">(</span>stream<span class="o">)</span> !<span class="o">=</span> 0<span class="o">)</span> <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #0000ff">return</span> <span class="o">(</span><span class="nv">errno</span> <span class="o">==</span> EBADF<span class="o">)</span> ? <span class="m">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="o">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #0000ff">until</span> close. Calling fsync would <span class="nb">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #009c00">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    if (str == NULL || *str == &#39;</span><span style="color: #009c00">\0</span><span style="color: #009c00">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #009c00">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #009c00">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #009c00">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #009c00">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #009c00">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #009c00">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #009c00">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #009c00">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #009c00">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #009c00">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #009c00">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #009c00">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #009c00">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        case &#39;</span>n<span style="color: #009c00">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        case &#39;</span>c<span style="color: #009c00">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #009c00">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        case &#39;</span>p<span style="color: #009c00">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        case &#39;</span>P<span style="color: #009c00">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        case &#39;</span>u<span style="color: #009c00">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        case &#39;</span>t<span style="color: #009c00">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        case &#39;</span>V<span style="color: #009c00">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        case &#39;</span>h<span style="color: #009c00">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #009c00">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span class="err">&#39;</span> <span style="color: #0000ff">for</span> more information.<span style="color: #009c00">\n</span><span style="color: #009c00">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #009c00">}</span></span></span></code></pre></code><a name='lovelace'><h2><a id='stylelink' href='lovelace.html' alt='View only lovelace'>lovelace</a></h2></a><code><pre style="background-color: #ffffff;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888; font-style: italic">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #b04040">version_string</span> <span style="color: #666666">=</span> <span style="color: #b83838">&#34;tinyionice 1.0.4&#34;</span><span style="color: #888888">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #666666">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #666666">}</span><span style="color: #888888">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #666666">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #b04040">IOPRIO_WHO_PROCESS</span> <span style="color: #666666">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #666666">}</span><span style="color: #888888">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #b04040">IOPRIO_CLASS_SHIFT</span> <span style="color: #666666">=</span> 13<span style="color: #888888">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #b04040">EX_EXEC_FAILED</span> <span style="color: #666666">=</span> 126<span style="color: #888888">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #b04040">EX_EXEC_ENOENT</span> <span style="color: #666666">=</span> 127<span style="color: #888888">;</span> // Could not find program to <span style="color: #388038">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #666666">[]</span> <span style="color: #666666">=</span> <span style="color: #666666">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #666666">[</span>IOPRIO_CLASS_NONE<span style="color: #666666">]</span> <span style="color: #666666">=</span> <span style="color: #b83838">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #666666">[</span>IOPRIO_CLASS_RT<span style="color: #666666">]</span> <span style="color: #666666">=</span> <span style="color: #b83838">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #666666">[</span>IOPRIO_CLASS_BE<span style="color: #666666">]</span> <span style="color: #666666">=</span> <span style="color: #b83838">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #666666">[</span>IOPRIO_CLASS_IDLE<span style="color: #666666">]</span> <span style="color: #666666">=</span> <span style="color: #b83838">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #666666">}</span><span style="color: #888888">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #666666">(</span>FILE* stream<span style="color: #666666">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #666666">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #b04040">errno</span> <span style="color: #666666">=</span> 0<span style="color: #888888">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #2838b0">if</span> <span style="color: #666666">(</span>ferror<span style="color: #666666">(</span>stream<span style="color: #666666">)</span> !<span style="color: #666666">=</span> <span style="color: #444444">0</span> <span style="color: #666666">||</span> fflush<span style="color: #666666">(</span>stream<span style="color: #666666">)</span> !<span style="color: #666666">=</span> 0<span style="color: #666666">)</span> <span style="color: #666666">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #2838b0">return</span> <span style="color: #666666">(</span><span style="color: #b04040">errno</span> <span style="color: #666666">==</span> EBADF<span style="color: #666666">)</span> ? <span style="color: #444444">0</span> : EOF<span style="color: #888888">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #666666">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #2838b0">until</span> close. Calling fsync would <span style="color: #388038">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #b83838">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    if (str == NULL || *str == &#39;</span><span style="color: #709030">\0</span><span style="color: #b83838">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #b83838">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #b83838">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #b83838">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #b83838">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #b83838">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #b83838">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #b83838">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #b83838">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #b83838">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #b83838">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #b83838">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #b83838">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #b83838">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        case &#39;</span>n<span style="color: #b83838">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        case &#39;</span>c<span style="color: #b83838">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #b83838">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        case &#39;</span>p<span style="color: #b83838">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        case &#39;</span>P<span style="color: #b83838">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        case &#39;</span>u<span style="color: #b83838">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        case &#39;</span>t<span style="color: #b83838">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        case &#39;</span>V<span style="color: #b83838">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        case &#39;</span>h<span style="color: #b83838">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #b83838">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="background-color: #a848a8">&#39;</span> <span style="color: #2838b0">for</span> more information.<span style="color: #709030">\n</span><span style="color: #b83838">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #b83838">}</span></span></span></code></pre></code><a name='manni'><h2><a id='stylelink' href='manni.html' alt='View only manni'>manni</a></h2></a><code><pre style="background-color: #f0f3f3;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #0099ff; font-style: italic">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #0099ff; font-style: italic">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #0099ff; font-style: italic">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #0099ff; font-style: italic">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #0099ff; font-style: italic">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #0099ff; font-style: italic">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #0099ff; font-style: italic">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #0099ff; font-style: italic">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #0099ff; font-style: italic">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #0099ff; font-style: italic">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #0099ff; font-style: italic">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #003333">version_string</span> <span style="color: #555555">=</span> <span style="color: #cc3300">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #555555">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #555555">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #555555">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #003333">IOPRIO_WHO_PROCESS</span> <span style="color: #555555">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #555555">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #003333">IOPRIO_CLASS_SHIFT</span> <span style="color: #555555">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #003333">EX_EXEC_FAILED</span> <span style="color: #555555">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #003333">EX_EXEC_ENOENT</span> <span style="color: #555555">=</span> 127<span class="p">;</span> // Could not find program to <span style="color: #336666">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #555555">[]</span> <span style="color: #555555">=</span> <span style="color: #555555">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #555555">[</span>IOPRIO_CLASS_NONE<span style="color: #555555">]</span> <span style="color: #555555">=</span> <span style="color: #cc3300">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #555555">[</span>IOPRIO_CLASS_RT<span style="color: #555555">]</span> <span style="color: #555555">=</span> <span style="color: #cc3300">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #555555">[</span>IOPRIO_CLASS_BE<span style="color: #555555">]</span> <span style="color: #555555">=</span> <span style="color: #cc3300">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #555555">[</span>IOPRIO_CLASS_IDLE<span style="color: #555555">]</span> <span style="color: #555555">=</span> <span style="color: #cc3300">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #555555">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #555555">(</span>FILE* stream<span style="color: #555555">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #555555">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #003333">errno</span> <span style="color: #555555">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #006699; font-weight: bold">if</span> <span style="color: #555555">(</span>ferror<span style="color: #555555">(</span>stream<span style="color: #555555">)</span> !<span style="color: #555555">=</span> <span style="color: #ff6600">0</span> <span style="color: #555555">||</span> fflush<span style="color: #555555">(</span>stream<span style="color: #555555">)</span> !<span style="color: #555555">=</span> 0<span style="color: #555555">)</span> <span style="color: #555555">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #006699; font-weight: bold">return</span> <span style="color: #555555">(</span><span style="color: #003333">errno</span> <span style="color: #555555">==</span> EBADF<span style="color: #555555">)</span> ? <span style="color: #ff6600">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #555555">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #006699; font-weight: bold">until</span> close. Calling fsync would <span style="color: #336666">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #cc3300">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    if (str == NULL || *str == &#39;</span><span style="color: #cc3300; font-weight: bold">\0</span><span style="color: #cc3300">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #cc3300">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #cc3300">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #cc3300">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #cc3300">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #cc3300">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #cc3300">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #cc3300">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #cc3300">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #cc3300">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #cc3300">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #cc3300">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #cc3300">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #cc3300">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        case &#39;</span>n<span style="color: #cc3300">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        case &#39;</span>c<span style="color: #cc3300">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #cc3300">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        case &#39;</span>p<span style="color: #cc3300">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        case &#39;</span>P<span style="color: #cc3300">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        case &#39;</span>u<span style="color: #cc3300">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        case &#39;</span>t<span style="color: #cc3300">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        case &#39;</span>V<span style="color: #cc3300">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        case &#39;</span>h<span style="color: #cc3300">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #cc3300">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #aa0000; background-color: #ffaaaa">&#39;</span> <span style="color: #006699; font-weight: bold">for</span> more information.<span style="color: #cc3300; font-weight: bold">\n</span><span style="color: #cc3300">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cc3300">}</span></span></span></code></pre></code><a name='modus-operandi'><h2><a id='stylelink' href='modus-operandi.html' alt='View only modus-operandi'>modus-operandi</a></h2></a><code><pre style="color: #000000; background-color: #ffffff;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #505050">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #505050">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #505050">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #505050">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #505050">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #505050">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #505050">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #505050">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #505050">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #505050">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #505050">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #00538b">version_string</span> <span style="color: #00538b">=</span> <span style="color: #2544bb">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #00538b">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #00538b">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #00538b">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #00538b">IOPRIO_WHO_PROCESS</span> <span style="color: #00538b">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #00538b">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #00538b">IOPRIO_CLASS_SHIFT</span> <span style="color: #00538b">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #00538b">EX_EXEC_FAILED</span> <span style="color: #00538b">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #00538b">EX_EXEC_ENOENT</span> <span style="color: #00538b">=</span> 127<span class="p">;</span> // Could not find program to <span style="color: #8f0075">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #00538b">[]</span> <span style="color: #00538b">=</span> <span style="color: #00538b">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #00538b">[</span>IOPRIO_CLASS_NONE<span style="color: #00538b">]</span> <span style="color: #00538b">=</span> <span style="color: #2544bb">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #00538b">[</span>IOPRIO_CLASS_RT<span style="color: #00538b">]</span> <span style="color: #00538b">=</span> <span style="color: #2544bb">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #00538b">[</span>IOPRIO_CLASS_BE<span style="color: #00538b">]</span> <span style="color: #00538b">=</span> <span style="color: #2544bb">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #00538b">[</span>IOPRIO_CLASS_IDLE<span style="color: #00538b">]</span> <span style="color: #00538b">=</span> <span style="color: #2544bb">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #00538b">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #00538b">(</span>FILE* stream<span style="color: #00538b">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #00538b">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #00538b">errno</span> <span style="color: #00538b">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #5317ac">if</span> <span style="color: #00538b">(</span>ferror<span style="color: #00538b">(</span>stream<span style="color: #00538b">)</span> !<span style="color: #00538b">=</span> <span style="color: #0000c0">0</span> <span style="color: #00538b">||</span> fflush<span style="color: #00538b">(</span>stream<span style="color: #00538b">)</span> !<span style="color: #00538b">=</span> 0<span style="color: #00538b">)</span> <span style="color: #00538b">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #5317ac">return</span> <span style="color: #00538b">(</span><span style="color: #00538b">errno</span> <span style="color: #00538b">==</span> EBADF<span style="color: #00538b">)</span> ? <span style="color: #0000c0">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #00538b">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #5317ac">until</span> close. Calling fsync would <span style="color: #8f0075">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #2544bb">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    if (str == NULL || *str == &#39;</span><span style="color: #2544bb">\0</span><span style="color: #2544bb">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #2544bb">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #2544bb">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #2544bb">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #2544bb">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #2544bb">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #2544bb">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #2544bb">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #2544bb">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #2544bb">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #2544bb">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #2544bb">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #2544bb">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #2544bb">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        case &#39;</span>n<span style="color: #2544bb">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        case &#39;</span>c<span style="color: #2544bb">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #2544bb">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        case &#39;</span>p<span style="color: #2544bb">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        case &#39;</span>P<span style="color: #2544bb">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        case &#39;</span>u<span style="color: #2544bb">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        case &#39;</span>t<span style="color: #2544bb">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        case &#39;</span>V<span style="color: #2544bb">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        case &#39;</span>h<span style="color: #2544bb">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #2544bb">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span class="err">&#39;</span> <span style="color: #5317ac">for</span> more information.<span style="color: #2544bb">\n</span><span style="color: #2544bb">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2544bb">}</span></span></span></code></pre></code><a name='modus-vivendi'><h2><a id='stylelink' href='modus-vivendi.html' alt='View only modus-vivendi'>modus-vivendi</a></h2></a><code><pre style="color: #ffffff; background-color: #000000;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #a8a8a8">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #a8a8a8">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #a8a8a8">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #a8a8a8">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #a8a8a8">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #a8a8a8">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #a8a8a8">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #a8a8a8">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #a8a8a8">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #a8a8a8">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #a8a8a8">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #00d3d0">version_string</span> <span style="color: #00d3d0">=</span> <span style="color: #79a8ff">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #00d3d0">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #00d3d0">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #00d3d0">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #00d3d0">IOPRIO_WHO_PROCESS</span> <span style="color: #00d3d0">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #00d3d0">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #00d3d0">IOPRIO_CLASS_SHIFT</span> <span style="color: #00d3d0">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #00d3d0">EX_EXEC_FAILED</span> <span style="color: #00d3d0">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #00d3d0">EX_EXEC_ENOENT</span> <span style="color: #00d3d0">=</span> 127<span class="p">;</span> // Could not find program to <span style="color: #f78fe7">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #00d3d0">[]</span> <span style="color: #00d3d0">=</span> <span style="color: #00d3d0">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #00d3d0">[</span>IOPRIO_CLASS_NONE<span style="color: #00d3d0">]</span> <span style="color: #00d3d0">=</span> <span style="color: #79a8ff">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #00d3d0">[</span>IOPRIO_CLASS_RT<span style="color: #00d3d0">]</span> <span style="color: #00d3d0">=</span> <span style="color: #79a8ff">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #00d3d0">[</span>IOPRIO_CLASS_BE<span style="color: #00d3d0">]</span> <span style="color: #00d3d0">=</span> <span style="color: #79a8ff">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #00d3d0">[</span>IOPRIO_CLASS_IDLE<span style="color: #00d3d0">]</span> <span style="color: #00d3d0">=</span> <span style="color: #79a8ff">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #00d3d0">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #00d3d0">(</span>FILE* stream<span style="color: #00d3d0">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #00d3d0">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #00d3d0">errno</span> <span style="color: #00d3d0">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #b6a0ff">if</span> <span style="color: #00d3d0">(</span>ferror<span style="color: #00d3d0">(</span>stream<span style="color: #00d3d0">)</span> !<span style="color: #00d3d0">=</span> <span style="color: #00bcff">0</span> <span style="color: #00d3d0">||</span> fflush<span style="color: #00d3d0">(</span>stream<span style="color: #00d3d0">)</span> !<span style="color: #00d3d0">=</span> 0<span style="color: #00d3d0">)</span> <span style="color: #00d3d0">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #b6a0ff">return</span> <span style="color: #00d3d0">(</span><span style="color: #00d3d0">errno</span> <span style="color: #00d3d0">==</span> EBADF<span style="color: #00d3d0">)</span> ? <span style="color: #00bcff">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #00d3d0">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #b6a0ff">until</span> close. Calling fsync would <span style="color: #f78fe7">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #79a8ff">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    if (str == NULL || *str == &#39;</span><span style="color: #79a8ff">\0</span><span style="color: #79a8ff">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #79a8ff">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #79a8ff">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #79a8ff">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #79a8ff">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #79a8ff">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #79a8ff">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #79a8ff">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #79a8ff">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #79a8ff">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #79a8ff">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #79a8ff">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #79a8ff">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #79a8ff">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        case &#39;</span>n<span style="color: #79a8ff">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        case &#39;</span>c<span style="color: #79a8ff">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #79a8ff">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        case &#39;</span>p<span style="color: #79a8ff">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        case &#39;</span>P<span style="color: #79a8ff">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        case &#39;</span>u<span style="color: #79a8ff">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        case &#39;</span>t<span style="color: #79a8ff">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        case &#39;</span>V<span style="color: #79a8ff">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        case &#39;</span>h<span style="color: #79a8ff">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #79a8ff">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span class="err">&#39;</span> <span style="color: #b6a0ff">for</span> more information.<span style="color: #79a8ff">\n</span><span style="color: #79a8ff">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #79a8ff">}</span></span></span></code></pre></code><a name='monokai'><h2><a id='stylelink' href='monokai.html' alt='View only monokai'>monokai</a></h2></a><code><pre style="color: #f8f8f2; background-color: #272822;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #75715e">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #75715e">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #75715e">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #75715e">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #75715e">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #75715e">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #75715e">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #75715e">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #75715e">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #75715e">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #75715e">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span class="nv">version_string</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #f92672">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #f92672">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #f92672">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="nv">IOPRIO_WHO_PROCESS</span> <span style="color: #f92672">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #f92672">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">IOPRIO_CLASS_SHIFT</span> <span style="color: #f92672">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">EX_EXEC_FAILED</span> <span style="color: #f92672">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">EX_EXEC_ENOENT</span> <span style="color: #f92672">=</span> 127<span class="p">;</span> // Could not find program to <span class="nb">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #f92672">[]</span> <span style="color: #f92672">=</span> <span style="color: #f92672">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #f92672">[</span>IOPRIO_CLASS_NONE<span style="color: #f92672">]</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #f92672">[</span>IOPRIO_CLASS_RT<span style="color: #f92672">]</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #f92672">[</span>IOPRIO_CLASS_BE<span style="color: #f92672">]</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #f92672">[</span>IOPRIO_CLASS_IDLE<span style="color: #f92672">]</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #f92672">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #f92672">(</span>FILE* stream<span style="color: #f92672">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #f92672">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="nv">errno</span> <span style="color: #f92672">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #66d9ef">if</span> <span style="color: #f92672">(</span>ferror<span style="color: #f92672">(</span>stream<span style="color: #f92672">)</span> !<span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span> <span style="color: #f92672">||</span> fflush<span style="color: #f92672">(</span>stream<span style="color: #f92672">)</span> !<span style="color: #f92672">=</span> 0<span style="color: #f92672">)</span> <span style="color: #f92672">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #66d9ef">return</span> <span style="color: #f92672">(</span><span class="nv">errno</span> <span style="color: #f92672">==</span> EBADF<span style="color: #f92672">)</span> ? <span style="color: #ae81ff">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #f92672">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #66d9ef">until</span> close. Calling fsync would <span class="nb">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #e6db74">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    if (str == NULL || *str == &#39;</span><span style="color: #ae81ff">\0</span><span style="color: #e6db74">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #e6db74">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #e6db74">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #e6db74">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #e6db74">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #e6db74">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #e6db74">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #e6db74">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #e6db74">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #e6db74">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #e6db74">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #e6db74">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #e6db74">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #e6db74">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        case &#39;</span>n<span style="color: #e6db74">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        case &#39;</span>c<span style="color: #e6db74">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #e6db74">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        case &#39;</span>p<span style="color: #e6db74">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        case &#39;</span>P<span style="color: #e6db74">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        case &#39;</span>u<span style="color: #e6db74">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        case &#39;</span>t<span style="color: #e6db74">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        case &#39;</span>V<span style="color: #e6db74">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        case &#39;</span>h<span style="color: #e6db74">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #e6db74">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #960050; background-color: #1e0010">&#39;</span> <span style="color: #66d9ef">for</span> more information.<span style="color: #ae81ff">\n</span><span style="color: #e6db74">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #e6db74">}</span></span></span></code></pre></code><a name='monokailight'><h2><a id='stylelink' href='monokailight.html' alt='View only monokailight'>monokailight</a></h2></a><code><pre style="color: #272822; background-color: #fafafa;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #75715e">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #75715e">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #75715e">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #75715e">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #75715e">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #75715e">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #75715e">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #75715e">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #75715e">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #75715e">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #75715e">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #111111">version_string</span> <span style="color: #f92672">=</span> <span style="color: #d88200">&#34;tinyionice 1.0.4&#34;</span><span style="color: #111111">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #f92672">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #f92672">}</span><span style="color: #111111">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #f92672">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #111111">IOPRIO_WHO_PROCESS</span> <span style="color: #f92672">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #f92672">}</span><span style="color: #111111">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #111111">IOPRIO_CLASS_SHIFT</span> <span style="color: #f92672">=</span> 13<span style="color: #111111">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #111111">EX_EXEC_FAILED</span> <span style="color: #f92672">=</span> 126<span style="color: #111111">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #111111">EX_EXEC_ENOENT</span> <span style="color: #f92672">=</span> 127<span style="color: #111111">;</span> // Could not find program to <span style="color: #111111">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #f92672">[]</span> <span style="color: #f92672">=</span> <span style="color: #f92672">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #f92672">[</span>IOPRIO_CLASS_NONE<span style="color: #f92672">]</span> <span style="color: #f92672">=</span> <span style="color: #d88200">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #f92672">[</span>IOPRIO_CLASS_RT<span style="color: #f92672">]</span> <span style="color: #f92672">=</span> <span style="color: #d88200">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #f92672">[</span>IOPRIO_CLASS_BE<span style="color: #f92672">]</span> <span style="color: #f92672">=</span> <span style="color: #d88200">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #f92672">[</span>IOPRIO_CLASS_IDLE<span style="color: #f92672">]</span> <span style="color: #f92672">=</span> <span style="color: #d88200">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #f92672">}</span><span style="color: #111111">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #f92672">(</span>FILE* stream<span style="color: #f92672">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #f92672">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #111111">errno</span> <span style="color: #f92672">=</span> 0<span style="color: #111111">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #00a8c8">if</span> <span style="color: #f92672">(</span>ferror<span style="color: #f92672">(</span>stream<span style="color: #f92672">)</span> !<span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span> <span style="color: #f92672">||</span> fflush<span style="color: #f92672">(</span>stream<span style="color: #f92672">)</span> !<span style="color: #f92672">=</span> 0<span style="color: #f92672">)</span> <span style="color: #f92672">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #00a8c8">return</span> <span style="color: #f92672">(</span><span style="color: #111111">errno</span> <span style="color: #f92672">==</span> EBADF<span style="color: #f92672">)</span> ? <span style="color: #ae81ff">0</span> : EOF<span style="color: #111111">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #f92672">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #00a8c8">until</span> close. Calling fsync would <span style="color: #111111">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #d88200">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    if (str == NULL || *str == &#39;</span><span style="color: #8045ff">\0</span><span style="color: #d88200">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #d88200">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #d88200">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #d88200">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #d88200">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #d88200">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #d88200">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #d88200">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #d88200">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #d88200">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #d88200">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #d88200">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #d88200">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #d88200">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        case &#39;</span>n<span style="color: #d88200">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        case &#39;</span>c<span style="color: #d88200">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #d88200">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        case &#39;</span>p<span style="color: #d88200">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        case &#39;</span>P<span style="color: #d88200">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        case &#39;</span>u<span style="color: #d88200">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        case &#39;</span>t<span style="color: #d88200">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        case &#39;</span>V<span style="color: #d88200">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        case &#39;</span>h<span style="color: #d88200">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #d88200">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #960050; background-color: #1e0010">&#39;</span> <span style="color: #00a8c8">for</span> more information.<span style="color: #8045ff">\n</span><span style="color: #d88200">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #d88200">}</span></span></span></code></pre></code><a name='murphy'><h2><a id='stylelink' href='murphy.html' alt='View only murphy'>murphy</a></h2></a><code><pre style="background-color: #ffffff;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #666666; font-style: italic">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #003366">version_string</span> <span style="color: #333333">=</span> <span style="background-color: #e0e0ff">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #333333">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #333333">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #333333">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #003366">IOPRIO_WHO_PROCESS</span> <span style="color: #333333">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #333333">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #003366">IOPRIO_CLASS_SHIFT</span> <span style="color: #333333">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #003366">EX_EXEC_FAILED</span> <span style="color: #333333">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #003366">EX_EXEC_ENOENT</span> <span style="color: #333333">=</span> 127<span class="p">;</span> // Could not find program to <span style="color: #007722">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #333333">[]</span> <span style="color: #333333">=</span> <span style="color: #333333">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #333333">[</span>IOPRIO_CLASS_NONE<span style="color: #333333">]</span> <span style="color: #333333">=</span> <span style="background-color: #e0e0ff">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #333333">[</span>IOPRIO_CLASS_RT<span style="color: #333333">]</span> <span style="color: #333333">=</span> <span style="background-color: #e0e0ff">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #333333">[</span>IOPRIO_CLASS_BE<span style="color: #333333">]</span> <span style="color: #333333">=</span> <span style="background-color: #e0e0ff">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #333333">[</span>IOPRIO_CLASS_IDLE<span style="color: #333333">]</span> <span style="color: #333333">=</span> <span style="background-color: #e0e0ff">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #333333">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #333333">(</span>FILE* stream<span style="color: #333333">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #333333">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #003366">errno</span> <span style="color: #333333">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #228899; font-weight: bold">if</span> <span style="color: #333333">(</span>ferror<span style="color: #333333">(</span>stream<span style="color: #333333">)</span> !<span style="color: #333333">=</span> <span style="color: #6600ee; font-weight: bold">0</span> <span style="color: #333333">||</span> fflush<span style="color: #333333">(</span>stream<span style="color: #333333">)</span> !<span style="color: #333333">=</span> 0<span style="color: #333333">)</span> <span style="color: #333333">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #228899; font-weight: bold">return</span> <span style="color: #333333">(</span><span style="color: #003366">errno</span> <span style="color: #333333">==</span> EBADF<span style="color: #333333">)</span> ? <span style="color: #6600ee; font-weight: bold">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #333333">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #228899; font-weight: bold">until</span> close. Calling fsync would <span style="color: #007722">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="background-color: #e0e0ff">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    if (str == NULL || *str == &#39;</span><span style="color: #666666; background-color: #e0e0ff; font-weight: bold">\0</span><span style="background-color: #e0e0ff">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="background-color: #e0e0ff">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="background-color: #e0e0ff">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="background-color: #e0e0ff">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="background-color: #e0e0ff">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="background-color: #e0e0ff">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="background-color: #e0e0ff">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="background-color: #e0e0ff">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="background-color: #e0e0ff">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="background-color: #e0e0ff">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="background-color: #e0e0ff">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="background-color: #e0e0ff">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="background-color: #e0e0ff">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="background-color: #e0e0ff">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        case &#39;</span>n<span style="background-color: #e0e0ff">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        case &#39;</span>c<span style="background-color: #e0e0ff">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="background-color: #e0e0ff">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        case &#39;</span>p<span style="background-color: #e0e0ff">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        case &#39;</span>P<span style="background-color: #e0e0ff">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        case &#39;</span>u<span style="background-color: #e0e0ff">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        case &#39;</span>t<span style="background-color: #e0e0ff">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        case &#39;</span>V<span style="background-color: #e0e0ff">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        case &#39;</span>h<span style="background-color: #e0e0ff">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="background-color: #e0e0ff">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #ff0000; background-color: #ffaaaa">&#39;</span> <span style="color: #228899; font-weight: bold">for</span> more information.<span style="color: #666666; background-color: #e0e0ff; font-weight: bold">\n</span><span style="background-color: #e0e0ff">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="background-color: #e0e0ff">}</span></span></span></code></pre></code><a name='native'><h2><a id='stylelink' href='native.html' alt='View only native'>native</a></h2></a><code><pre style="color: #d0d0d0; background-color: #202020;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #999999; font-style: italic">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #999999; font-style: italic">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #999999; font-style: italic">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #999999; font-style: italic">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #999999; font-style: italic">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #999999; font-style: italic">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #999999; font-style: italic">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #999999; font-style: italic">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #999999; font-style: italic">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #999999; font-style: italic">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #999999; font-style: italic">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #40ffff">version_string</span> <span class="o">=</span> <span style="color: #ed9d13">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #40ffff">IOPRIO_WHO_PROCESS</span> <span class="o">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #40ffff">IOPRIO_CLASS_SHIFT</span> <span class="o">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #40ffff">EX_EXEC_FAILED</span> <span class="o">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #40ffff">EX_EXEC_ENOENT</span> <span class="o">=</span> 127<span class="p">;</span> // Could not find program to <span style="color: #24909d">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span class="o">[]</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_NONE<span class="o">]</span> <span class="o">=</span> <span style="color: #ed9d13">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_RT<span class="o">]</span> <span class="o">=</span> <span style="color: #ed9d13">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_BE<span class="o">]</span> <span class="o">=</span> <span style="color: #ed9d13">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_IDLE<span class="o">]</span> <span class="o">=</span> <span style="color: #ed9d13">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span class="o">(</span>FILE* stream<span class="o">)</span>
</span></span><span style="display: flex;"><span class="cl"><span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #40ffff">errno</span> <span class="o">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #6ab825; font-weight: bold">if</span> <span class="o">(</span>ferror<span class="o">(</span>stream<span class="o">)</span> !<span class="o">=</span> <span style="color: #3677a9">0</span> <span class="o">||</span> fflush<span class="o">(</span>stream<span class="o">)</span> !<span class="o">=</span> 0<span class="o">)</span> <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #6ab825; font-weight: bold">return</span> <span class="o">(</span><span style="color: #40ffff">errno</span> <span class="o">==</span> EBADF<span class="o">)</span> ? <span style="color: #3677a9">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="o">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #6ab825; font-weight: bold">until</span> close. Calling fsync would <span style="color: #24909d">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #ed9d13">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    if (str == NULL || *str == &#39;</span><span style="color: #ed9d13">\0</span><span style="color: #ed9d13">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #ed9d13">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #ed9d13">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #ed9d13">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #ed9d13">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #ed9d13">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #ed9d13">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #ed9d13">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #ed9d13">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #ed9d13">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #ed9d13">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #ed9d13">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #ed9d13">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #ed9d13">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        case &#39;</span>n<span style="color: #ed9d13">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        case &#39;</span>c<span style="color: #ed9d13">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #ed9d13">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        case &#39;</span>p<span style="color: #ed9d13">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        case &#39;</span>P<span style="color: #ed9d13">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        case &#39;</span>u<span style="color: #ed9d13">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        case &#39;</span>t<span style="color: #ed9d13">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        case &#39;</span>V<span style="color: #ed9d13">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        case &#39;</span>h<span style="color: #ed9d13">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #ed9d13">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #a61717; background-color: #e3d2d2">&#39;</span> <span style="color: #6ab825; font-weight: bold">for</span> more information.<span style="color: #ed9d13">\n</span><span style="color: #ed9d13">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ed9d13">}</span></span></span></code></pre></code><a name='nord'><h2><a id='stylelink' href='nord.html' alt='View only nord'>nord</a></h2></a><code><pre style="color: #d8dee9; background-color: #2e3440;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #616e87; font-style: italic">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #616e87; font-style: italic">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #616e87; font-style: italic">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #616e87; font-style: italic">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #616e87; font-style: italic">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #616e87; font-style: italic">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #616e87; font-style: italic">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #616e87; font-style: italic">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #616e87; font-style: italic">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #616e87; font-style: italic">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #616e87; font-style: italic">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span class="nv">version_string</span> <span style="color: #81a1c1">=</span> <span style="color: #a3be8c">&#34;tinyionice 1.0.4&#34;</span><span style="color: #eceff4">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #81a1c1">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #81a1c1">}</span><span style="color: #eceff4">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #81a1c1">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="nv">IOPRIO_WHO_PROCESS</span> <span style="color: #81a1c1">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #81a1c1">}</span><span style="color: #eceff4">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">IOPRIO_CLASS_SHIFT</span> <span style="color: #81a1c1">=</span> 13<span style="color: #eceff4">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">EX_EXEC_FAILED</span> <span style="color: #81a1c1">=</span> 126<span style="color: #eceff4">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">EX_EXEC_ENOENT</span> <span style="color: #81a1c1">=</span> 127<span style="color: #eceff4">;</span> // Could not find program to <span style="color: #81a1c1">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #81a1c1">[]</span> <span style="color: #81a1c1">=</span> <span style="color: #81a1c1">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #81a1c1">[</span>IOPRIO_CLASS_NONE<span style="color: #81a1c1">]</span> <span style="color: #81a1c1">=</span> <span style="color: #a3be8c">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #81a1c1">[</span>IOPRIO_CLASS_RT<span style="color: #81a1c1">]</span> <span style="color: #81a1c1">=</span> <span style="color: #a3be8c">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #81a1c1">[</span>IOPRIO_CLASS_BE<span style="color: #81a1c1">]</span> <span style="color: #81a1c1">=</span> <span style="color: #a3be8c">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #81a1c1">[</span>IOPRIO_CLASS_IDLE<span style="color: #81a1c1">]</span> <span style="color: #81a1c1">=</span> <span style="color: #a3be8c">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #81a1c1">}</span><span style="color: #eceff4">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #81a1c1">(</span>FILE* stream<span style="color: #81a1c1">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #81a1c1">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="nv">errno</span> <span style="color: #81a1c1">=</span> 0<span style="color: #eceff4">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #81a1c1; font-weight: bold">if</span> <span style="color: #81a1c1">(</span>ferror<span style="color: #81a1c1">(</span>stream<span style="color: #81a1c1">)</span> !<span style="color: #81a1c1">=</span> <span style="color: #b48ead">0</span> <span style="color: #81a1c1">||</span> fflush<span style="color: #81a1c1">(</span>stream<span style="color: #81a1c1">)</span> !<span style="color: #81a1c1">=</span> 0<span style="color: #81a1c1">)</span> <span style="color: #81a1c1">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #81a1c1; font-weight: bold">return</span> <span style="color: #81a1c1">(</span><span class="nv">errno</span> <span style="color: #81a1c1">==</span> EBADF<span style="color: #81a1c1">)</span> ? <span style="color: #b48ead">0</span> : EOF<span style="color: #eceff4">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #81a1c1">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #81a1c1; font-weight: bold">until</span> close. Calling fsync would <span style="color: #81a1c1">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #a3be8c">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    if (str == NULL || *str == &#39;</span><span style="color: #ebcb8b">\0</span><span style="color: #a3be8c">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #a3be8c">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #a3be8c">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #a3be8c">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #a3be8c">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #a3be8c">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #a3be8c">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #a3be8c">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #a3be8c">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #a3be8c">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #a3be8c">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #a3be8c">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #a3be8c">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #a3be8c">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        case &#39;</span>n<span style="color: #a3be8c">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        case &#39;</span>c<span style="color: #a3be8c">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #a3be8c">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        case &#39;</span>p<span style="color: #a3be8c">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        case &#39;</span>P<span style="color: #a3be8c">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        case &#39;</span>u<span style="color: #a3be8c">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        case &#39;</span>t<span style="color: #a3be8c">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        case &#39;</span>V<span style="color: #a3be8c">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        case &#39;</span>h<span style="color: #a3be8c">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #a3be8c">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #bf616a">&#39;</span> <span style="color: #81a1c1; font-weight: bold">for</span> more information.<span style="color: #ebcb8b">\n</span><span style="color: #a3be8c">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a3be8c">}</span></span></span></code></pre></code><a name='onedark'><h2><a id='stylelink' href='onedark.html' alt='View only onedark'>onedark</a></h2></a><code><pre style="color: #abb2bf; background-color: #282c34;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #7f848e">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #7f848e">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #7f848e">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #7f848e">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #7f848e">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #7f848e">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #7f848e">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #7f848e">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #7f848e">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #7f848e">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #7f848e">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #e06c75">version_string</span> <span style="color: #56b6c2">=</span> <span style="color: #98c379">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #56b6c2">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #56b6c2">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #56b6c2">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #e06c75">IOPRIO_WHO_PROCESS</span> <span style="color: #56b6c2">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #56b6c2">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #e06c75">IOPRIO_CLASS_SHIFT</span> <span style="color: #56b6c2">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #e06c75">EX_EXEC_FAILED</span> <span style="color: #56b6c2">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #e06c75">EX_EXEC_ENOENT</span> <span style="color: #56b6c2">=</span> 127<span class="p">;</span> // Could not find program to <span style="color: #e5c07b">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #56b6c2">[]</span> <span style="color: #56b6c2">=</span> <span style="color: #56b6c2">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #56b6c2">[</span>IOPRIO_CLASS_NONE<span style="color: #56b6c2">]</span> <span style="color: #56b6c2">=</span> <span style="color: #98c379">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #56b6c2">[</span>IOPRIO_CLASS_RT<span style="color: #56b6c2">]</span> <span style="color: #56b6c2">=</span> <span style="color: #98c379">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #56b6c2">[</span>IOPRIO_CLASS_BE<span style="color: #56b6c2">]</span> <span style="color: #56b6c2">=</span> <span style="color: #98c379">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #56b6c2">[</span>IOPRIO_CLASS_IDLE<span style="color: #56b6c2">]</span> <span style="color: #56b6c2">=</span> <span style="color: #98c379">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #56b6c2">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #56b6c2">(</span>FILE* stream<span style="color: #56b6c2">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #56b6c2">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #e06c75">errno</span> <span style="color: #56b6c2">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #c678dd">if</span> <span style="color: #56b6c2">(</span>ferror<span style="color: #56b6c2">(</span>stream<span style="color: #56b6c2">)</span> !<span style="color: #56b6c2">=</span> <span style="color: #d19a66">0</span> <span style="color: #56b6c2">||</span> fflush<span style="color: #56b6c2">(</span>stream<span style="color: #56b6c2">)</span> !<span style="color: #56b6c2">=</span> 0<span style="color: #56b6c2">)</span> <span style="color: #56b6c2">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #c678dd">return</span> <span style="color: #56b6c2">(</span><span style="color: #e06c75">errno</span> <span style="color: #56b6c2">==</span> EBADF<span style="color: #56b6c2">)</span> ? <span style="color: #d19a66">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #56b6c2">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #c678dd">until</span> close. Calling fsync would <span style="color: #e5c07b">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #98c379">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    if (str == NULL || *str == &#39;</span><span style="color: #98c379">\0</span><span style="color: #98c379">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #98c379">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #98c379">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #98c379">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #98c379">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #98c379">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #98c379">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #98c379">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #98c379">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #98c379">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #98c379">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #98c379">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #98c379">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #98c379">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        case &#39;</span>n<span style="color: #98c379">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        case &#39;</span>c<span style="color: #98c379">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #98c379">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        case &#39;</span>p<span style="color: #98c379">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        case &#39;</span>P<span style="color: #98c379">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        case &#39;</span>u<span style="color: #98c379">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        case &#39;</span>t<span style="color: #98c379">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        case &#39;</span>V<span style="color: #98c379">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        case &#39;</span>h<span style="color: #98c379">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #98c379">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span class="err">&#39;</span> <span style="color: #c678dd">for</span> more information.<span style="color: #98c379">\n</span><span style="color: #98c379">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #98c379">}</span></span></span></code></pre></code><a name='onesenterprise'><h2><a id='stylelink' href='onesenterprise.html' alt='View only onesenterprise'>onesenterprise</a></h2></a><code><pre style="color: #000000;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008000">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008000">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008000">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008000">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008000">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008000">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008000">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008000">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008000">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008000">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008000">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #0000ff">version_string</span> <span style="color: #ff0000">=</span> <span class="s2">&#34;tinyionice 1.0.4&#34;</span><span style="color: #ff0000">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #ff0000">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ff0000">}</span><span style="color: #ff0000">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #ff0000">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #0000ff">IOPRIO_WHO_PROCESS</span> <span style="color: #ff0000">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ff0000">}</span><span style="color: #ff0000">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #0000ff">IOPRIO_CLASS_SHIFT</span> <span style="color: #ff0000">=</span> 13<span style="color: #ff0000">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #0000ff">EX_EXEC_FAILED</span> <span style="color: #ff0000">=</span> 126<span style="color: #ff0000">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #0000ff">EX_EXEC_ENOENT</span> <span style="color: #ff0000">=</span> 127<span style="color: #ff0000">;</span> // Could not find program to <span style="color: #0000ff">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #ff0000">[]</span> <span style="color: #ff0000">=</span> <span style="color: #ff0000">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ff0000">[</span>IOPRIO_CLASS_NONE<span style="color: #ff0000">]</span> <span style="color: #ff0000">=</span> <span class="s2">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ff0000">[</span>IOPRIO_CLASS_RT<span style="color: #ff0000">]</span> <span style="color: #ff0000">=</span> <span class="s2">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ff0000">[</span>IOPRIO_CLASS_BE<span style="color: #ff0000">]</span> <span style="color: #ff0000">=</span> <span class="s2">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ff0000">[</span>IOPRIO_CLASS_IDLE<span style="color: #ff0000">]</span> <span style="color: #ff0000">=</span> <span class="s2">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ff0000">}</span><span style="color: #ff0000">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #ff0000">(</span>FILE* stream<span style="color: #ff0000">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ff0000">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #0000ff">errno</span> <span style="color: #ff0000">=</span> 0<span style="color: #ff0000">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ff0000">if</span> <span style="color: #ff0000">(</span>ferror<span style="color: #ff0000">(</span>stream<span style="color: #ff0000">)</span> !<span style="color: #ff0000">=</span> <span class="m">0</span> <span style="color: #ff0000">||</span> fflush<span style="color: #ff0000">(</span>stream<span style="color: #ff0000">)</span> !<span style="color: #ff0000">=</span> 0<span style="color: #ff0000">)</span> <span style="color: #ff0000">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #ff0000">return</span> <span style="color: #ff0000">(</span><span style="color: #0000ff">errno</span> <span style="color: #ff0000">==</span> EBADF<span style="color: #ff0000">)</span> ? <span class="m">0</span> : EOF<span style="color: #ff0000">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ff0000">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #ff0000">until</span> close. Calling fsync would <span style="color: #0000ff">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span class="s1">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">     */
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    }
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">}
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">{
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        }
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    }
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">}
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">{
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    if (str == NULL || *str == &#39;</span><span class="se">\0</span><span class="s1">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span class="s1">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        }
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span class="s1">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    }
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span class="s1">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        }
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span class="s1">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    }
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">}
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">{
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span class="s1">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    }
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">}
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">{
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">}
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">{
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">}
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">{
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">}
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">{
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">}
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">{
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        }
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    }
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">}
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">{
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    }
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    }
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    }
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">}
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">{
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    }
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">}
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">{
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">}
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">{
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span class="s1">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span class="s1">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span class="s1">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span class="s1">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span class="s1">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span class="s1">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span class="s1">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span class="s1">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    };
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        case &#39;</span>n<span class="s1">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        case &#39;</span>c<span class="s1">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span class="s1">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">                }
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            }
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        case &#39;</span>p<span class="s1">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            }
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        case &#39;</span>P<span class="s1">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            }
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        case &#39;</span>u<span class="s1">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            }
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        case &#39;</span>t<span class="s1">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        case &#39;</span>V<span class="s1">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        case &#39;</span>h<span class="s1">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span class="s1">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        }
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        }
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        }
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        }
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    }
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        }
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        }
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s1">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span class="err">&#39;</span> <span style="color: #ff0000">for</span> more information.<span class="se">\n</span><span class="s2">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s2">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span class="s2">    }
</span></span></span><span style="display: flex;"><span class="cl"><span class="s2">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span class="s2">}</span></span></span></code></pre></code><a name='paraiso-dark'><h2><a id='stylelink' href='paraiso-dark.html' alt='View only paraiso-dark'>paraiso-dark</a></h2></a><code><pre style="color: #e7e9db; background-color: #2f1e2e;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #776e71">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #776e71">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #776e71">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #776e71">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #776e71">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #776e71">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #776e71">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #776e71">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #776e71">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #776e71">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #776e71">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #ef6155">version_string</span> <span style="color: #5bc4bf">=</span> <span style="color: #48b685">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #5bc4bf">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #5bc4bf">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #5bc4bf">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ef6155">IOPRIO_WHO_PROCESS</span> <span style="color: #5bc4bf">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #5bc4bf">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #ef6155">IOPRIO_CLASS_SHIFT</span> <span style="color: #5bc4bf">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #ef6155">EX_EXEC_FAILED</span> <span style="color: #5bc4bf">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #ef6155">EX_EXEC_ENOENT</span> <span style="color: #5bc4bf">=</span> 127<span class="p">;</span> // Could not find program to <span class="nb">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #5bc4bf">[]</span> <span style="color: #5bc4bf">=</span> <span style="color: #5bc4bf">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #5bc4bf">[</span>IOPRIO_CLASS_NONE<span style="color: #5bc4bf">]</span> <span style="color: #5bc4bf">=</span> <span style="color: #48b685">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #5bc4bf">[</span>IOPRIO_CLASS_RT<span style="color: #5bc4bf">]</span> <span style="color: #5bc4bf">=</span> <span style="color: #48b685">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #5bc4bf">[</span>IOPRIO_CLASS_BE<span style="color: #5bc4bf">]</span> <span style="color: #5bc4bf">=</span> <span style="color: #48b685">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #5bc4bf">[</span>IOPRIO_CLASS_IDLE<span style="color: #5bc4bf">]</span> <span style="color: #5bc4bf">=</span> <span style="color: #48b685">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #5bc4bf">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #5bc4bf">(</span>FILE* stream<span style="color: #5bc4bf">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #5bc4bf">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ef6155">errno</span> <span style="color: #5bc4bf">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #815ba4">if</span> <span style="color: #5bc4bf">(</span>ferror<span style="color: #5bc4bf">(</span>stream<span style="color: #5bc4bf">)</span> !<span style="color: #5bc4bf">=</span> <span style="color: #f99b15">0</span> <span style="color: #5bc4bf">||</span> fflush<span style="color: #5bc4bf">(</span>stream<span style="color: #5bc4bf">)</span> !<span style="color: #5bc4bf">=</span> 0<span style="color: #5bc4bf">)</span> <span style="color: #5bc4bf">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #815ba4">return</span> <span style="color: #5bc4bf">(</span><span style="color: #ef6155">errno</span> <span style="color: #5bc4bf">==</span> EBADF<span style="color: #5bc4bf">)</span> ? <span style="color: #f99b15">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #5bc4bf">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #815ba4">until</span> close. Calling fsync would <span class="nb">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #48b685">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    if (str == NULL || *str == &#39;</span><span style="color: #f99b15">\0</span><span style="color: #48b685">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #48b685">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #48b685">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #48b685">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #48b685">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #48b685">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #48b685">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #48b685">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #48b685">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #48b685">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #48b685">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #48b685">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #48b685">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #48b685">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        case &#39;</span>n<span style="color: #48b685">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        case &#39;</span>c<span style="color: #48b685">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #48b685">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        case &#39;</span>p<span style="color: #48b685">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        case &#39;</span>P<span style="color: #48b685">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        case &#39;</span>u<span style="color: #48b685">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        case &#39;</span>t<span style="color: #48b685">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        case &#39;</span>V<span style="color: #48b685">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        case &#39;</span>h<span style="color: #48b685">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #48b685">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #ef6155">&#39;</span> <span style="color: #815ba4">for</span> more information.<span style="color: #f99b15">\n</span><span style="color: #48b685">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">}</span></span></span></code></pre></code><a name='paraiso-light'><h2><a id='stylelink' href='paraiso-light.html' alt='View only paraiso-light'>paraiso-light</a></h2></a><code><pre style="color: #2f1e2e; background-color: #e7e9db;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8d8687">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8d8687">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8d8687">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8d8687">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8d8687">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8d8687">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8d8687">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8d8687">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8d8687">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8d8687">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8d8687">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #ef6155">version_string</span> <span style="color: #5bc4bf">=</span> <span style="color: #48b685">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #5bc4bf">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #5bc4bf">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #5bc4bf">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ef6155">IOPRIO_WHO_PROCESS</span> <span style="color: #5bc4bf">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #5bc4bf">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #ef6155">IOPRIO_CLASS_SHIFT</span> <span style="color: #5bc4bf">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #ef6155">EX_EXEC_FAILED</span> <span style="color: #5bc4bf">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #ef6155">EX_EXEC_ENOENT</span> <span style="color: #5bc4bf">=</span> 127<span class="p">;</span> // Could not find program to <span class="nb">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #5bc4bf">[]</span> <span style="color: #5bc4bf">=</span> <span style="color: #5bc4bf">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #5bc4bf">[</span>IOPRIO_CLASS_NONE<span style="color: #5bc4bf">]</span> <span style="color: #5bc4bf">=</span> <span style="color: #48b685">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #5bc4bf">[</span>IOPRIO_CLASS_RT<span style="color: #5bc4bf">]</span> <span style="color: #5bc4bf">=</span> <span style="color: #48b685">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #5bc4bf">[</span>IOPRIO_CLASS_BE<span style="color: #5bc4bf">]</span> <span style="color: #5bc4bf">=</span> <span style="color: #48b685">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #5bc4bf">[</span>IOPRIO_CLASS_IDLE<span style="color: #5bc4bf">]</span> <span style="color: #5bc4bf">=</span> <span style="color: #48b685">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #5bc4bf">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #5bc4bf">(</span>FILE* stream<span style="color: #5bc4bf">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #5bc4bf">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ef6155">errno</span> <span style="color: #5bc4bf">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #815ba4">if</span> <span style="color: #5bc4bf">(</span>ferror<span style="color: #5bc4bf">(</span>stream<span style="color: #5bc4bf">)</span> !<span style="color: #5bc4bf">=</span> <span style="color: #f99b15">0</span> <span style="color: #5bc4bf">||</span> fflush<span style="color: #5bc4bf">(</span>stream<span style="color: #5bc4bf">)</span> !<span style="color: #5bc4bf">=</span> 0<span style="color: #5bc4bf">)</span> <span style="color: #5bc4bf">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #815ba4">return</span> <span style="color: #5bc4bf">(</span><span style="color: #ef6155">errno</span> <span style="color: #5bc4bf">==</span> EBADF<span style="color: #5bc4bf">)</span> ? <span style="color: #f99b15">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #5bc4bf">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #815ba4">until</span> close. Calling fsync would <span class="nb">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #48b685">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    if (str == NULL || *str == &#39;</span><span style="color: #f99b15">\0</span><span style="color: #48b685">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #48b685">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #48b685">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #48b685">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #48b685">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #48b685">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #48b685">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #48b685">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #48b685">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #48b685">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #48b685">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #48b685">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #48b685">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #48b685">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        case &#39;</span>n<span style="color: #48b685">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        case &#39;</span>c<span style="color: #48b685">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #48b685">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        case &#39;</span>p<span style="color: #48b685">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        case &#39;</span>P<span style="color: #48b685">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        case &#39;</span>u<span style="color: #48b685">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        case &#39;</span>t<span style="color: #48b685">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        case &#39;</span>V<span style="color: #48b685">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        case &#39;</span>h<span style="color: #48b685">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #48b685">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #ef6155">&#39;</span> <span style="color: #815ba4">for</span> more information.<span style="color: #f99b15">\n</span><span style="color: #48b685">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #48b685">}</span></span></span></code></pre></code><a name='pastie'><h2><a id='stylelink' href='pastie.html' alt='View only pastie'>pastie</a></h2></a><code><pre style="background-color: #ffffff;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #888888">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #336699">version_string</span> <span class="o">=</span> <span style="color: #dd2200; background-color: #fff0f0">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #336699">IOPRIO_WHO_PROCESS</span> <span class="o">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #336699">IOPRIO_CLASS_SHIFT</span> <span class="o">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #336699">EX_EXEC_FAILED</span> <span class="o">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #336699">EX_EXEC_ENOENT</span> <span class="o">=</span> 127<span class="p">;</span> // Could not find program to <span style="color: #003388">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span class="o">[]</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_NONE<span class="o">]</span> <span class="o">=</span> <span style="color: #dd2200; background-color: #fff0f0">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_RT<span class="o">]</span> <span class="o">=</span> <span style="color: #dd2200; background-color: #fff0f0">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_BE<span class="o">]</span> <span class="o">=</span> <span style="color: #dd2200; background-color: #fff0f0">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_IDLE<span class="o">]</span> <span class="o">=</span> <span style="color: #dd2200; background-color: #fff0f0">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span class="o">(</span>FILE* stream<span class="o">)</span>
</span></span><span style="display: flex;"><span class="cl"><span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #336699">errno</span> <span class="o">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #008800; font-weight: bold">if</span> <span class="o">(</span>ferror<span class="o">(</span>stream<span class="o">)</span> !<span class="o">=</span> <span style="color: #0000dd; font-weight: bold">0</span> <span class="o">||</span> fflush<span class="o">(</span>stream<span class="o">)</span> !<span class="o">=</span> 0<span class="o">)</span> <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #008800; font-weight: bold">return</span> <span class="o">(</span><span style="color: #336699">errno</span> <span class="o">==</span> EBADF<span class="o">)</span> ? <span style="color: #0000dd; font-weight: bold">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="o">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #008800; font-weight: bold">until</span> close. Calling fsync would <span style="color: #003388">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #dd2200; background-color: #fff0f0">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    if (str == NULL || *str == &#39;</span><span style="color: #0044dd; background-color: #fff0f0">\0</span><span style="color: #dd2200; background-color: #fff0f0">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #dd2200; background-color: #fff0f0">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #dd2200; background-color: #fff0f0">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #dd2200; background-color: #fff0f0">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #dd2200; background-color: #fff0f0">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #dd2200; background-color: #fff0f0">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #dd2200; background-color: #fff0f0">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #dd2200; background-color: #fff0f0">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #dd2200; background-color: #fff0f0">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #dd2200; background-color: #fff0f0">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #dd2200; background-color: #fff0f0">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #dd2200; background-color: #fff0f0">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #dd2200; background-color: #fff0f0">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #dd2200; background-color: #fff0f0">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        case &#39;</span>n<span style="color: #dd2200; background-color: #fff0f0">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        case &#39;</span>c<span style="color: #dd2200; background-color: #fff0f0">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #dd2200; background-color: #fff0f0">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        case &#39;</span>p<span style="color: #dd2200; background-color: #fff0f0">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        case &#39;</span>P<span style="color: #dd2200; background-color: #fff0f0">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        case &#39;</span>u<span style="color: #dd2200; background-color: #fff0f0">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        case &#39;</span>t<span style="color: #dd2200; background-color: #fff0f0">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        case &#39;</span>V<span style="color: #dd2200; background-color: #fff0f0">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        case &#39;</span>h<span style="color: #dd2200; background-color: #fff0f0">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #dd2200; background-color: #fff0f0">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #a61717; background-color: #e3d2d2">&#39;</span> <span style="color: #008800; font-weight: bold">for</span> more information.<span style="color: #0044dd; background-color: #fff0f0">\n</span><span style="color: #dd2200; background-color: #fff0f0">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #dd2200; background-color: #fff0f0">}</span></span></span></code></pre></code><a name='perldoc'><h2><a id='stylelink' href='perldoc.html' alt='View only perldoc'>perldoc</a></h2></a><code><pre style="background-color: #eeeedd;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #228b22">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #228b22">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #228b22">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #228b22">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #228b22">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #228b22">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #228b22">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #228b22">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #228b22">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #228b22">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #228b22">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #00688b">version_string</span> <span class="o">=</span> <span style="color: #cd5555">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #00688b">IOPRIO_WHO_PROCESS</span> <span class="o">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #00688b">IOPRIO_CLASS_SHIFT</span> <span class="o">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #00688b">EX_EXEC_FAILED</span> <span class="o">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #00688b">EX_EXEC_ENOENT</span> <span class="o">=</span> 127<span class="p">;</span> // Could not find program to <span style="color: #658b00">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span class="o">[]</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_NONE<span class="o">]</span> <span class="o">=</span> <span style="color: #cd5555">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_RT<span class="o">]</span> <span class="o">=</span> <span style="color: #cd5555">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_BE<span class="o">]</span> <span class="o">=</span> <span style="color: #cd5555">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_IDLE<span class="o">]</span> <span class="o">=</span> <span style="color: #cd5555">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span class="o">(</span>FILE* stream<span class="o">)</span>
</span></span><span style="display: flex;"><span class="cl"><span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #00688b">errno</span> <span class="o">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #8b008b; font-weight: bold">if</span> <span class="o">(</span>ferror<span class="o">(</span>stream<span class="o">)</span> !<span class="o">=</span> <span style="color: #b452cd">0</span> <span class="o">||</span> fflush<span class="o">(</span>stream<span class="o">)</span> !<span class="o">=</span> 0<span class="o">)</span> <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #8b008b; font-weight: bold">return</span> <span class="o">(</span><span style="color: #00688b">errno</span> <span class="o">==</span> EBADF<span class="o">)</span> ? <span style="color: #b452cd">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="o">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #8b008b; font-weight: bold">until</span> close. Calling fsync would <span style="color: #658b00">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #cd5555">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    if (str == NULL || *str == &#39;</span><span style="color: #cd5555">\0</span><span style="color: #cd5555">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #cd5555">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #cd5555">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #cd5555">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #cd5555">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #cd5555">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #cd5555">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #cd5555">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #cd5555">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #cd5555">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #cd5555">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #cd5555">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #cd5555">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #cd5555">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        case &#39;</span>n<span style="color: #cd5555">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        case &#39;</span>c<span style="color: #cd5555">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #cd5555">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        case &#39;</span>p<span style="color: #cd5555">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        case &#39;</span>P<span style="color: #cd5555">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        case &#39;</span>u<span style="color: #cd5555">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        case &#39;</span>t<span style="color: #cd5555">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        case &#39;</span>V<span style="color: #cd5555">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        case &#39;</span>h<span style="color: #cd5555">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #cd5555">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #a61717; background-color: #e3d2d2">&#39;</span> <span style="color: #8b008b; font-weight: bold">for</span> more information.<span style="color: #cd5555">\n</span><span style="color: #cd5555">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd5555">}</span></span></span></code></pre></code><a name='pygments'><h2><a id='stylelink' href='pygments.html' alt='View only pygments'>pygments</a></h2></a><code><pre style=";" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #408080; font-style: italic">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #408080; font-style: italic">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #408080; font-style: italic">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #408080; font-style: italic">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #408080; font-style: italic">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #408080; font-style: italic">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #408080; font-style: italic">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #408080; font-style: italic">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #408080; font-style: italic">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #408080; font-style: italic">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #408080; font-style: italic">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #19177c">version_string</span> <span style="color: #666666">=</span> <span style="color: #ba2121">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #666666">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #666666">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #666666">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #19177c">IOPRIO_WHO_PROCESS</span> <span style="color: #666666">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #666666">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #19177c">IOPRIO_CLASS_SHIFT</span> <span style="color: #666666">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #19177c">EX_EXEC_FAILED</span> <span style="color: #666666">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #19177c">EX_EXEC_ENOENT</span> <span style="color: #666666">=</span> 127<span class="p">;</span> // Could not find program to <span style="color: #008000">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #666666">[]</span> <span style="color: #666666">=</span> <span style="color: #666666">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #666666">[</span>IOPRIO_CLASS_NONE<span style="color: #666666">]</span> <span style="color: #666666">=</span> <span style="color: #ba2121">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #666666">[</span>IOPRIO_CLASS_RT<span style="color: #666666">]</span> <span style="color: #666666">=</span> <span style="color: #ba2121">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #666666">[</span>IOPRIO_CLASS_BE<span style="color: #666666">]</span> <span style="color: #666666">=</span> <span style="color: #ba2121">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #666666">[</span>IOPRIO_CLASS_IDLE<span style="color: #666666">]</span> <span style="color: #666666">=</span> <span style="color: #ba2121">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #666666">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #666666">(</span>FILE* stream<span style="color: #666666">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #666666">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #19177c">errno</span> <span style="color: #666666">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">(</span>ferror<span style="color: #666666">(</span>stream<span style="color: #666666">)</span> !<span style="color: #666666">=</span> <span style="color: #666666">0</span> <span style="color: #666666">||</span> fflush<span style="color: #666666">(</span>stream<span style="color: #666666">)</span> !<span style="color: #666666">=</span> 0<span style="color: #666666">)</span> <span style="color: #666666">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #666666">(</span><span style="color: #19177c">errno</span> <span style="color: #666666">==</span> EBADF<span style="color: #666666">)</span> ? <span style="color: #666666">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #666666">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #008000; font-weight: bold">until</span> close. Calling fsync would <span style="color: #008000">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #ba2121">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    if (str == NULL || *str == &#39;</span><span style="color: #bb6622; font-weight: bold">\0</span><span style="color: #ba2121">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #ba2121">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #ba2121">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #ba2121">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #ba2121">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #ba2121">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #ba2121">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #ba2121">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #ba2121">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #ba2121">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #ba2121">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #ba2121">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #ba2121">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #ba2121">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        case &#39;</span>n<span style="color: #ba2121">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        case &#39;</span>c<span style="color: #ba2121">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #ba2121">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        case &#39;</span>p<span style="color: #ba2121">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        case &#39;</span>P<span style="color: #ba2121">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        case &#39;</span>u<span style="color: #ba2121">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        case &#39;</span>t<span style="color: #ba2121">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        case &#39;</span>V<span style="color: #ba2121">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        case &#39;</span>h<span style="color: #ba2121">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #ba2121">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="">&#39;</span> <span style="color: #008000; font-weight: bold">for</span> more information.<span style="color: #bb6622; font-weight: bold">\n</span><span style="color: #ba2121">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ba2121">}</span></span></span></code></pre></code><a name='rainbow_dash'><h2><a id='stylelink' href='rainbow_dash.html' alt='View only rainbow_dash'>rainbow_dash</a></h2></a><code><pre style="color: #4d4d4d; background-color: #ffffff;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #0080ff; font-style: italic">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #0080ff; font-style: italic">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #0080ff; font-style: italic">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #0080ff; font-style: italic">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #0080ff; font-style: italic">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #0080ff; font-style: italic">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #0080ff; font-style: italic">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #0080ff; font-style: italic">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #0080ff; font-style: italic">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #0080ff; font-style: italic">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #0080ff; font-style: italic">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span class="nv">version_string</span> <span style="color: #2c5dcd">=</span> <span style="color: #00cc66">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #2c5dcd">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #2c5dcd">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #2c5dcd">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="nv">IOPRIO_WHO_PROCESS</span> <span style="color: #2c5dcd">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #2c5dcd">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">IOPRIO_CLASS_SHIFT</span> <span style="color: #2c5dcd">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">EX_EXEC_FAILED</span> <span style="color: #2c5dcd">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">EX_EXEC_ENOENT</span> <span style="color: #2c5dcd">=</span> 127<span class="p">;</span> // Could not find program to <span style="color: #5918bb; font-weight: bold">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #2c5dcd">[]</span> <span style="color: #2c5dcd">=</span> <span style="color: #2c5dcd">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #2c5dcd">[</span>IOPRIO_CLASS_NONE<span style="color: #2c5dcd">]</span> <span style="color: #2c5dcd">=</span> <span style="color: #00cc66">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #2c5dcd">[</span>IOPRIO_CLASS_RT<span style="color: #2c5dcd">]</span> <span style="color: #2c5dcd">=</span> <span style="color: #00cc66">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #2c5dcd">[</span>IOPRIO_CLASS_BE<span style="color: #2c5dcd">]</span> <span style="color: #2c5dcd">=</span> <span style="color: #00cc66">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #2c5dcd">[</span>IOPRIO_CLASS_IDLE<span style="color: #2c5dcd">]</span> <span style="color: #2c5dcd">=</span> <span style="color: #00cc66">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #2c5dcd">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #2c5dcd">(</span>FILE* stream<span style="color: #2c5dcd">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #2c5dcd">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="nv">errno</span> <span style="color: #2c5dcd">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #2c5dcd; font-weight: bold">if</span> <span style="color: #2c5dcd">(</span>ferror<span style="color: #2c5dcd">(</span>stream<span style="color: #2c5dcd">)</span> !<span style="color: #2c5dcd">=</span> <span style="color: #5918bb; font-weight: bold">0</span> <span style="color: #2c5dcd">||</span> fflush<span style="color: #2c5dcd">(</span>stream<span style="color: #2c5dcd">)</span> !<span style="color: #2c5dcd">=</span> 0<span style="color: #2c5dcd">)</span> <span style="color: #2c5dcd">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #2c5dcd; font-weight: bold">return</span> <span style="color: #2c5dcd">(</span><span class="nv">errno</span> <span style="color: #2c5dcd">==</span> EBADF<span style="color: #2c5dcd">)</span> ? <span style="color: #5918bb; font-weight: bold">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #2c5dcd">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #2c5dcd; font-weight: bold">until</span> close. Calling fsync would <span style="color: #5918bb; font-weight: bold">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #00cc66">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    if (str == NULL || *str == &#39;</span><span style="color: #c5060b; font-weight: bold">\0</span><span style="color: #00cc66">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #00cc66">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #00cc66">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #00cc66">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #00cc66">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #00cc66">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #00cc66">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #00cc66">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #00cc66">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #00cc66">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #00cc66">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #00cc66">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #00cc66">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #00cc66">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        case &#39;</span>n<span style="color: #00cc66">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        case &#39;</span>c<span style="color: #00cc66">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #00cc66">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        case &#39;</span>p<span style="color: #00cc66">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        case &#39;</span>P<span style="color: #00cc66">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        case &#39;</span>u<span style="color: #00cc66">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        case &#39;</span>t<span style="color: #00cc66">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        case &#39;</span>V<span style="color: #00cc66">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        case &#39;</span>h<span style="color: #00cc66">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #00cc66">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #ffffff; background-color: #cc0000">&#39;</span> <span style="color: #2c5dcd; font-weight: bold">for</span> more information.<span style="color: #c5060b; font-weight: bold">\n</span><span style="color: #00cc66">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00cc66">}</span></span></span></code></pre></code><a name='rose-pine-dawn'><h2><a id='stylelink' href='rose-pine-dawn.html' alt='View only rose-pine-dawn'>rose-pine-dawn</a></h2></a><code><pre style="color: #575279; background-color: #faf4ed;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #9893a5">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #9893a5">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #9893a5">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #9893a5">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #9893a5">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #9893a5">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #9893a5">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #9893a5">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #9893a5">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #9893a5">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #9893a5">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #d7827e">version_string</span> <span style="color: #797593">=</span> <span style="color: #ea9d34">&#34;tinyionice 1.0.4&#34;</span><span style="color: #797593">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #797593">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #797593">}</span><span style="color: #797593">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #797593">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #d7827e">IOPRIO_WHO_PROCESS</span> <span style="color: #797593">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #797593">}</span><span style="color: #797593">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #d7827e">IOPRIO_CLASS_SHIFT</span> <span style="color: #797593">=</span> 13<span style="color: #797593">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #d7827e">EX_EXEC_FAILED</span> <span style="color: #797593">=</span> 126<span style="color: #797593">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #d7827e">EX_EXEC_ENOENT</span> <span style="color: #797593">=</span> 127<span style="color: #797593">;</span> // Could not find program to <span style="color: #d7827e">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #797593">[]</span> <span style="color: #797593">=</span> <span style="color: #797593">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #797593">[</span>IOPRIO_CLASS_NONE<span style="color: #797593">]</span> <span style="color: #797593">=</span> <span style="color: #ea9d34">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #797593">[</span>IOPRIO_CLASS_RT<span style="color: #797593">]</span> <span style="color: #797593">=</span> <span style="color: #ea9d34">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #797593">[</span>IOPRIO_CLASS_BE<span style="color: #797593">]</span> <span style="color: #797593">=</span> <span style="color: #ea9d34">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #797593">[</span>IOPRIO_CLASS_IDLE<span style="color: #797593">]</span> <span style="color: #797593">=</span> <span style="color: #ea9d34">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #797593">}</span><span style="color: #797593">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #797593">(</span>FILE* stream<span style="color: #797593">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #797593">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #d7827e">errno</span> <span style="color: #797593">=</span> 0<span style="color: #797593">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #286983">if</span> <span style="color: #797593">(</span>ferror<span style="color: #797593">(</span>stream<span style="color: #797593">)</span> !<span style="color: #797593">=</span> <span style="color: #ea9d34">0</span> <span style="color: #797593">||</span> fflush<span style="color: #797593">(</span>stream<span style="color: #797593">)</span> !<span style="color: #797593">=</span> 0<span style="color: #797593">)</span> <span style="color: #797593">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #286983">return</span> <span style="color: #797593">(</span><span style="color: #d7827e">errno</span> <span style="color: #797593">==</span> EBADF<span style="color: #797593">)</span> ? <span style="color: #ea9d34">0</span> : EOF<span style="color: #797593">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #797593">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #286983">until</span> close. Calling fsync would <span style="color: #d7827e">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #ea9d34">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    if (str == NULL || *str == &#39;</span><span style="color: #286983">\0</span><span style="color: #ea9d34">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #ea9d34">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #ea9d34">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #ea9d34">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #ea9d34">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #ea9d34">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #ea9d34">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #ea9d34">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #ea9d34">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #ea9d34">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #ea9d34">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #ea9d34">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #ea9d34">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #ea9d34">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        case &#39;</span>n<span style="color: #ea9d34">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        case &#39;</span>c<span style="color: #ea9d34">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #ea9d34">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        case &#39;</span>p<span style="color: #ea9d34">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        case &#39;</span>P<span style="color: #ea9d34">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        case &#39;</span>u<span style="color: #ea9d34">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        case &#39;</span>t<span style="color: #ea9d34">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        case &#39;</span>V<span style="color: #ea9d34">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        case &#39;</span>h<span style="color: #ea9d34">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #ea9d34">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #b4637a">&#39;</span> <span style="color: #286983">for</span> more information.<span style="color: #286983">\n</span><span style="color: #ea9d34">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #ea9d34">}</span></span></span></code></pre></code><a name='rose-pine-moon'><h2><a id='stylelink' href='rose-pine-moon.html' alt='View only rose-pine-moon'>rose-pine-moon</a></h2></a><code><pre style="color: #e0def4; background-color: #232136;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6e6a86">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6e6a86">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6e6a86">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6e6a86">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6e6a86">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6e6a86">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6e6a86">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6e6a86">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6e6a86">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6e6a86">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6e6a86">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #ea9a97">version_string</span> <span style="color: #908caa">=</span> <span style="color: #f6c177">&#34;tinyionice 1.0.4&#34;</span><span style="color: #908caa">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #908caa">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #908caa">}</span><span style="color: #908caa">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #908caa">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ea9a97">IOPRIO_WHO_PROCESS</span> <span style="color: #908caa">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #908caa">}</span><span style="color: #908caa">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #ea9a97">IOPRIO_CLASS_SHIFT</span> <span style="color: #908caa">=</span> 13<span style="color: #908caa">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #ea9a97">EX_EXEC_FAILED</span> <span style="color: #908caa">=</span> 126<span style="color: #908caa">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #ea9a97">EX_EXEC_ENOENT</span> <span style="color: #908caa">=</span> 127<span style="color: #908caa">;</span> // Could not find program to <span style="color: #ea9a97">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #908caa">[]</span> <span style="color: #908caa">=</span> <span style="color: #908caa">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #908caa">[</span>IOPRIO_CLASS_NONE<span style="color: #908caa">]</span> <span style="color: #908caa">=</span> <span style="color: #f6c177">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #908caa">[</span>IOPRIO_CLASS_RT<span style="color: #908caa">]</span> <span style="color: #908caa">=</span> <span style="color: #f6c177">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #908caa">[</span>IOPRIO_CLASS_BE<span style="color: #908caa">]</span> <span style="color: #908caa">=</span> <span style="color: #f6c177">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #908caa">[</span>IOPRIO_CLASS_IDLE<span style="color: #908caa">]</span> <span style="color: #908caa">=</span> <span style="color: #f6c177">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #908caa">}</span><span style="color: #908caa">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #908caa">(</span>FILE* stream<span style="color: #908caa">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #908caa">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ea9a97">errno</span> <span style="color: #908caa">=</span> 0<span style="color: #908caa">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #3e8fb0">if</span> <span style="color: #908caa">(</span>ferror<span style="color: #908caa">(</span>stream<span style="color: #908caa">)</span> !<span style="color: #908caa">=</span> <span style="color: #f6c177">0</span> <span style="color: #908caa">||</span> fflush<span style="color: #908caa">(</span>stream<span style="color: #908caa">)</span> !<span style="color: #908caa">=</span> 0<span style="color: #908caa">)</span> <span style="color: #908caa">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #3e8fb0">return</span> <span style="color: #908caa">(</span><span style="color: #ea9a97">errno</span> <span style="color: #908caa">==</span> EBADF<span style="color: #908caa">)</span> ? <span style="color: #f6c177">0</span> : EOF<span style="color: #908caa">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #908caa">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #3e8fb0">until</span> close. Calling fsync would <span style="color: #ea9a97">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #f6c177">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    if (str == NULL || *str == &#39;</span><span style="color: #3e8fb0">\0</span><span style="color: #f6c177">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #f6c177">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #f6c177">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #f6c177">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #f6c177">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #f6c177">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #f6c177">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #f6c177">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #f6c177">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #f6c177">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #f6c177">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #f6c177">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #f6c177">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #f6c177">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        case &#39;</span>n<span style="color: #f6c177">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        case &#39;</span>c<span style="color: #f6c177">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #f6c177">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        case &#39;</span>p<span style="color: #f6c177">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        case &#39;</span>P<span style="color: #f6c177">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        case &#39;</span>u<span style="color: #f6c177">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        case &#39;</span>t<span style="color: #f6c177">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        case &#39;</span>V<span style="color: #f6c177">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        case &#39;</span>h<span style="color: #f6c177">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #f6c177">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #eb6f92">&#39;</span> <span style="color: #3e8fb0">for</span> more information.<span style="color: #3e8fb0">\n</span><span style="color: #f6c177">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">}</span></span></span></code></pre></code><a name='rose-pine'><h2><a id='stylelink' href='rose-pine.html' alt='View only rose-pine'>rose-pine</a></h2></a><code><pre style="color: #e0def4; background-color: #191724;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6e6a86">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6e6a86">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6e6a86">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6e6a86">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6e6a86">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6e6a86">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6e6a86">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6e6a86">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6e6a86">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6e6a86">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6e6a86">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #ebbcba">version_string</span> <span style="color: #908caa">=</span> <span style="color: #f6c177">&#34;tinyionice 1.0.4&#34;</span><span style="color: #908caa">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #908caa">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #908caa">}</span><span style="color: #908caa">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #908caa">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ebbcba">IOPRIO_WHO_PROCESS</span> <span style="color: #908caa">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #908caa">}</span><span style="color: #908caa">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #ebbcba">IOPRIO_CLASS_SHIFT</span> <span style="color: #908caa">=</span> 13<span style="color: #908caa">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #ebbcba">EX_EXEC_FAILED</span> <span style="color: #908caa">=</span> 126<span style="color: #908caa">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #ebbcba">EX_EXEC_ENOENT</span> <span style="color: #908caa">=</span> 127<span style="color: #908caa">;</span> // Could not find program to <span style="color: #ebbcba">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #908caa">[]</span> <span style="color: #908caa">=</span> <span style="color: #908caa">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #908caa">[</span>IOPRIO_CLASS_NONE<span style="color: #908caa">]</span> <span style="color: #908caa">=</span> <span style="color: #f6c177">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #908caa">[</span>IOPRIO_CLASS_RT<span style="color: #908caa">]</span> <span style="color: #908caa">=</span> <span style="color: #f6c177">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #908caa">[</span>IOPRIO_CLASS_BE<span style="color: #908caa">]</span> <span style="color: #908caa">=</span> <span style="color: #f6c177">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #908caa">[</span>IOPRIO_CLASS_IDLE<span style="color: #908caa">]</span> <span style="color: #908caa">=</span> <span style="color: #f6c177">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #908caa">}</span><span style="color: #908caa">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #908caa">(</span>FILE* stream<span style="color: #908caa">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #908caa">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ebbcba">errno</span> <span style="color: #908caa">=</span> 0<span style="color: #908caa">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #31748f">if</span> <span style="color: #908caa">(</span>ferror<span style="color: #908caa">(</span>stream<span style="color: #908caa">)</span> !<span style="color: #908caa">=</span> <span style="color: #f6c177">0</span> <span style="color: #908caa">||</span> fflush<span style="color: #908caa">(</span>stream<span style="color: #908caa">)</span> !<span style="color: #908caa">=</span> 0<span style="color: #908caa">)</span> <span style="color: #908caa">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #31748f">return</span> <span style="color: #908caa">(</span><span style="color: #ebbcba">errno</span> <span style="color: #908caa">==</span> EBADF<span style="color: #908caa">)</span> ? <span style="color: #f6c177">0</span> : EOF<span style="color: #908caa">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #908caa">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #31748f">until</span> close. Calling fsync would <span style="color: #ebbcba">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #f6c177">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    if (str == NULL || *str == &#39;</span><span style="color: #31748f">\0</span><span style="color: #f6c177">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #f6c177">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #f6c177">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #f6c177">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #f6c177">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #f6c177">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #f6c177">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #f6c177">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #f6c177">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #f6c177">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #f6c177">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #f6c177">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #f6c177">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #f6c177">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        case &#39;</span>n<span style="color: #f6c177">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        case &#39;</span>c<span style="color: #f6c177">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #f6c177">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        case &#39;</span>p<span style="color: #f6c177">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        case &#39;</span>P<span style="color: #f6c177">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        case &#39;</span>u<span style="color: #f6c177">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        case &#39;</span>t<span style="color: #f6c177">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        case &#39;</span>V<span style="color: #f6c177">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        case &#39;</span>h<span style="color: #f6c177">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #f6c177">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #eb6f92">&#39;</span> <span style="color: #31748f">for</span> more information.<span style="color: #31748f">\n</span><span style="color: #f6c177">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #f6c177">}</span></span></span></code></pre></code><a name='rrt'><h2><a id='stylelink' href='rrt.html' alt='View only rrt'>rrt</a></h2></a><code><pre style="color: #f8f8f2; background-color: #000000;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #00ff00">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #00ff00">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #00ff00">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #00ff00">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #00ff00">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #00ff00">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #00ff00">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #00ff00">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #00ff00">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #00ff00">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #00ff00">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #eedd82">version_string</span> <span class="o">=</span> <span style="color: #87ceeb">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #eedd82">IOPRIO_WHO_PROCESS</span> <span class="o">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #eedd82">IOPRIO_CLASS_SHIFT</span> <span class="o">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #eedd82">EX_EXEC_FAILED</span> <span class="o">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #eedd82">EX_EXEC_ENOENT</span> <span class="o">=</span> 127<span class="p">;</span> // Could not find program to <span class="nb">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span class="o">[]</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_NONE<span class="o">]</span> <span class="o">=</span> <span style="color: #87ceeb">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_RT<span class="o">]</span> <span class="o">=</span> <span style="color: #87ceeb">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_BE<span class="o">]</span> <span class="o">=</span> <span style="color: #87ceeb">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_IDLE<span class="o">]</span> <span class="o">=</span> <span style="color: #87ceeb">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span class="o">(</span>FILE* stream<span class="o">)</span>
</span></span><span style="display: flex;"><span class="cl"><span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #eedd82">errno</span> <span class="o">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ff0000">if</span> <span class="o">(</span>ferror<span class="o">(</span>stream<span class="o">)</span> !<span class="o">=</span> <span style="color: #ff6600">0</span> <span class="o">||</span> fflush<span class="o">(</span>stream<span class="o">)</span> !<span class="o">=</span> 0<span class="o">)</span> <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #ff0000">return</span> <span class="o">(</span><span style="color: #eedd82">errno</span> <span class="o">==</span> EBADF<span class="o">)</span> ? <span style="color: #ff6600">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="o">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #ff0000">until</span> close. Calling fsync would <span class="nb">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #87ceeb">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    if (str == NULL || *str == &#39;</span><span style="color: #87ceeb">\0</span><span style="color: #87ceeb">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #87ceeb">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #87ceeb">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #87ceeb">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #87ceeb">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #87ceeb">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #87ceeb">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #87ceeb">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #87ceeb">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #87ceeb">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #87ceeb">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #87ceeb">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #87ceeb">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #87ceeb">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        case &#39;</span>n<span style="color: #87ceeb">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        case &#39;</span>c<span style="color: #87ceeb">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #87ceeb">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        case &#39;</span>p<span style="color: #87ceeb">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        case &#39;</span>P<span style="color: #87ceeb">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        case &#39;</span>u<span style="color: #87ceeb">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        case &#39;</span>t<span style="color: #87ceeb">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        case &#39;</span>V<span style="color: #87ceeb">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        case &#39;</span>h<span style="color: #87ceeb">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #87ceeb">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span class="err">&#39;</span> <span style="color: #ff0000">for</span> more information.<span style="color: #87ceeb">\n</span><span style="color: #87ceeb">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #87ceeb">}</span></span></span></code></pre></code><a name='solarized-dark'><h2><a id='stylelink' href='solarized-dark.html' alt='View only solarized-dark'>solarized-dark</a></h2></a><code><pre style="color: #93a1a1; background-color: #002b36;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #586e75">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #586e75">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #586e75">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #586e75">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #586e75">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #586e75">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #586e75">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #586e75">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #586e75">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #586e75">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #586e75">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #268bd2">version_string</span> <span style="color: #719e07">=</span> <span style="color: #2aa198">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #719e07">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #719e07">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #719e07">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #268bd2">IOPRIO_WHO_PROCESS</span> <span style="color: #719e07">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #719e07">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #268bd2">IOPRIO_CLASS_SHIFT</span> <span style="color: #719e07">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #268bd2">EX_EXEC_FAILED</span> <span style="color: #719e07">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #268bd2">EX_EXEC_ENOENT</span> <span style="color: #719e07">=</span> 127<span class="p">;</span> // Could not find program to <span style="color: #b58900">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #719e07">[]</span> <span style="color: #719e07">=</span> <span style="color: #719e07">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #719e07">[</span>IOPRIO_CLASS_NONE<span style="color: #719e07">]</span> <span style="color: #719e07">=</span> <span style="color: #2aa198">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #719e07">[</span>IOPRIO_CLASS_RT<span style="color: #719e07">]</span> <span style="color: #719e07">=</span> <span style="color: #2aa198">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #719e07">[</span>IOPRIO_CLASS_BE<span style="color: #719e07">]</span> <span style="color: #719e07">=</span> <span style="color: #2aa198">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #719e07">[</span>IOPRIO_CLASS_IDLE<span style="color: #719e07">]</span> <span style="color: #719e07">=</span> <span style="color: #2aa198">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #719e07">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #719e07">(</span>FILE* stream<span style="color: #719e07">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #719e07">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #268bd2">errno</span> <span style="color: #719e07">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #719e07">if</span> <span style="color: #719e07">(</span>ferror<span style="color: #719e07">(</span>stream<span style="color: #719e07">)</span> !<span style="color: #719e07">=</span> <span style="color: #2aa198">0</span> <span style="color: #719e07">||</span> fflush<span style="color: #719e07">(</span>stream<span style="color: #719e07">)</span> !<span style="color: #719e07">=</span> 0<span style="color: #719e07">)</span> <span style="color: #719e07">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #719e07">return</span> <span style="color: #719e07">(</span><span style="color: #268bd2">errno</span> <span style="color: #719e07">==</span> EBADF<span style="color: #719e07">)</span> ? <span style="color: #2aa198">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #719e07">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #719e07">until</span> close. Calling fsync would <span style="color: #b58900">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #2aa198">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    if (str == NULL || *str == &#39;</span><span style="color: #cb4b16">\0</span><span style="color: #2aa198">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #2aa198">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #2aa198">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #2aa198">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #2aa198">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #2aa198">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #2aa198">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #2aa198">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #2aa198">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #2aa198">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #2aa198">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #2aa198">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #2aa198">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #2aa198">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        case &#39;</span>n<span style="color: #2aa198">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        case &#39;</span>c<span style="color: #2aa198">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #2aa198">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        case &#39;</span>p<span style="color: #2aa198">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        case &#39;</span>P<span style="color: #2aa198">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        case &#39;</span>u<span style="color: #2aa198">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        case &#39;</span>t<span style="color: #2aa198">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        case &#39;</span>V<span style="color: #2aa198">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        case &#39;</span>h<span style="color: #2aa198">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #2aa198">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span class="err">&#39;</span> <span style="color: #719e07">for</span> more information.<span style="color: #cb4b16">\n</span><span style="color: #2aa198">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">}</span></span></span></code></pre></code><a name='solarized-dark256'><h2><a id='stylelink' href='solarized-dark256.html' alt='View only solarized-dark256'>solarized-dark256</a></h2></a><code><pre style="color: #8a8a8a; background-color: #1c1c1c;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #4e4e4e">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #4e4e4e">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #4e4e4e">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #4e4e4e">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #4e4e4e">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #4e4e4e">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #4e4e4e">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #4e4e4e">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #4e4e4e">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #4e4e4e">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #4e4e4e">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #0087ff">version_string</span> <span class="o">=</span> <span style="color: #00afaf">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #0087ff">IOPRIO_WHO_PROCESS</span> <span class="o">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #0087ff">IOPRIO_CLASS_SHIFT</span> <span class="o">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #0087ff">EX_EXEC_FAILED</span> <span class="o">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #0087ff">EX_EXEC_ENOENT</span> <span class="o">=</span> 127<span class="p">;</span> // Could not find program to <span style="color: #0087ff">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span class="o">[]</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_NONE<span class="o">]</span> <span class="o">=</span> <span style="color: #00afaf">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_RT<span class="o">]</span> <span class="o">=</span> <span style="color: #00afaf">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_BE<span class="o">]</span> <span class="o">=</span> <span style="color: #00afaf">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_IDLE<span class="o">]</span> <span class="o">=</span> <span style="color: #00afaf">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span class="o">(</span>FILE* stream<span class="o">)</span>
</span></span><span style="display: flex;"><span class="cl"><span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #0087ff">errno</span> <span class="o">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #5f8700">if</span> <span class="o">(</span>ferror<span class="o">(</span>stream<span class="o">)</span> !<span class="o">=</span> <span style="color: #00afaf">0</span> <span class="o">||</span> fflush<span class="o">(</span>stream<span class="o">)</span> !<span class="o">=</span> 0<span class="o">)</span> <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #5f8700">return</span> <span class="o">(</span><span style="color: #0087ff">errno</span> <span class="o">==</span> EBADF<span class="o">)</span> ? <span style="color: #00afaf">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="o">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #5f8700">until</span> close. Calling fsync would <span style="color: #0087ff">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #00afaf">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    if (str == NULL || *str == &#39;</span><span style="color: #af0000">\0</span><span style="color: #00afaf">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #00afaf">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #00afaf">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #00afaf">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #00afaf">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #00afaf">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #00afaf">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #00afaf">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #00afaf">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #00afaf">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #00afaf">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #00afaf">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #00afaf">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #00afaf">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        case &#39;</span>n<span style="color: #00afaf">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        case &#39;</span>c<span style="color: #00afaf">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #00afaf">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        case &#39;</span>p<span style="color: #00afaf">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        case &#39;</span>P<span style="color: #00afaf">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        case &#39;</span>u<span style="color: #00afaf">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        case &#39;</span>t<span style="color: #00afaf">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        case &#39;</span>V<span style="color: #00afaf">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        case &#39;</span>h<span style="color: #00afaf">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #00afaf">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span class="err">&#39;</span> <span style="color: #5f8700">for</span> more information.<span style="color: #af0000">\n</span><span style="color: #00afaf">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00afaf">}</span></span></span></code></pre></code><a name='solarized-light'><h2><a id='stylelink' href='solarized-light.html' alt='View only solarized-light'>solarized-light</a></h2></a><code><pre style="color: #586e75; background-color: #eee8d5;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #93a1a1; font-style: italic">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #93a1a1; font-style: italic">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #93a1a1; font-style: italic">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #93a1a1; font-style: italic">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #93a1a1; font-style: italic">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #93a1a1; font-style: italic">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #93a1a1; font-style: italic">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #93a1a1; font-style: italic">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #93a1a1; font-style: italic">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #93a1a1; font-style: italic">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #93a1a1; font-style: italic">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #268bd2">version_string</span> <span class="o">=</span> <span style="color: #2aa198">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #268bd2">IOPRIO_WHO_PROCESS</span> <span class="o">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #268bd2">IOPRIO_CLASS_SHIFT</span> <span class="o">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #268bd2">EX_EXEC_FAILED</span> <span class="o">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #268bd2">EX_EXEC_ENOENT</span> <span class="o">=</span> 127<span class="p">;</span> // Could not find program to <span style="color: #cb4b16">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span class="o">[]</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_NONE<span class="o">]</span> <span class="o">=</span> <span style="color: #2aa198">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_RT<span class="o">]</span> <span class="o">=</span> <span style="color: #2aa198">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_BE<span class="o">]</span> <span class="o">=</span> <span style="color: #2aa198">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_IDLE<span class="o">]</span> <span class="o">=</span> <span style="color: #2aa198">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span class="o">(</span>FILE* stream<span class="o">)</span>
</span></span><span style="display: flex;"><span class="cl"><span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #268bd2">errno</span> <span class="o">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #859900">if</span> <span class="o">(</span>ferror<span class="o">(</span>stream<span class="o">)</span> !<span class="o">=</span> <span style="color: #2aa198; font-weight: bold">0</span> <span class="o">||</span> fflush<span class="o">(</span>stream<span class="o">)</span> !<span class="o">=</span> 0<span class="o">)</span> <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #859900">return</span> <span class="o">(</span><span style="color: #268bd2">errno</span> <span class="o">==</span> EBADF<span class="o">)</span> ? <span style="color: #2aa198; font-weight: bold">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="o">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #859900">until</span> close. Calling fsync would <span style="color: #cb4b16">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #2aa198">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    if (str == NULL || *str == &#39;</span><span style="color: #2aa198">\0</span><span style="color: #2aa198">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #2aa198">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #2aa198">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #2aa198">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #2aa198">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #2aa198">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #2aa198">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #2aa198">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #2aa198">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #2aa198">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #2aa198">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #2aa198">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #2aa198">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #2aa198">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        case &#39;</span>n<span style="color: #2aa198">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        case &#39;</span>c<span style="color: #2aa198">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #2aa198">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        case &#39;</span>p<span style="color: #2aa198">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        case &#39;</span>P<span style="color: #2aa198">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        case &#39;</span>u<span style="color: #2aa198">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        case &#39;</span>t<span style="color: #2aa198">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        case &#39;</span>V<span style="color: #2aa198">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        case &#39;</span>h<span style="color: #2aa198">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #2aa198">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span class="err">&#39;</span> <span style="color: #859900">for</span> more information.<span style="color: #2aa198">\n</span><span style="color: #2aa198">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #2aa198">}</span></span></span></code></pre></code><a name='swapoff'><h2><a id='stylelink' href='swapoff.html' alt='View only swapoff'>swapoff</a></h2></a><code><pre style="color: #e5e5e5; background-color: #000000;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #007f7f">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #007f7f">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #007f7f">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #007f7f">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #007f7f">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #007f7f">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #007f7f">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #007f7f">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #007f7f">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #007f7f">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #007f7f">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span class="nv">version_string</span> <span class="o">=</span> <span style="color: #00ffff; font-weight: bold">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="nv">IOPRIO_WHO_PROCESS</span> <span class="o">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">IOPRIO_CLASS_SHIFT</span> <span class="o">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">EX_EXEC_FAILED</span> <span class="o">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">EX_EXEC_ENOENT</span> <span class="o">=</span> 127<span class="p">;</span> // Could not find program to <span style="color: #ffffff; font-weight: bold">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span class="o">[]</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_NONE<span class="o">]</span> <span class="o">=</span> <span style="color: #00ffff; font-weight: bold">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_RT<span class="o">]</span> <span class="o">=</span> <span style="color: #00ffff; font-weight: bold">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_BE<span class="o">]</span> <span class="o">=</span> <span style="color: #00ffff; font-weight: bold">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_IDLE<span class="o">]</span> <span class="o">=</span> <span style="color: #00ffff; font-weight: bold">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span class="o">(</span>FILE* stream<span class="o">)</span>
</span></span><span style="display: flex;"><span class="cl"><span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="nv">errno</span> <span class="o">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ffffff; font-weight: bold">if</span> <span class="o">(</span>ferror<span class="o">(</span>stream<span class="o">)</span> !<span class="o">=</span> <span style="color: #ffff00; font-weight: bold">0</span> <span class="o">||</span> fflush<span class="o">(</span>stream<span class="o">)</span> !<span class="o">=</span> 0<span class="o">)</span> <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #ffffff; font-weight: bold">return</span> <span class="o">(</span><span class="nv">errno</span> <span class="o">==</span> EBADF<span class="o">)</span> ? <span style="color: #ffff00; font-weight: bold">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="o">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #ffffff; font-weight: bold">until</span> close. Calling fsync would <span style="color: #ffffff; font-weight: bold">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #00ffff; font-weight: bold">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    if (str == NULL || *str == &#39;</span><span style="color: #00ffff; font-weight: bold">\0</span><span style="color: #00ffff; font-weight: bold">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #00ffff; font-weight: bold">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #00ffff; font-weight: bold">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #00ffff; font-weight: bold">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #00ffff; font-weight: bold">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #00ffff; font-weight: bold">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #00ffff; font-weight: bold">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #00ffff; font-weight: bold">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #00ffff; font-weight: bold">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #00ffff; font-weight: bold">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #00ffff; font-weight: bold">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #00ffff; font-weight: bold">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #00ffff; font-weight: bold">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #00ffff; font-weight: bold">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        case &#39;</span>n<span style="color: #00ffff; font-weight: bold">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        case &#39;</span>c<span style="color: #00ffff; font-weight: bold">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #00ffff; font-weight: bold">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        case &#39;</span>p<span style="color: #00ffff; font-weight: bold">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        case &#39;</span>P<span style="color: #00ffff; font-weight: bold">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        case &#39;</span>u<span style="color: #00ffff; font-weight: bold">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        case &#39;</span>t<span style="color: #00ffff; font-weight: bold">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        case &#39;</span>V<span style="color: #00ffff; font-weight: bold">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        case &#39;</span>h<span style="color: #00ffff; font-weight: bold">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #00ffff; font-weight: bold">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #ff0000">&#39;</span> <span style="color: #ffffff; font-weight: bold">for</span> more information.<span style="color: #00ffff; font-weight: bold">\n</span><span style="color: #00ffff; font-weight: bold">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #00ffff; font-weight: bold">}</span></span></span></code></pre></code><a name='tango'><h2><a id='stylelink' href='tango.html' alt='View only tango'>tango</a></h2></a><code><pre style="background-color: #f8f8f8;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8f5902; font-style: italic">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8f5902; font-style: italic">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8f5902; font-style: italic">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8f5902; font-style: italic">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8f5902; font-style: italic">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8f5902; font-style: italic">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8f5902; font-style: italic">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8f5902; font-style: italic">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8f5902; font-style: italic">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8f5902; font-style: italic">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #8f5902; font-style: italic">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #000000">version_string</span> <span style="color: #ce5c00; font-weight: bold">=</span> <span style="color: #4e9a06">&#34;tinyionice 1.0.4&#34;</span><span style="color: #000000; font-weight: bold">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #ce5c00; font-weight: bold">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ce5c00; font-weight: bold">}</span><span style="color: #000000; font-weight: bold">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #ce5c00; font-weight: bold">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #000000">IOPRIO_WHO_PROCESS</span> <span style="color: #ce5c00; font-weight: bold">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ce5c00; font-weight: bold">}</span><span style="color: #000000; font-weight: bold">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #000000">IOPRIO_CLASS_SHIFT</span> <span style="color: #ce5c00; font-weight: bold">=</span> 13<span style="color: #000000; font-weight: bold">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #000000">EX_EXEC_FAILED</span> <span style="color: #ce5c00; font-weight: bold">=</span> 126<span style="color: #000000; font-weight: bold">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #000000">EX_EXEC_ENOENT</span> <span style="color: #ce5c00; font-weight: bold">=</span> 127<span style="color: #000000; font-weight: bold">;</span> // Could not find program to <span style="color: #204a87">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #ce5c00; font-weight: bold">[]</span> <span style="color: #ce5c00; font-weight: bold">=</span> <span style="color: #ce5c00; font-weight: bold">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ce5c00; font-weight: bold">[</span>IOPRIO_CLASS_NONE<span style="color: #ce5c00; font-weight: bold">]</span> <span style="color: #ce5c00; font-weight: bold">=</span> <span style="color: #4e9a06">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ce5c00; font-weight: bold">[</span>IOPRIO_CLASS_RT<span style="color: #ce5c00; font-weight: bold">]</span> <span style="color: #ce5c00; font-weight: bold">=</span> <span style="color: #4e9a06">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ce5c00; font-weight: bold">[</span>IOPRIO_CLASS_BE<span style="color: #ce5c00; font-weight: bold">]</span> <span style="color: #ce5c00; font-weight: bold">=</span> <span style="color: #4e9a06">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ce5c00; font-weight: bold">[</span>IOPRIO_CLASS_IDLE<span style="color: #ce5c00; font-weight: bold">]</span> <span style="color: #ce5c00; font-weight: bold">=</span> <span style="color: #4e9a06">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ce5c00; font-weight: bold">}</span><span style="color: #000000; font-weight: bold">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #ce5c00; font-weight: bold">(</span>FILE* stream<span style="color: #ce5c00; font-weight: bold">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ce5c00; font-weight: bold">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #000000">errno</span> <span style="color: #ce5c00; font-weight: bold">=</span> 0<span style="color: #000000; font-weight: bold">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #204a87; font-weight: bold">if</span> <span style="color: #ce5c00; font-weight: bold">(</span>ferror<span style="color: #ce5c00; font-weight: bold">(</span>stream<span style="color: #ce5c00; font-weight: bold">)</span> !<span style="color: #ce5c00; font-weight: bold">=</span> <span style="color: #0000cf; font-weight: bold">0</span> <span style="color: #ce5c00; font-weight: bold">||</span> fflush<span style="color: #ce5c00; font-weight: bold">(</span>stream<span style="color: #ce5c00; font-weight: bold">)</span> !<span style="color: #ce5c00; font-weight: bold">=</span> 0<span style="color: #ce5c00; font-weight: bold">)</span> <span style="color: #ce5c00; font-weight: bold">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #204a87; font-weight: bold">return</span> <span style="color: #ce5c00; font-weight: bold">(</span><span style="color: #000000">errno</span> <span style="color: #ce5c00; font-weight: bold">==</span> EBADF<span style="color: #ce5c00; font-weight: bold">)</span> ? <span style="color: #0000cf; font-weight: bold">0</span> : EOF<span style="color: #000000; font-weight: bold">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ce5c00; font-weight: bold">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #204a87; font-weight: bold">until</span> close. Calling fsync would <span style="color: #204a87">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #4e9a06">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    if (str == NULL || *str == &#39;</span><span style="color: #4e9a06">\0</span><span style="color: #4e9a06">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #4e9a06">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #4e9a06">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #4e9a06">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #4e9a06">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #4e9a06">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #4e9a06">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #4e9a06">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #4e9a06">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #4e9a06">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #4e9a06">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #4e9a06">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #4e9a06">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #4e9a06">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        case &#39;</span>n<span style="color: #4e9a06">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        case &#39;</span>c<span style="color: #4e9a06">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #4e9a06">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        case &#39;</span>p<span style="color: #4e9a06">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        case &#39;</span>P<span style="color: #4e9a06">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        case &#39;</span>u<span style="color: #4e9a06">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        case &#39;</span>t<span style="color: #4e9a06">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        case &#39;</span>V<span style="color: #4e9a06">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        case &#39;</span>h<span style="color: #4e9a06">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #4e9a06">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #a40000">&#39;</span> <span style="color: #204a87; font-weight: bold">for</span> more information.<span style="color: #4e9a06">\n</span><span style="color: #4e9a06">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #4e9a06">}</span></span></span></code></pre></code><a name='trac'><h2><a id='stylelink' href='trac.html' alt='View only trac'>trac</a></h2></a><code><pre style="background-color: #ffffff;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #999988; font-style: italic">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #999988; font-style: italic">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #999988; font-style: italic">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #999988; font-style: italic">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #999988; font-style: italic">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #999988; font-style: italic">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #999988; font-style: italic">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #999988; font-style: italic">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #999988; font-style: italic">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #999988; font-style: italic">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #999988; font-style: italic">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #008080">version_string</span> <span style="font-weight: bold">=</span> <span style="color: #bb8844">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="font-weight: bold">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="font-weight: bold">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="font-weight: bold">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #008080">IOPRIO_WHO_PROCESS</span> <span style="font-weight: bold">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="font-weight: bold">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #008080">IOPRIO_CLASS_SHIFT</span> <span style="font-weight: bold">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #008080">EX_EXEC_FAILED</span> <span style="font-weight: bold">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #008080">EX_EXEC_ENOENT</span> <span style="font-weight: bold">=</span> 127<span class="p">;</span> // Could not find program to <span style="color: #999999">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="font-weight: bold">[]</span> <span style="font-weight: bold">=</span> <span style="font-weight: bold">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="font-weight: bold">[</span>IOPRIO_CLASS_NONE<span style="font-weight: bold">]</span> <span style="font-weight: bold">=</span> <span style="color: #bb8844">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="font-weight: bold">[</span>IOPRIO_CLASS_RT<span style="font-weight: bold">]</span> <span style="font-weight: bold">=</span> <span style="color: #bb8844">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="font-weight: bold">[</span>IOPRIO_CLASS_BE<span style="font-weight: bold">]</span> <span style="font-weight: bold">=</span> <span style="color: #bb8844">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="font-weight: bold">[</span>IOPRIO_CLASS_IDLE<span style="font-weight: bold">]</span> <span style="font-weight: bold">=</span> <span style="color: #bb8844">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="font-weight: bold">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="font-weight: bold">(</span>FILE* stream<span style="font-weight: bold">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="font-weight: bold">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #008080">errno</span> <span style="font-weight: bold">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="font-weight: bold">if</span> <span style="font-weight: bold">(</span>ferror<span style="font-weight: bold">(</span>stream<span style="font-weight: bold">)</span> !<span style="font-weight: bold">=</span> <span style="color: #009999">0</span> <span style="font-weight: bold">||</span> fflush<span style="font-weight: bold">(</span>stream<span style="font-weight: bold">)</span> !<span style="font-weight: bold">=</span> 0<span style="font-weight: bold">)</span> <span style="font-weight: bold">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="font-weight: bold">return</span> <span style="font-weight: bold">(</span><span style="color: #008080">errno</span> <span style="font-weight: bold">==</span> EBADF<span style="font-weight: bold">)</span> ? <span style="color: #009999">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="font-weight: bold">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="font-weight: bold">until</span> close. Calling fsync would <span style="color: #999999">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #bb8844">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    if (str == NULL || *str == &#39;</span><span style="color: #bb8844">\0</span><span style="color: #bb8844">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #bb8844">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #bb8844">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #bb8844">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #bb8844">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #bb8844">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #bb8844">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #bb8844">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #bb8844">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #bb8844">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #bb8844">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #bb8844">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #bb8844">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #bb8844">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        case &#39;</span>n<span style="color: #bb8844">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        case &#39;</span>c<span style="color: #bb8844">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #bb8844">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        case &#39;</span>p<span style="color: #bb8844">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        case &#39;</span>P<span style="color: #bb8844">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        case &#39;</span>u<span style="color: #bb8844">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        case &#39;</span>t<span style="color: #bb8844">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        case &#39;</span>V<span style="color: #bb8844">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        case &#39;</span>h<span style="color: #bb8844">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #bb8844">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #a61717; background-color: #e3d2d2">&#39;</span> <span style="font-weight: bold">for</span> more information.<span style="color: #bb8844">\n</span><span style="color: #bb8844">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #bb8844">}</span></span></span></code></pre></code><a name='vim'><h2><a id='stylelink' href='vim.html' alt='View only vim'>vim</a></h2></a><code><pre style="color: #cccccc; background-color: #000000;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #000080">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #000080">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #000080">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #000080">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #000080">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #000080">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #000080">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #000080">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #000080">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #000080">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #000080">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #00cdcd">version_string</span> <span style="color: #3399cc">=</span> <span style="color: #cd0000">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #3399cc">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #3399cc">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #3399cc">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #00cdcd">IOPRIO_WHO_PROCESS</span> <span style="color: #3399cc">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #3399cc">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #00cdcd">IOPRIO_CLASS_SHIFT</span> <span style="color: #3399cc">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #00cdcd">EX_EXEC_FAILED</span> <span style="color: #3399cc">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #00cdcd">EX_EXEC_ENOENT</span> <span style="color: #3399cc">=</span> 127<span class="p">;</span> // Could not find program to <span style="color: #cd00cd">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #3399cc">[]</span> <span style="color: #3399cc">=</span> <span style="color: #3399cc">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #3399cc">[</span>IOPRIO_CLASS_NONE<span style="color: #3399cc">]</span> <span style="color: #3399cc">=</span> <span style="color: #cd0000">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #3399cc">[</span>IOPRIO_CLASS_RT<span style="color: #3399cc">]</span> <span style="color: #3399cc">=</span> <span style="color: #cd0000">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #3399cc">[</span>IOPRIO_CLASS_BE<span style="color: #3399cc">]</span> <span style="color: #3399cc">=</span> <span style="color: #cd0000">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #3399cc">[</span>IOPRIO_CLASS_IDLE<span style="color: #3399cc">]</span> <span style="color: #3399cc">=</span> <span style="color: #cd0000">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #3399cc">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #3399cc">(</span>FILE* stream<span style="color: #3399cc">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #3399cc">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #00cdcd">errno</span> <span style="color: #3399cc">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #cdcd00">if</span> <span style="color: #3399cc">(</span>ferror<span style="color: #3399cc">(</span>stream<span style="color: #3399cc">)</span> !<span style="color: #3399cc">=</span> <span style="color: #cd00cd">0</span> <span style="color: #3399cc">||</span> fflush<span style="color: #3399cc">(</span>stream<span style="color: #3399cc">)</span> !<span style="color: #3399cc">=</span> 0<span style="color: #3399cc">)</span> <span style="color: #3399cc">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #cdcd00">return</span> <span style="color: #3399cc">(</span><span style="color: #00cdcd">errno</span> <span style="color: #3399cc">==</span> EBADF<span style="color: #3399cc">)</span> ? <span style="color: #cd00cd">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #3399cc">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #cdcd00">until</span> close. Calling fsync would <span style="color: #cd00cd">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #cd0000">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    if (str == NULL || *str == &#39;</span><span style="color: #cd0000">\0</span><span style="color: #cd0000">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #cd0000">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #cd0000">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #cd0000">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #cd0000">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #cd0000">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #cd0000">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #cd0000">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #cd0000">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #cd0000">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #cd0000">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #cd0000">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #cd0000">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #cd0000">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        case &#39;</span>n<span style="color: #cd0000">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        case &#39;</span>c<span style="color: #cd0000">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #cd0000">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        case &#39;</span>p<span style="color: #cd0000">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        case &#39;</span>P<span style="color: #cd0000">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        case &#39;</span>u<span style="color: #cd0000">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        case &#39;</span>t<span style="color: #cd0000">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        case &#39;</span>V<span style="color: #cd0000">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        case &#39;</span>h<span style="color: #cd0000">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #cd0000">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="">&#39;</span> <span style="color: #cdcd00">for</span> more information.<span style="color: #cd0000">\n</span><span style="color: #cd0000">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #cd0000">}</span></span></span></code></pre></code><a name='vs'><h2><a id='stylelink' href='vs.html' alt='View only vs'>vs</a></h2></a><code><pre style="background-color: #ffffff;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008000">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008000">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008000">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008000">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008000">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008000">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008000">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008000">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008000">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008000">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #008000">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span class="nv">version_string</span> <span class="o">=</span> <span style="color: #a31515">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="nv">IOPRIO_WHO_PROCESS</span> <span class="o">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">IOPRIO_CLASS_SHIFT</span> <span class="o">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">EX_EXEC_FAILED</span> <span class="o">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">EX_EXEC_ENOENT</span> <span class="o">=</span> 127<span class="p">;</span> // Could not find program to <span class="nb">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span class="o">[]</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_NONE<span class="o">]</span> <span class="o">=</span> <span style="color: #a31515">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_RT<span class="o">]</span> <span class="o">=</span> <span style="color: #a31515">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_BE<span class="o">]</span> <span class="o">=</span> <span style="color: #a31515">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_IDLE<span class="o">]</span> <span class="o">=</span> <span style="color: #a31515">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span class="o">(</span>FILE* stream<span class="o">)</span>
</span></span><span style="display: flex;"><span class="cl"><span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="nv">errno</span> <span class="o">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #0000ff">if</span> <span class="o">(</span>ferror<span class="o">(</span>stream<span class="o">)</span> !<span class="o">=</span> <span class="m">0</span> <span class="o">||</span> fflush<span class="o">(</span>stream<span class="o">)</span> !<span class="o">=</span> 0<span class="o">)</span> <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #0000ff">return</span> <span class="o">(</span><span class="nv">errno</span> <span class="o">==</span> EBADF<span class="o">)</span> ? <span class="m">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="o">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #0000ff">until</span> close. Calling fsync would <span class="nb">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #a31515">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    if (str == NULL || *str == &#39;</span><span style="color: #a31515">\0</span><span style="color: #a31515">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #a31515">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #a31515">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #a31515">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #a31515">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #a31515">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #a31515">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #a31515">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #a31515">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #a31515">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #a31515">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #a31515">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #a31515">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #a31515">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        case &#39;</span>n<span style="color: #a31515">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        case &#39;</span>c<span style="color: #a31515">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #a31515">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        case &#39;</span>p<span style="color: #a31515">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        case &#39;</span>P<span style="color: #a31515">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        case &#39;</span>u<span style="color: #a31515">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        case &#39;</span>t<span style="color: #a31515">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        case &#39;</span>V<span style="color: #a31515">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        case &#39;</span>h<span style="color: #a31515">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #a31515">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="">&#39;</span> <span style="color: #0000ff">for</span> more information.<span style="color: #a31515">\n</span><span style="color: #a31515">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #a31515">}</span></span></span></code></pre></code><a name='vulcan'><h2><a id='stylelink' href='vulcan.html' alt='View only vulcan'>vulcan</a></h2></a><code><pre style="color: #c9c9c9color: #282c34;" class="chroma"><code><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9">
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #3e4460">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #3e4460">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #3e4460">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #3e4460">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #3e4460">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #3e4460">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #3e4460">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #3e4460">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #3e4460">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #3e4460">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #3e4460">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9">
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9">static const char* <span style="color: #bc74c4; font-style: italic">version_string</span> <span style="color: #bc74c4">=</span> <span style="color: #82cc6a">&#34;tinyionice 1.0.4&#34;</span><span style="color: #56b6c2">;</span>
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9">
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9">enum <span style="color: #bc74c4">{</span>
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #bc74c4">}</span><span style="color: #56b6c2">;</span>
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9">enum <span style="color: #bc74c4">{</span>
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9">    <span style="color: #bc74c4; font-style: italic">IOPRIO_WHO_PROCESS</span> <span style="color: #bc74c4">=</span> 1,
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #bc74c4">}</span><span style="color: #56b6c2">;</span>
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9">
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9">static int <span style="color: #bc74c4; font-style: italic">IOPRIO_CLASS_SHIFT</span> <span style="color: #bc74c4">=</span> 13<span style="color: #56b6c2">;</span>
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9">static int <span style="color: #bc74c4; font-style: italic">EX_EXEC_FAILED</span> <span style="color: #bc74c4">=</span> 126<span style="color: #56b6c2">;</span> // Program located, but not usable
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9">static int <span style="color: #bc74c4; font-style: italic">EX_EXEC_ENOENT</span> <span style="color: #bc74c4">=</span> 127<span style="color: #56b6c2">;</span> // Could not find program to <span style="color: #7fbaf5">exec</span>
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9">static const char* to_prio<span style="color: #bc74c4">[]</span> <span style="color: #bc74c4">=</span> <span style="color: #bc74c4">{</span>
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9">    <span style="color: #bc74c4">[</span>IOPRIO_CLASS_NONE<span style="color: #bc74c4">]</span> <span style="color: #bc74c4">=</span> <span style="color: #82cc6a">&#34;none&#34;</span>,
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9">    <span style="color: #bc74c4">[</span>IOPRIO_CLASS_RT<span style="color: #bc74c4">]</span> <span style="color: #bc74c4">=</span> <span style="color: #82cc6a">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9">    <span style="color: #bc74c4">[</span>IOPRIO_CLASS_BE<span style="color: #bc74c4">]</span> <span style="color: #bc74c4">=</span> <span style="color: #82cc6a">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9">    <span style="color: #bc74c4">[</span>IOPRIO_CLASS_IDLE<span style="color: #bc74c4">]</span> <span style="color: #bc74c4">=</span> <span style="color: #82cc6a">&#34;idle&#34;</span>
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #bc74c4">}</span><span style="color: #56b6c2">;</span>
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9">
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9">static inline int flush_standard_stream<span style="color: #bc74c4">(</span>FILE* stream<span style="color: #bc74c4">)</span>
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #bc74c4">{</span>
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9">    <span style="color: #bc74c4; font-style: italic">errno</span> <span style="color: #bc74c4">=</span> 0<span style="color: #56b6c2">;</span>
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9">    <span style="color: #7fbaf5">if</span> <span style="color: #bc74c4">(</span>ferror<span style="color: #bc74c4">(</span>stream<span style="color: #bc74c4">)</span> !<span style="color: #bc74c4">=</span> <span style="color: #56b6c2">0</span> <span style="color: #bc74c4">||</span> fflush<span style="color: #bc74c4">(</span>stream<span style="color: #bc74c4">)</span> !<span style="color: #bc74c4">=</span> 0<span style="color: #bc74c4">)</span> <span style="color: #bc74c4">{</span>
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9">        <span style="color: #7fbaf5">return</span> <span style="color: #bc74c4">(</span><span style="color: #bc74c4; font-style: italic">errno</span> <span style="color: #bc74c4">==</span> EBADF<span style="color: #bc74c4">)</span> ? <span style="color: #56b6c2">0</span> : EOF<span style="color: #56b6c2">;</span>
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9">    <span style="color: #bc74c4">}</span>
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9">    /*
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9">     * which may defer the actual flush <span style="color: #7fbaf5">until</span> close. Calling fsync would <span style="color: #7fbaf5">help</span>
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9">     * work around this issue by calling close on a dup<span style="color: #82cc6a">&#39;d file descriptor from
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">     * the stream.
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">     */
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    int fd = fileno(stream);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    }
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    return 0;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">}
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">static inline void close_stdout(void)
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">{
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        if (errno) {
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        } else {
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        }
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        return;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    }
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">}
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">{
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    char* end = NULL;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    int64_t num;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    errno = 0;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    if (str == NULL || *str == &#39;</span><span style="color: #56b6c2">\0</span><span style="color: #82cc6a">&#39;) {
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #82cc6a">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        }
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #82cc6a">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    }
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #82cc6a">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        }
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #82cc6a">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    }
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    return num;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">}
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">{
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        errno = ERANGE;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #82cc6a">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    }
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    return (int32_t)num;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">}
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">{
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">}
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">{
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">}
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">{
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">}
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">{
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">}
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">{
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            return i;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        }
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    }
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    return -1;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">}
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">{
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    if (ioprio == -1) {
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    }
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    }
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    } else {
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    }
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">}
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">{
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    }
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">}
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">{
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">}
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">int main(int argc, char** argv)
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">{
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    bool tolerant = false;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #82cc6a">&#39; },
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #82cc6a">&#39; },
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #82cc6a">&#39; },
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #82cc6a">&#39; },
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #82cc6a">&#39; },
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #82cc6a">&#39; },
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #82cc6a">&#39; },
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #82cc6a">&#39; },
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    };
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    atexit(close_stdout);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        switch (c) {
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        case &#39;</span>n<span style="color: #82cc6a">&#39;:
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            set |= 1;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            break;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        case &#39;</span>c<span style="color: #82cc6a">&#39;:
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            } else {
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #82cc6a">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">                }
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            }
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            set |= 2;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            break;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        case &#39;</span>p<span style="color: #82cc6a">&#39;:
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            if (who) {
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            }
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            break;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        case &#39;</span>P<span style="color: #82cc6a">&#39;:
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            if (who) {
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            }
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            break;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        case &#39;</span>u<span style="color: #82cc6a">&#39;:
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            if (who) {
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            }
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            break;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        case &#39;</span>t<span style="color: #82cc6a">&#39;:
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            tolerant = 1;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            break;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        case &#39;</span>V<span style="color: #82cc6a">&#39;:
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        case &#39;</span>h<span style="color: #82cc6a">&#39;:
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            usage();
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        default:
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #82cc6a">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        }
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    switch (ioclass) {
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        }
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        data = 0;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        break;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        break;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        }
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        data = 7;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        break;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    default:
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        if (!tolerant) {
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        }
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        break;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    }
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        ioprio_print(which, who);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            ioprio_print(which, who);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        }
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        }
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    } else {
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #cf5967">&#39;</span> <span style="color: #7fbaf5">for</span> more information.<span style="color: #56b6c2">\n</span><span style="color: #82cc6a">&#34;);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    }
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;color: #c9c9c9"><span style="color: #c9c9c9"><span style="color: #82cc6a">}</span></span></span></code></pre></code><a name='witchhazel'><h2><a id='stylelink' href='witchhazel.html' alt='View only witchhazel'>witchhazel</a></h2></a><code><pre style="color: #f8f8f2; background-color: #433e56;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #b0bec5">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #b0bec5">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #b0bec5">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #b0bec5">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #b0bec5">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #b0bec5">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #b0bec5">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #b0bec5">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #b0bec5">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #b0bec5">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #b0bec5">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span class="nv">version_string</span> <span style="color: #ffb8d1">=</span> <span style="color: #1bc5e0">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #ffb8d1">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ffb8d1">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #ffb8d1">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="nv">IOPRIO_WHO_PROCESS</span> <span style="color: #ffb8d1">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ffb8d1">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">IOPRIO_CLASS_SHIFT</span> <span style="color: #ffb8d1">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">EX_EXEC_FAILED</span> <span style="color: #ffb8d1">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span class="nv">EX_EXEC_ENOENT</span> <span style="color: #ffb8d1">=</span> 127<span class="p">;</span> // Could not find program to <span class="nb">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #ffb8d1">[]</span> <span style="color: #ffb8d1">=</span> <span style="color: #ffb8d1">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ffb8d1">[</span>IOPRIO_CLASS_NONE<span style="color: #ffb8d1">]</span> <span style="color: #ffb8d1">=</span> <span style="color: #1bc5e0">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ffb8d1">[</span>IOPRIO_CLASS_RT<span style="color: #ffb8d1">]</span> <span style="color: #ffb8d1">=</span> <span style="color: #1bc5e0">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ffb8d1">[</span>IOPRIO_CLASS_BE<span style="color: #ffb8d1">]</span> <span style="color: #ffb8d1">=</span> <span style="color: #1bc5e0">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ffb8d1">[</span>IOPRIO_CLASS_IDLE<span style="color: #ffb8d1">]</span> <span style="color: #ffb8d1">=</span> <span style="color: #1bc5e0">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ffb8d1">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #ffb8d1">(</span>FILE* stream<span style="color: #ffb8d1">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #ffb8d1">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="nv">errno</span> <span style="color: #ffb8d1">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #c2ffdf">if</span> <span style="color: #ffb8d1">(</span>ferror<span style="color: #ffb8d1">(</span>stream<span style="color: #ffb8d1">)</span> !<span style="color: #ffb8d1">=</span> <span style="color: #c5a3ff">0</span> <span style="color: #ffb8d1">||</span> fflush<span style="color: #ffb8d1">(</span>stream<span style="color: #ffb8d1">)</span> !<span style="color: #ffb8d1">=</span> 0<span style="color: #ffb8d1">)</span> <span style="color: #ffb8d1">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #c2ffdf">return</span> <span style="color: #ffb8d1">(</span><span class="nv">errno</span> <span style="color: #ffb8d1">==</span> EBADF<span style="color: #ffb8d1">)</span> ? <span style="color: #c5a3ff">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #ffb8d1">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #c2ffdf">until</span> close. Calling fsync would <span class="nb">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #1bc5e0">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    if (str == NULL || *str == &#39;</span><span style="color: #1bc5e0">\0</span><span style="color: #1bc5e0">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #1bc5e0">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #1bc5e0">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #1bc5e0">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #1bc5e0">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #1bc5e0">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #1bc5e0">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #1bc5e0">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #1bc5e0">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #1bc5e0">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #1bc5e0">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #1bc5e0">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #1bc5e0">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #1bc5e0">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        case &#39;</span>n<span style="color: #1bc5e0">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        case &#39;</span>c<span style="color: #1bc5e0">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #1bc5e0">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        case &#39;</span>p<span style="color: #1bc5e0">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        case &#39;</span>P<span style="color: #1bc5e0">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        case &#39;</span>u<span style="color: #1bc5e0">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        case &#39;</span>t<span style="color: #1bc5e0">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        case &#39;</span>V<span style="color: #1bc5e0">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        case &#39;</span>h<span style="color: #1bc5e0">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #1bc5e0">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #960050; background-color: #1e0010">&#39;</span> <span style="color: #c2ffdf">for</span> more information.<span style="color: #1bc5e0">\n</span><span style="color: #1bc5e0">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #1bc5e0">}</span></span></span></code></pre></code><a name='xcode-dark'><h2><a id='stylelink' href='xcode-dark.html' alt='View only xcode-dark'>xcode-dark</a></h2></a><code><pre style="color: #ffffff; background-color: #1f1f24;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6c7986">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6c7986">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6c7986">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6c7986">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6c7986">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6c7986">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6c7986">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6c7986">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6c7986">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6c7986">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #6c7986">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #41a1c0">version_string</span> <span class="o">=</span> <span style="color: #fc6a5d">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #41a1c0">IOPRIO_WHO_PROCESS</span> <span class="o">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #41a1c0">IOPRIO_CLASS_SHIFT</span> <span class="o">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #41a1c0">EX_EXEC_FAILED</span> <span class="o">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #41a1c0">EX_EXEC_ENOENT</span> <span class="o">=</span> 127<span class="p">;</span> // Could not find program to <span style="color: #d0a8ff">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span class="o">[]</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_NONE<span class="o">]</span> <span class="o">=</span> <span style="color: #fc6a5d">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_RT<span class="o">]</span> <span class="o">=</span> <span style="color: #fc6a5d">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_BE<span class="o">]</span> <span class="o">=</span> <span style="color: #fc6a5d">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span class="o">[</span>IOPRIO_CLASS_IDLE<span class="o">]</span> <span class="o">=</span> <span style="color: #fc6a5d">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span class="o">(</span>FILE* stream<span class="o">)</span>
</span></span><span style="display: flex;"><span class="cl"><span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #41a1c0">errno</span> <span class="o">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #fc5fa3">if</span> <span class="o">(</span>ferror<span class="o">(</span>stream<span class="o">)</span> !<span class="o">=</span> <span style="color: #d0bf69">0</span> <span class="o">||</span> fflush<span class="o">(</span>stream<span class="o">)</span> !<span class="o">=</span> 0<span class="o">)</span> <span class="o">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #fc5fa3">return</span> <span class="o">(</span><span style="color: #41a1c0">errno</span> <span class="o">==</span> EBADF<span class="o">)</span> ? <span style="color: #d0bf69">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span class="o">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #fc5fa3">until</span> close. Calling fsync would <span style="color: #d0a8ff">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #fc6a5d">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    if (str == NULL || *str == &#39;</span><span style="color: #fc6a5d">\0</span><span style="color: #fc6a5d">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #fc6a5d">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #fc6a5d">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #fc6a5d">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #fc6a5d">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #fc6a5d">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #fc6a5d">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #fc6a5d">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #fc6a5d">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #fc6a5d">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #fc6a5d">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #fc6a5d">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #fc6a5d">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #fc6a5d">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        case &#39;</span>n<span style="color: #fc6a5d">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        case &#39;</span>c<span style="color: #fc6a5d">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #fc6a5d">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        case &#39;</span>p<span style="color: #fc6a5d">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        case &#39;</span>P<span style="color: #fc6a5d">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        case &#39;</span>u<span style="color: #fc6a5d">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        case &#39;</span>t<span style="color: #fc6a5d">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        case &#39;</span>V<span style="color: #fc6a5d">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        case &#39;</span>h<span style="color: #fc6a5d">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #fc6a5d">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #960050">&#39;</span> <span style="color: #fc5fa3">for</span> more information.<span style="color: #fc6a5d">\n</span><span style="color: #fc6a5d">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #fc6a5d">}</span></span></span></code></pre></code><a name='xcode'><h2><a id='stylelink' href='xcode.html' alt='View only xcode'>xcode</a></h2></a><code><pre style="background-color: #ffffff;" class="chroma"><code><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl"><span style="color: #177500">#include &lt;ctype.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #177500">#include &lt;err.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #177500">#include &lt;errno.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #177500">#include &lt;getopt.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #177500">#include &lt;inttypes.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #177500">#include &lt;stdbool.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #177500">#include &lt;stdio.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #177500">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #177500">#include &lt;string.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #177500">#include &lt;sys/syscall.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #177500">#include &lt;unistd.h&gt;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static const char* <span style="color: #000000">version_string</span> <span style="color: #000000">=</span> <span style="color: #c41a16">&#34;tinyionice 1.0.4&#34;</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #000000">{</span>
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_NONE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_RT,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_BE,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_CLASS_IDLE,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #000000">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">enum <span style="color: #000000">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #000000">IOPRIO_WHO_PROCESS</span> <span style="color: #000000">=</span> 1,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_PGRP,
</span></span><span style="display: flex;"><span class="cl">    IOPRIO_WHO_USER,
</span></span><span style="display: flex;"><span class="cl"><span style="color: #000000">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #000000">IOPRIO_CLASS_SHIFT</span> <span style="color: #000000">=</span> 13<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #000000">EX_EXEC_FAILED</span> <span style="color: #000000">=</span> 126<span class="p">;</span> // Program located, but not usable
</span></span><span style="display: flex;"><span class="cl">static int <span style="color: #000000">EX_EXEC_ENOENT</span> <span style="color: #000000">=</span> 127<span class="p">;</span> // Could not find program to <span style="color: #a90d91">exec</span>
</span></span><span style="display: flex;"><span class="cl">static const char* to_prio<span style="color: #000000">[]</span> <span style="color: #000000">=</span> <span style="color: #000000">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #000000">[</span>IOPRIO_CLASS_NONE<span style="color: #000000">]</span> <span style="color: #000000">=</span> <span style="color: #c41a16">&#34;none&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #000000">[</span>IOPRIO_CLASS_RT<span style="color: #000000">]</span> <span style="color: #000000">=</span> <span style="color: #c41a16">&#34;realtime&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #000000">[</span>IOPRIO_CLASS_BE<span style="color: #000000">]</span> <span style="color: #000000">=</span> <span style="color: #c41a16">&#34;best-effort&#34;</span>,
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #000000">[</span>IOPRIO_CLASS_IDLE<span style="color: #000000">]</span> <span style="color: #000000">=</span> <span style="color: #c41a16">&#34;idle&#34;</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #000000">}</span><span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">
</span></span><span style="display: flex;"><span class="cl">static inline int flush_standard_stream<span style="color: #000000">(</span>FILE* stream<span style="color: #000000">)</span>
</span></span><span style="display: flex;"><span class="cl"><span style="color: #000000">{</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #000000">errno</span> <span style="color: #000000">=</span> 0<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #a90d91">if</span> <span style="color: #000000">(</span>ferror<span style="color: #000000">(</span>stream<span style="color: #000000">)</span> !<span style="color: #000000">=</span> <span style="color: #1c01ce">0</span> <span style="color: #000000">||</span> fflush<span style="color: #000000">(</span>stream<span style="color: #000000">)</span> !<span style="color: #000000">=</span> 0<span style="color: #000000">)</span> <span style="color: #000000">{</span>
</span></span><span style="display: flex;"><span class="cl">        <span style="color: #a90d91">return</span> <span style="color: #000000">(</span><span style="color: #000000">errno</span> <span style="color: #000000">==</span> EBADF<span style="color: #000000">)</span> ? <span style="color: #1c01ce">0</span> : EOF<span class="p">;</span>
</span></span><span style="display: flex;"><span class="cl">    <span style="color: #000000">}</span>
</span></span><span style="display: flex;"><span class="cl">    /*
</span></span><span style="display: flex;"><span class="cl">     * Calling fflush is not sufficient on some filesystems like e.g. NFS,
</span></span><span style="display: flex;"><span class="cl">     * which may defer the actual flush <span style="color: #a90d91">until</span> close. Calling fsync would <span style="color: #a90d91">help</span>
</span></span><span style="display: flex;"><span class="cl">     * solve this, but would probably result in a performance hit. Thus, we
</span></span><span style="display: flex;"><span class="cl">     * work around this issue by calling close on a dup<span style="color: #c41a16">&#39;d file descriptor from
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">     * the stream.
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">     */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    int fd = fileno(stream);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    if (fd &lt; 0 || (fd = dup(fd)) &lt; 0 || close(fd) != 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        return (errno == EBADF) ? 0 : EOF;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    return 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">/* Meant to be used atexit(close_stdout); */
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">static inline void close_stdout(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    if (flush_standard_stream(stdout) != 0 &amp;&amp; !(errno == EPIPE)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        if (errno) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            warn(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            warnx(&#34;write error&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    } else if (flush_standard_stream(stderr) == 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        return;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    _exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">static inline int64_t strtos64_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    char* end = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    int64_t num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    errno = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    if (str == NULL || *str == &#39;</span><span style="color: #c41a16">\0</span><span style="color: #c41a16">&#39;) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #c41a16">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #c41a16">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    num = strtoimax(str, &amp;end, 10);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    if (errno || str == end || (end &amp;&amp; *end)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        if (errno == ERANGE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #c41a16">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        errx(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #c41a16">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    return num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">static inline int32_t strtos32_or_err(const char* str, const char* errmesg)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    int64_t num = strtos64_or_err(str, errmesg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    if (num &lt; INT32_MIN || num &gt; INT32_MAX) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        errno = ERANGE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        err(EXIT_FAILURE, &#34;%s: &#39;</span>%s<span style="color: #c41a16">&#39;&#34;, errmesg, str);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    return (int32_t)num;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">static inline unsigned long IOPRIO_PRIO_MASK()
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    return (1UL &lt;&lt; IOPRIO_CLASS_SHIFT) - 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">static inline unsigned long IOPRIO_PRIO_CLASS(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    return mask &gt;&gt; IOPRIO_CLASS_SHIFT;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">static inline unsigned long IOPRIO_PRIO_DATA(unsigned long mask)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    return mask &amp; IOPRIO_PRIO_MASK();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">static inline unsigned long IOPRIO_PRIO_VALUE(unsigned long class, unsigned long data)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    return ((class &lt;&lt; IOPRIO_CLASS_SHIFT) | data);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">static int parse_ioclass(const char* str)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    for (int i = 0; i &lt; 4; i++) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        if (!strcasecmp(str, to_prio[i])) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            return i;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    return -1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">static void ioprio_print(const int pid, const int who)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    const int ioprio = syscall(SYS_ioprio_get, who, pid);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    if (ioprio == -1) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        err(EXIT_FAILURE, &#34;ioprio_get failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    const int ioclass = IOPRIO_PRIO_CLASS(ioprio);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    const char* name = &#34;unknown&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    if (ioclass &gt;= 0 &amp;&amp; (size_t)ioclass &lt; 4) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        name = to_prio[ioclass];
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    if (ioclass != IOPRIO_CLASS_IDLE) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        printf(&#34;%s: prio %lu\n&#34;, name, IOPRIO_PRIO_DATA(ioprio));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        printf(&#34;%s\n&#34;, name);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">static void ioprio_setid(int which, int ioclass, int data, int who, bool tolerant)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    const int rc = syscall(SYS_ioprio_set, who, which, IOPRIO_PRIO_VALUE(ioclass, data));
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    if (rc == -1 &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        err(EXIT_FAILURE, &#34;ioprio_set failed&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">static void __attribute__((__noreturn__)) usage(void)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    fputs(&#34;\nUsage:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">      &#34; tinyionice [options] -p &lt;pid&gt;...\n tinyionice [options] -P &lt;pgid&gt;...\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">      &#34; tinyionice [options] -u &lt;uid&gt;...\n tinyionice [options] &lt;command&gt;\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">      &#34;Show or change the I/O-scheduling class and priority of a process.\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">      &#34;Options:\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">      &#34; -c, --class &lt;class&gt;    name or number of scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">      &#34;                          0: none, 1: realtime, 2: best-effort, 3: idle\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">      &#34; -n, --classdata &lt;num&gt;  priority (0..7) in the specified scheduling class,\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">      &#34;                          only for the realtime and best-effort classes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">      &#34; -p, --pid &lt;pid&gt;...     act on these already running processes\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">      &#34; -P, --pgid &lt;pgrp&gt;...   act on already running processes in these groups\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">      &#34; -t, --ignore           ignore failures\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">      &#34; -u, --uid &lt;uid&gt;...     act on already running processes owned by these users\n\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">      &#34; -h, --help             display this help\n&#34;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">      &#34; -V, --version          display version\n&#34;, stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">}
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">int main(int argc, char** argv)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">{
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    bool tolerant = false;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    const char* invalid_msg = NULL;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    int data = 4, set = 0, c = 0, which = 0, who = 0, ioclass = IOPRIO_CLASS_BE;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    static const struct option longopts[] = {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        { &#34;classdata&#34;, required_argument, NULL, &#39;</span>n<span style="color: #c41a16">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        { &#34;class&#34;, required_argument, NULL, &#39;</span>c<span style="color: #c41a16">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        { &#34;help&#34;, no_argument, NULL, &#39;</span>h<span style="color: #c41a16">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        { &#34;ignore&#34;, no_argument, NULL, &#39;</span>t<span style="color: #c41a16">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        { &#34;pid&#34;, required_argument, NULL, &#39;</span>p<span style="color: #c41a16">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        { &#34;pgid&#34;, required_argument, NULL, &#39;</span>P<span style="color: #c41a16">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        { &#34;uid&#34;, required_argument, NULL, &#39;</span>u<span style="color: #c41a16">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        { &#34;version&#34;, no_argument, NULL, &#39;</span>V<span style="color: #c41a16">&#39; },
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        { NULL, 0, NULL, 0 }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    };
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    atexit(close_stdout);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    while ((c = getopt_long(argc, argv, &#34;+n:c:p:P:u:tVh&#34;, longopts, NULL)) != EOF)
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        switch (c) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        case &#39;</span>n<span style="color: #c41a16">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            data = strtos32_or_err(optarg, &#34;invalid class data argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            set |= 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        case &#39;</span>c<span style="color: #c41a16">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            if (isdigit(*optarg)) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">                ioclass = strtos32_or_err(optarg, &#34;invalid class argument&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">                ioclass = parse_ioclass(optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">                if (ioclass &lt; 0) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">                    errx(EXIT_FAILURE, &#34;unknown scheduling class: &#39;</span>%s<span style="color: #c41a16">&#39;&#34;, optarg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">                }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            set |= 2;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        case &#39;</span>p<span style="color: #c41a16">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            invalid_msg = &#34;invalid PID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            who = IOPRIO_WHO_PROCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        case &#39;</span>P<span style="color: #c41a16">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            invalid_msg = &#34;invalid PGID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            who = IOPRIO_WHO_PGRP;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        case &#39;</span>u<span style="color: #c41a16">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            if (who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">                errx(EXIT_FAILURE, &#34;can handle only one of pid, pgid or uid at once&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            invalid_msg = &#34;invalid UID argument&#34;;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            which = strtos32_or_err(optarg, invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            who = IOPRIO_WHO_USER;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        case &#39;</span>t<span style="color: #c41a16">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            tolerant = 1;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        case &#39;</span>V<span style="color: #c41a16">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            printf(&#34;%s\n&#34;, version_string);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            exit(EXIT_SUCCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        case &#39;</span>h<span style="color: #c41a16">&#39;:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            usage();
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #c41a16">&#39; for more information.\n&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    switch (ioclass) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    case IOPRIO_CLASS_NONE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            warnx(&#34;ignoring given class data for none class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        data = 0;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    case IOPRIO_CLASS_RT:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    case IOPRIO_CLASS_BE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    case IOPRIO_CLASS_IDLE:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        if ((set &amp; 1) &amp;&amp; !tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            warnx(&#34;ignoring given class data for idle class&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        data = 7;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    default:
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        if (!tolerant) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            warnx(&#34;unknown prio class %d&#34;, ioclass);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        break;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    if (!set &amp;&amp; !which &amp;&amp; optind == argc) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        // tinyionice without options, print the current ioprio
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        ioprio_print(0, IOPRIO_WHO_PROCESS);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    } else if (!set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        // tinyionice -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            ioprio_print(which, who);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    } else if (set &amp;&amp; who) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        // tinyionice -c CLASS -p|-P|-u ID [ID ...]
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        for (; argv[optind]; ++optind) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            which = strtos32_or_err(argv[optind], invalid_msg);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">            ioprio_setid(which, ioclass, data, who, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    } else if (argv[optind]) {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        // tinyionce [-c CLASS] COMMAND
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        ioprio_setid(0, ioclass, data, IOPRIO_WHO_PROCESS, tolerant);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        execvp(argv[optind], &amp;argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        err(errno == ENOENT ? EX_EXEC_ENOENT : EX_EXEC_FAILED, &#34;failed to execute %s&#34;, argv[optind]);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    } else {
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        warnx(&#34;bad usage&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        fprintf(stderr, &#34;Try &#39;</span>tinyionice --help<span style="color: #000000">&#39;</span> <span style="color: #a90d91">for</span> more information.<span style="color: #c41a16">\n</span><span style="color: #c41a16">&#34;);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">        exit(EXIT_FAILURE);
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    }
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">    return EXIT_SUCCESS;
</span></span></span><span style="display: flex;"><span class="cl"><span style="color: #c41a16">}</span></span></span></code></pre></code><p><a id='bottom' href='index.html' alt='Back to overview'>Back to overview</a></p><p><a id='bottom' href='../index.html' alt='Go to the other gallery'>Gallery with shorter code samples</a></p><small>Generated 2023-02-13 by <a href="https://github.com/xyproto">xyproto</a> using <a href="https://github.com/xyproto/splash">splash</a>.</small></body></html>